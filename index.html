<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BIT FOOTBALL</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;600;700&display=swap');
:root{
  --bg:#07080e;--s1:#0d0f18;--s2:#131620;--s3:#1a1d2c;--s4:#222537;--s5:#2a2e45;
  --bd:rgba(255,255,255,.07);--bd2:rgba(255,255,255,.13);
  --txt:#dde4f0;--muted:#5a6480;
  --gr:#00e57a;--gr2:#00c065;--bl:#3d7eff;--or:#ff7a2f;--re:#ff3d5a;--pu:#9f6fff;--cy:#00d4e8;--ye:#f5c400;
}
*{box-sizing:border-box;margin:0;padding:0;}html,body{height:100%;overflow:hidden;-webkit-font-smoothing:antialiased;}
body{font-family:'Syne',sans-serif;background:var(--bg);color:var(--txt);}
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--s3);border:1px solid var(--bd2);border-radius:10px;padding:9px 20px;font-size:.8rem;font-weight:700;z-index:9999;opacity:0;transition:all .25s;pointer-events:none;white-space:nowrap;}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}#toast.ok{border-color:var(--gr);color:var(--gr);}#toast.err{border-color:var(--re);color:var(--re);}
.modal-wrap{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:800;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;}
.modal-wrap.open{opacity:1;pointer-events:all;}
.modal{background:var(--s2);border:1px solid var(--bd2);border-radius:16px;padding:24px;width:380px;max-width:95vw;max-height:90vh;overflow-y:auto;transform:translateY(8px);transition:transform .2s;}
.modal-wrap.open .modal{transform:translateY(0);}
.modal-title{font-size:.85rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;margin-bottom:18px;}
.modal-footer{display:flex;justify-content:flex-end;gap:8px;margin-top:18px;}
#authScreen{position:fixed;inset:0;z-index:9000;background:radial-gradient(ellipse at 35% 55%,#091830 0%,var(--bg) 65%);display:flex;align-items:center;justify-content:center;}
.auth-box{background:var(--s1);border:1px solid var(--bd2);border-radius:20px;padding:36px;width:400px;max-width:95vw;box-shadow:0 40px 80px rgba(0,0,0,.7);max-height:90vh;overflow-y:auto;}
.auth-logo{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:700;color:var(--gr);letter-spacing:5px;text-align:center;margin-bottom:3px;}
.auth-tagline{text-align:center;color:var(--muted);font-size:.72rem;letter-spacing:3px;margin-bottom:28px;}
.auth-tabs{display:flex;gap:3px;background:var(--s2);border-radius:9px;padding:3px;margin-bottom:18px;}
.auth-tab{flex:1;padding:8px;border:none;border-radius:7px;cursor:pointer;font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;background:transparent;color:var(--muted);transition:all .15s;}
.auth-tab.active{background:var(--s4);color:var(--txt);}
.af-field{margin-bottom:10px;}.af-label{font-size:.68rem;font-weight:800;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;display:block;}
.af-input{width:100%;background:var(--s2);border:1px solid var(--bd2);border-radius:8px;color:var(--txt);font-family:'Syne',sans-serif;font-size:.88rem;padding:9px 12px;outline:none;transition:border-color .15s;}
.af-input:focus{border-color:var(--gr);}
.af-btn{width:100%;padding:11px;border:none;border-radius:9px;cursor:pointer;font-family:'Syne',sans-serif;font-size:.9rem;font-weight:800;background:var(--gr);color:#07080e;margin-top:8px;transition:all .15s;}
.af-btn:hover{background:var(--gr2);}
.auth-err{font-size:.73rem;color:var(--re);text-align:center;min-height:18px;margin-top:4px;}
.auth-existing{margin-top:16px;border-top:1px solid var(--bd);padding-top:14px;}
.ae-title{font-size:.65rem;font-weight:800;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;}
.ae-pill{display:flex;align-items:center;gap:8px;padding:7px 9px;border-radius:8px;background:var(--s2);border:1px solid var(--bd);cursor:pointer;margin-bottom:5px;transition:all .15s;font-size:.8rem;font-weight:600;}
.ae-pill:hover{border-color:var(--gr);}
.ae-del{margin-left:auto;font-size:.65rem;color:var(--muted);padding:2px 6px;border-radius:4px;background:transparent;border:none;cursor:pointer;}
.ae-del:hover{color:var(--re);}
.profile-modal-ava{width:72px;height:72px;border-radius:16px;background:var(--s3);border:2px solid var(--bd2);display:flex;align-items:center;justify-content:center;font-size:2.2rem;cursor:pointer;margin:0 auto 14px;transition:border-color .15s;}
.profile-modal-ava:hover{border-color:var(--gr);}
.profile-section{margin-bottom:14px;}
.profile-section-title{font-size:.62rem;font-weight:800;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:7px;}
.profile-stat-row{display:flex;gap:8px;margin-top:8px;}
.profile-stat{flex:1;background:var(--s3);border-radius:8px;padding:8px 10px;text-align:center;}
.profile-stat-val{font-size:1.1rem;font-weight:800;color:var(--gr);}
.profile-stat-lbl{font-size:.6rem;color:var(--muted);margin-top:2px;}
#app{display:none;flex-direction:column;height:100%;}#app.on{display:flex;}
.topbar{display:flex;align-items:center;height:46px;background:var(--s1);border-bottom:1px solid var(--bd);flex-shrink:0;}
.topbar-logo{font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700;color:var(--gr);letter-spacing:4px;padding:0 14px;border-right:1px solid var(--bd);height:100%;display:flex;align-items:center;}
.nav-list{display:flex;height:100%;}
.nav-btn{display:flex;align-items:center;gap:5px;padding:0 11px;border:none;background:none;color:var(--muted);cursor:pointer;font-family:'Syne',sans-serif;font-size:.72rem;font-weight:700;letter-spacing:.5px;text-transform:uppercase;border-bottom:2px solid transparent;height:100%;transition:all .15s;}
.nav-btn:hover{color:var(--txt);}.nav-btn.active{color:var(--gr);border-bottom-color:var(--gr);}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:6px;padding-right:10px;}
.user-pill{display:flex;align-items:center;gap:7px;background:var(--s2);border:1px solid var(--bd);border-radius:7px;padding:4px 10px;font-size:.75rem;font-weight:700;cursor:pointer;}
.rec-row{display:flex;gap:3px;}
.rb{font-size:.65rem;font-weight:800;padding:2px 6px;border-radius:4px;}
.rb-w{background:rgba(0,229,122,.12);color:var(--gr);}.rb-d{background:rgba(90,99,128,.12);color:var(--muted);}.rb-l{background:rgba(255,61,90,.12);color:var(--re);}
.main{flex:1;overflow:hidden;position:relative;}
.screen{display:none;width:100%;height:100%;}.screen.active{display:flex;flex-direction:column;}
.two-col{display:flex;flex:1;overflow:hidden;}
.col-left{width:250px;flex-shrink:0;border-right:1px solid var(--bd);display:flex;flex-direction:column;background:var(--s1);}
.col-right{flex:1;overflow-y:auto;padding:16px;}
.col-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--bd);flex-shrink:0;}
.col-title{font-size:.65rem;font-weight:800;color:var(--muted);letter-spacing:3px;text-transform:uppercase;}
.col-body{flex:1;overflow-y:auto;padding:8px;}
::-webkit-scrollbar{width:3px;height:3px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--s4);border-radius:2px;}
.btn{font-family:'Syne',sans-serif;font-size:.76rem;font-weight:700;padding:7px 14px;border:none;border-radius:7px;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:5px;}
.btn:active{transform:scale(.97);}
.btn-gr{background:var(--gr);color:#07080e;}.btn-gr:hover{background:var(--gr2);}
.btn-s3{background:var(--s4);color:var(--txt);border:1px solid var(--bd2);}.btn-s3:hover{background:var(--s5);}
.btn-re{background:rgba(255,61,90,.12);color:var(--re);border:1px solid rgba(255,61,90,.2);}.btn-re:hover{background:rgba(255,61,90,.2);}
.btn-bl{background:var(--bl);color:#fff;}.btn-pu{background:var(--pu);color:#fff;}
.btn-sm{font-size:.68rem;padding:5px 10px;}.btn-xs{font-size:.62rem;padding:3px 7px;}
.inp{font-family:'Syne',sans-serif;font-size:.82rem;background:var(--s3);border:1px solid var(--bd2);border-radius:7px;color:var(--txt);padding:7px 10px;outline:none;transition:border-color .15s;width:100%;}
.inp:focus{border-color:var(--gr);}.inp::placeholder{color:var(--muted);}
/* ROBOTS */
.rli{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:8px;border:1px solid var(--bd);background:var(--s2);cursor:pointer;transition:all .12s;margin-bottom:5px;}
.rli:hover{border-color:var(--bd2);}.rli.sel{border-color:var(--gr);background:rgba(0,229,122,.05);}
.rli-ava{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;}
.rli-name{font-size:.82rem;font-weight:700;}.rli-sub{font-size:.65rem;color:var(--muted);margin-top:1px;}
.rli-ct{font-size:.62rem;font-weight:800;color:var(--cy);background:rgba(0,212,232,.1);padding:2px 6px;border-radius:4px;}
.re-sec{background:var(--s2);border:1px solid var(--bd);border-radius:12px;padding:14px;margin-bottom:12px;}
.re-stitle{font-size:.65rem;font-weight:800;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:10px;}
.stat3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;}
.stat-c{background:var(--s3);border:1px solid var(--bd);border-radius:8px;padding:8px;text-align:center;}
.stat-c .lbl{font-size:.58rem;font-weight:800;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
.stat-c .val{font-family:'JetBrains Mono',monospace;font-size:1.05rem;font-weight:700;margin:3px 0;}
.stat-c .bar{height:3px;background:var(--s4);border-radius:2px;overflow:hidden;}.stat-c .bfill{height:100%;border-radius:2px;}
.stat-c .adj{display:flex;gap:3px;justify-content:center;margin-top:4px;}
.cpal{display:flex;flex-wrap:wrap;gap:5px;}
.csw{width:20px;height:20px;border-radius:5px;cursor:pointer;border:2px solid transparent;transition:transform .1s;}.csw:hover{transform:scale(1.2);}.csw.on{border-color:rgba(255,255,255,.8);}
.emo-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.emo-opt{font-size:1.2rem;text-align:center;cursor:pointer;padding:4px;border-radius:6px;}.emo-opt:hover{background:var(--s4);}
.empty-hint{text-align:center;padding:40px 16px;color:var(--muted);}
.empty-hint .big{font-size:2.5rem;margin-bottom:8px;}.empty-hint .txt{font-size:.83rem;font-weight:600;margin-bottom:14px;}
/* SCRATCH */
.scratch-wrap{display:flex;flex:1;overflow:hidden;}
.palette{width:230px;flex-shrink:0;background:var(--s1);border-right:1px solid var(--bd);display:flex;flex-direction:column;}
.pal-cats{display:flex;flex-wrap:wrap;gap:3px;padding:8px;border-bottom:1px solid var(--bd);flex-shrink:0;}
.pc-btn{font-size:.6rem;font-weight:800;padding:3px 8px;border-radius:5px;border:none;cursor:pointer;letter-spacing:.5px;text-transform:uppercase;opacity:.5;transition:all .12s;}.pc-btn.on{opacity:1;}
.pal-search{padding:6px 8px;border-bottom:1px solid var(--bd);flex-shrink:0;}
.pal-list{flex:1;overflow-y:auto;padding:6px;}
.blk{display:flex;align-items:center;gap:7px;padding:7px 10px;border-radius:8px;margin-bottom:3px;cursor:grab;border:none;width:100%;text-align:left;transition:filter .12s,transform .1s;border-left:3px solid transparent;user-select:none;}
.blk:active{cursor:grabbing;transform:scale(.96);}.blk:hover{filter:brightness(1.18);}
.blk-icon{font-size:.95rem;flex-shrink:0;}.blk-name{font-size:.72rem;font-weight:700;color:rgba(255,255,255,.95);}.blk-sub{font-size:.6rem;color:rgba(255,255,255,.45);margin-top:1px;}
.prog-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.prog-tabs-row{display:flex;align-items:center;gap:6px;padding:8px 12px;border-bottom:1px solid var(--bd);background:var(--s1);flex-shrink:0;overflow-x:auto;}
.prog-tabs-row::-webkit-scrollbar{height:0;}
.rtab{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:7px;background:var(--s2);border:1px solid var(--bd);cursor:pointer;font-size:.72rem;font-weight:700;transition:all .12s;white-space:nowrap;flex-shrink:0;}
.rtab.on{border-color:var(--gr);background:rgba(0,229,122,.08);color:var(--gr);}
.prog-canvas{flex:1;overflow-y:auto;padding:14px;background:var(--bg);}
.prog-seq{display:flex;flex-direction:column;gap:2px;}
.start-blk{display:flex;align-items:center;gap:8px;padding:9px 14px;border-radius:9px 9px 0 0;background:#153a20;border:1.5px solid #2a7040;font-size:.78rem;font-weight:800;color:#00ff88;letter-spacing:.5px;}
.end-blk{padding:7px 14px;border-radius:0 0 9px 9px;background:#0d1f12;border:1.5px solid #1a4028;border-top:none;font-size:.68rem;font-weight:800;color:rgba(0,255,136,.3);letter-spacing:.5px;}
.prog-blk{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:4px;font-size:.76rem;font-weight:700;color:rgba(255,255,255,.92);border-left:3px solid transparent;}
.pb-num{font-family:'JetBrains Mono',monospace;font-size:.6rem;color:rgba(255,255,255,.25);width:16px;flex-shrink:0;}
.pb-icon{font-size:.9rem;flex-shrink:0;}.pb-label{flex:1;}
.pb-cat{font-size:.58rem;font-weight:800;padding:2px 6px;border-radius:4px;text-transform:uppercase;margin-left:auto;}
.pb-del{background:none;border:none;color:rgba(255,255,255,.2);cursor:pointer;font-size:.75rem;padding:2px 5px;border-radius:4px;margin-left:4px;flex-shrink:0;transition:all .1s;}
.pb-del:hover{color:var(--re);background:rgba(255,61,90,.15);}
.if-wrap{border-radius:6px;overflow:hidden;margin:2px 0;}
.if-head{display:flex;align-items:center;gap:8px;padding:8px 12px;font-size:.76rem;font-weight:700;background:#2a1650;border-left:3px solid var(--pu);}
.if-cond-sel{background:rgba(159,111,255,.2);border:1px solid rgba(159,111,255,.3);border-radius:5px;color:var(--pu);font-family:'Syne',sans-serif;font-size:.7rem;font-weight:700;padding:3px 7px;cursor:pointer;outline:none;flex:1;max-width:230px;}
.if-body{padding:3px 3px 3px 18px;background:#180d36;border-left:3px solid rgba(159,111,255,.25);}
.else-head{display:flex;align-items:center;gap:6px;padding:5px 12px;font-size:.7rem;font-weight:800;color:var(--or);background:#201000;border-left:3px solid var(--or);}
.else-body{padding:3px 3px 3px 18px;background:#110900;border-left:3px solid rgba(255,122,47,.25);}
.if-end{padding:4px 12px;font-size:.65rem;font-weight:800;color:rgba(255,255,255,.2);background:var(--s2);letter-spacing:1px;}
.dz{min-height:36px;border:2px dashed var(--s5);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:.68rem;color:var(--muted);transition:all .15s;margin:3px 0;}
.dz.over{border-color:var(--gr);background:rgba(0,229,122,.05);color:var(--gr);}
.prog-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;}
.add-if-btn{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;border:1.5px dashed rgba(159,111,255,.35);background:transparent;color:var(--pu);font-family:'Syne',sans-serif;font-size:.72rem;font-weight:700;cursor:pointer;transition:all .12s;justify-content:center;}
.add-if-btn:hover{border-color:var(--pu);background:rgba(159,111,255,.08);}
.add-shoot-btn{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;border:1.5px dashed rgba(245,196,0,.40);background:transparent;color:var(--ye);font-family:'Syne',sans-serif;font-size:.72rem;font-weight:700;cursor:pointer;transition:all .12s;justify-content:center;}
.add-shoot-btn:hover{border-color:var(--ye);background:rgba(245,196,0,.08);}
.shoot-blk{display:flex;align-items:center;gap:8px;padding:9px 14px;border-radius:7px;background:#2a1800;border-left:3px solid var(--ye);font-size:.78rem;font-weight:800;color:var(--ye);margin:2px 0;}
.goalrun-blk{display:flex;align-items:center;gap:8px;padding:9px 14px;border-radius:7px;background:#0a2218;border-left:3px solid var(--gr);font-size:.78rem;font-weight:800;color:var(--gr);margin:2px 0;}
.add-goalrun-btn{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;border:1.5px dashed rgba(0,229,122,.40);background:transparent;color:var(--gr);font-family:'Syne',sans-serif;font-size:.72rem;font-weight:700;cursor:pointer;transition:all .12s;justify-content:center;}
.add-goalrun-btn:hover{border-color:var(--gr);background:rgba(0,229,122,.08);}
/* FIELD */
.field-wrap{display:flex;flex:1;overflow:hidden;}
.field-side{width:180px;flex-shrink:0;background:var(--s1);border-right:1px solid var(--bd);display:flex;flex-direction:column;padding:10px;}
.field-side-title{font-size:.65rem;font-weight:800;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;}
.frd{display:flex;align-items:center;gap:7px;padding:7px 9px;border-radius:8px;border:1px solid var(--bd);background:var(--s2);margin-bottom:5px;cursor:grab;font-size:.78rem;font-weight:600;}
.frd:hover{border-color:var(--bd2);}.frd.placed{border-color:var(--gr);opacity:.7;}
.field-canvas-area{flex:1;display:flex;align-items:center;justify-content:center;background:var(--bg);padding:12px;}
.fmt-btns{display:flex;flex-wrap:wrap;gap:4px;margin-top:auto;padding-top:8px;border-top:1px solid var(--bd);}
/* MATCH */
.match-shell{display:flex;flex:1;overflow:hidden;}
.match-main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.match-hud{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:var(--s1);border-bottom:1px solid var(--bd);flex-shrink:0;}
.hud-team{display:flex;flex-direction:column;align-items:center;gap:2px;min-width:90px;}
.hud-name{font-size:.75rem;font-weight:800;letter-spacing:1px;}
.hud-poss{font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;min-height:14px;}
.hud-score-c{display:flex;align-items:center;flex-direction:column;gap:2px;}
.hud-score-row{display:flex;align-items:center;gap:14px;}
.hud-score{font-family:'JetBrains Mono',monospace;font-size:2rem;font-weight:700;}
.hud-time{font-size:.68rem;font-weight:800;color:var(--muted);letter-spacing:2px;}
.hud-period-badge{font-size:.6rem;font-weight:800;padding:2px 7px;border-radius:4px;background:rgba(245,196,0,.15);color:var(--ye);letter-spacing:1px;}
.match-canvas-wrap{flex:1;display:flex;align-items:stretch;justify-content:center;background:#0a0f08;position:relative;overflow:hidden;}
#matchCanvas{width:100%;height:100%;display:block;}
.match-sidebar{width:155px;flex-shrink:0;background:var(--s1);border-left:1px solid var(--bd);display:flex;flex-direction:column;}
.ms-head{padding:10px 12px;border-bottom:1px solid var(--bd);flex-shrink:0;}
.ms-title{font-size:.62rem;font-weight:800;color:var(--muted);letter-spacing:2px;text-transform:uppercase;}
.ms-log{flex:1;overflow-y:auto;padding:6px;}
.le{font-size:.72rem;padding:5px 8px;border-radius:6px;margin-bottom:3px;line-height:1.4;border-left:2px solid transparent;}
.le-goal{background:rgba(245,196,0,.08);color:var(--ye);border-color:var(--ye);font-weight:700;}
.le-action{color:var(--txt);border-color:var(--s4);}.le-chip{color:var(--cy);border-color:rgba(0,212,232,.3);}
.le-info{color:var(--muted);}.le-if{color:var(--pu);border-color:rgba(159,111,255,.3);}
.ms-ctrl{padding:8px;border-top:1px solid var(--bd);display:flex;flex-direction:column;gap:5px;}
.match-overlay{position:absolute;inset:0;background:rgba(7,8,14,.92);z-index:10;display:flex;align-items:center;justify-content:center;overflow-y:auto;}
.mo-box{background:var(--s2);border:1px solid var(--bd2);border-radius:16px;padding:24px;width:400px;max-width:95vw;my:auto;}
.mo-title{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;color:var(--gr);letter-spacing:3px;margin-bottom:16px;text-align:center;}
.vs-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;}
.vs-card{padding:12px;border:1px solid var(--bd);border-radius:10px;cursor:pointer;text-align:center;transition:all .15s;background:var(--s3);}
.vs-card:hover,.vs-card.on{border-color:var(--gr);background:rgba(0,229,122,.06);}
.vs-ico{font-size:1.6rem;margin-bottom:4px;}.vs-lbl{font-size:.78rem;font-weight:700;}
.dur-row{display:flex;gap:5px;margin-bottom:12px;}
.dur-btn{flex:1;padding:6px;border:1px solid var(--bd);border-radius:7px;background:var(--s3);color:var(--muted);font-family:'Syne',sans-serif;font-size:.72rem;font-weight:700;cursor:pointer;transition:all .12s;}
.dur-btn.on{border-color:var(--gr);color:var(--gr);background:rgba(0,229,122,.08);}
.mo-err{font-size:.73rem;color:var(--re);margin-top:6px;}
.mo-sect{font-size:.65rem;font-weight:800;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;}
/* Stadium picker */
.stad-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:12px;}
.stad-card{padding:8px;border:1px solid var(--bd);border-radius:8px;cursor:pointer;text-align:center;transition:all .15s;background:var(--s3);}
.stad-card:hover,.stad-card.on{border-color:var(--cy);background:rgba(0,212,232,.06);}
.stad-ico{font-size:1.3rem;margin-bottom:3px;}
.stad-lbl{font-size:.62rem;font-weight:700;color:var(--txt);}
.stad-sub{font-size:.55rem;color:var(--muted);}
/* Weather picker */
.wx-row{display:flex;gap:6px;margin-bottom:12px;}
.wx-btn{flex:1;padding:6px;border:1px solid var(--bd);border-radius:7px;background:var(--s3);font-family:'Syne',sans-serif;font-size:.7rem;font-weight:700;cursor:pointer;transition:all .12s;text-align:center;}
.wx-btn.on{border-color:var(--bl);color:var(--cy);background:rgba(61,127,255,.1);}
.diff-row{display:flex;gap:5px;margin-bottom:12px;}
.diff-btn{flex:1;padding:7px 4px;border:1px solid var(--bd);border-radius:7px;background:var(--s3);font-family:'Syne',sans-serif;font-size:.7rem;font-weight:800;cursor:pointer;transition:all .12s;text-align:center;letter-spacing:.5px;}
.diff-btn:hover{border-color:var(--bd2);}
.diff-btn.on-easy{border-color:#00e57a;color:#00e57a;background:rgba(0,229,122,.08);}
.diff-btn.on-medium{border-color:#f5c400;color:#f5c400;background:rgba(245,196,0,.08);}
.diff-btn.on-hard{border-color:#ff3d5a;color:#ff3d5a;background:rgba(255,61,90,.08);}
/* ONLINE */
.online-wrap{flex:1;overflow-y:auto;padding:20px;}
.online-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;max-width:900px;margin:0 auto;}
@media(max-width:700px){.online-grid{grid-template-columns:1fr;}}
.o-card{background:var(--s2);border:1px solid var(--bd);border-radius:12px;padding:18px;}
.o-card-title{font-size:.65rem;font-weight:800;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:12px;}
.code-big{font-family:'JetBrains Mono',monospace;font-size:2rem;font-weight:700;letter-spacing:8px;color:var(--gr);text-align:center;padding:10px 0;}
.rec-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;}
.rec-box{background:var(--s3);border:1px solid var(--bd);border-radius:8px;padding:10px;text-align:center;}
.rec-num{font-family:'JetBrains Mono',monospace;font-size:1.3rem;font-weight:700;}
.rec-lbl{font-size:.62rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-top:2px;}
.divider{height:1px;background:var(--bd);margin:12px 0;}
/* RANKED */
.rank-tier{display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;border:1px solid var(--bd);background:var(--s3);margin-bottom:6px;}
.rank-ico{font-size:1.4rem;}
.rank-name{font-size:.82rem;font-weight:800;}
.rank-pts{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--muted);}
.rank-bar-wrap{height:4px;background:var(--s4);border-radius:2px;overflow:hidden;margin-top:3px;}
.rank-bar-fill{height:100%;border-radius:2px;}
/* LEAGUES */
.league-card{background:var(--s2);border:1px solid var(--bd);border-radius:10px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all .15s;}
.league-card:hover{border-color:var(--bd2);}
.league-table{width:100%;border-collapse:collapse;font-size:.72rem;}
.league-table th{font-size:.6rem;font-weight:800;color:var(--muted);letter-spacing:1px;text-transform:uppercase;padding:5px 8px;text-align:left;border-bottom:1px solid var(--bd);}
.league-table td{padding:6px 8px;border-bottom:1px solid var(--bd);}
.league-table tr:last-child td{border:none;}
.lt-pos{font-family:'JetBrains Mono',monospace;color:var(--muted);font-size:.65rem;}
.lt-pts{font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--ye);}
/* CLANS */
.clan-card{background:var(--s2);border:1px solid var(--bd);border-radius:10px;padding:14px;margin-bottom:8px;}
.clan-tag{font-family:'JetBrains Mono',monospace;font-size:.65rem;font-weight:700;padding:2px 8px;border-radius:4px;margin-right:6px;}
/* End match overlay */
.end-overlay{position:absolute;inset:0;background:rgba(7,8,14,.88);z-index:20;display:flex;align-items:center;justify-content:center;}
.end-box{background:var(--s2);border:1px solid var(--bd2);border-radius:16px;padding:32px;text-align:center;width:320px;}
.end-title{font-family:'JetBrains Mono',monospace;font-size:1.1rem;font-weight:700;letter-spacing:3px;margin-bottom:8px;}
.end-score{font-family:'JetBrains Mono',monospace;font-size:2.5rem;font-weight:700;margin-bottom:12px;}
.end-rank{font-size:.72rem;color:var(--muted);margin-bottom:18px;}
/* Rain overlay */
#rainCanvas{position:absolute;inset:0;pointer-events:none;z-index:5;}
@keyframes livepulse{0%,100%{opacity:1;}50%{opacity:.3;}}
.live-dot{display:inline-block;animation:livepulse 1s ease-in-out infinite;}
@keyframes rankup{0%{transform:scale(1);}50%{transform:scale(1.3);}100%{transform:scale(1);}}
.rankup-anim{animation:rankup .4s ease;}
</style>
</head>
<body>
<div id="authScreen">
  <div class="auth-box">
    <div class="auth-logo">BIT FOOTBALL</div>
    <div class="auth-tagline">PROGRAM ¬∑ BUILD ¬∑ DOMINATE</div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
    </div>
    <div id="authForm"></div>
    <div class="auth-err" id="authErr"></div>
    <div class="auth-existing" id="authExisting"></div>
  </div>
</div>
<div id="app">
  <div class="topbar">
    <div class="topbar-logo">BIT/FB</div>
    <nav class="nav-list">
      <button class="nav-btn active" onclick="goScreen('robots',this)">ü§ñ Robots</button>
      <button class="nav-btn" onclick="goScreen('scratch',this)">üß© Program</button>
      <button class="nav-btn" onclick="goScreen('field',this)">üèü Formation</button>
      <button class="nav-btn" onclick="goScreen('match',this)">‚öΩ Match</button>
      <button class="nav-btn" onclick="goScreen('ranked',this)">üèÜ Ranked</button>
      <button class="nav-btn" onclick="goScreen('leagues',this)">ü•á Leagues</button>
      <button class="nav-btn" onclick="goScreen('clans',this)">üõ° Clans</button>
      <button class="nav-btn" onclick="goScreen('online',this)">üåê Online</button>
    </nav>
    <div class="topbar-right">
      <div class="rec-row"><span class="rb rb-w" id="recW">W 0</span><span class="rb rb-d" id="recD">D 0</span><span class="rb rb-l" id="recL">L 0</span></div>
      <div id="rankBadge" style="font-size:.7rem;font-weight:800;padding:3px 8px;border-radius:5px;background:rgba(245,196,0,.15);color:var(--ye);">ü•â BRONZE</div>
      <div class="user-pill" onclick="openProfileModal()"><span id="userAva">ü§ñ</span><span id="userName">‚Äî</span><span style="color:var(--muted);font-size:.65rem">‚öô</span></div>
    </div>
  </div>
  <div class="main">
    <!-- ROBOTS -->
    <div id="screen-robots" class="screen active">
      <div class="two-col">
        <div class="col-left">
          <div class="col-header"><span class="col-title">Robots</span><button class="btn btn-gr btn-sm" onclick="openNewRobotModal()">+ New</button></div>
          <div class="col-body" id="robotsList"></div>
        </div>
        <div class="col-right" id="robotEditor">
          <div class="empty-hint"><div class="big">ü§ñ</div><div class="txt">Select or create a robot</div><button class="btn btn-gr" onclick="openNewRobotModal()">+ Create Robot</button></div>
        </div>
      </div>
    </div>
    <!-- SCRATCH -->
    <div id="screen-scratch" class="screen">
      <div class="scratch-wrap">
        <div class="palette">
          <div class="pal-cats" id="palCats"></div>
          <div class="pal-search"><input class="inp" id="palSearch" placeholder="Search chips‚Ä¶" oninput="renderPalette()" style="font-size:.72rem;padding:5px 8px;"></div>
          <div class="pal-list" id="palList"></div>
        </div>
        <div class="prog-wrap">
          <div class="prog-tabs-row" id="progTabs"><span style="font-size:.68rem;color:var(--muted);font-weight:700;">PICK A ROBOT ‚Üí</span></div>
          <div class="prog-canvas" id="progCanvas"><div class="empty-hint"><div class="big">üß©</div><div class="txt">Pick a robot tab, drag chips in</div></div></div>
        </div>
      </div>
    </div>
    <!-- FIELD -->
    <div id="screen-field" class="screen">
      <div class="field-wrap">
        <div class="field-side">
          <div class="field-side-title">Drag onto field</div>
          <div id="fieldSideRobots"></div>
          <div class="fmt-btns">
            <div style="font-size:.62rem;color:var(--muted);font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;width:100%;">Formation</div>
            <button class="btn btn-s3 btn-xs" onclick="applyFormation('442')">4-4-2</button>
            <button class="btn btn-s3 btn-xs" onclick="applyFormation('433')">4-3-3</button>
            <button class="btn btn-s3 btn-xs" onclick="applyFormation('352')">3-5-2</button>
            <button class="btn btn-s3 btn-xs" onclick="applyFormation('532')">5-3-2</button>
          </div>
        </div>
        <div class="field-canvas-area" id="fieldCanvasArea"><canvas id="fieldCanvas"></canvas></div>
      </div>
    </div>
    <!-- MATCH -->
    <div id="screen-match" class="screen">
      <div class="match-shell">
        <div class="match-main">
          <div class="match-hud">
            <div class="hud-team"><div class="hud-name" id="hudH" style="color:var(--gr)">‚Äî</div><div class="hud-poss" id="hudPH"></div></div>
            <div class="hud-score-c">
              <div class="hud-score-row"><div class="hud-score" id="hudSH">0</div><div style="font-family:'JetBrains Mono',monospace;font-size:1.2rem;color:var(--muted)">:</div><div class="hud-score" id="hudSA">0</div></div>
              <div class="hud-time" id="hudTime">‚Äî</div>
              <div class="hud-period-badge" id="hudPeriodBadge">P1</div>
            </div>
            <div class="hud-team" style="align-items:flex-end"><div class="hud-name" id="hudA" style="color:var(--re)">‚Äî</div><div class="hud-poss" id="hudPA"></div></div>
          </div>
          <div class="match-canvas-wrap" id="matchCanvasWrap">
            <canvas id="matchCanvas"></canvas>
            <canvas id="rainCanvas" style="display:none;"></canvas>
            <div class="match-overlay" id="matchOverlay">
              <div class="mo-box">
                <div class="mo-title">‚öΩ KICK OFF</div>
                <div class="vs-grid">
                  <div class="vs-card on" id="vsAI" onclick="pickVs('ai')"><div class="vs-ico">ü§ñ</div><div class="vs-lbl">vs AI</div></div>
                  <div class="vs-card" id="vsFriend" onclick="pickVs('friend')"><div class="vs-ico">üë•</div><div class="vs-lbl">vs Friend</div></div>
                </div>
                <div id="friendCodeRow" style="display:none;margin-bottom:10px;"><input class="inp" id="friendCodeInp" placeholder="Friend's 4-char code‚Ä¶" maxlength="4" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')"></div>
                <div id="diffRow" style="margin-bottom:2px;">
                  <div class="mo-sect" style="margin-bottom:6px;">AI Difficulty</div>
                  <div class="diff-row">
                    <button class="diff-btn" id="diffEasy" onclick="pickDiff('easy',this)">üü¢ Easy</button>
                    <button class="diff-btn on-medium" id="diffMedium" onclick="pickDiff('medium',this)">üü° Medium</button>
                    <button class="diff-btn" id="diffHard" onclick="pickDiff('hard',this)">üî¥ Hard</button>
                  </div>
                </div>
                <div class="mo-sect" style="margin-bottom:6px;">Duration (4 periods √ó time)</div>
                <div class="dur-row">
                  <button class="dur-btn" onclick="pickDur(30,this)">30s</button>
                  <button class="dur-btn on" onclick="pickDur(60,this)">1min</button>
                  <button class="dur-btn" onclick="pickDur(90,this)">1.5m</button>
                </div>
                <div class="mo-sect">Stadium</div>
                <div class="stad-grid" id="stadGrid"></div>
                <div class="mo-sect">Weather</div>
                <div class="wx-row" id="wxRow"></div>
                <button class="btn btn-gr" style="width:100%;justify-content:center;padding:11px;margin-top:4px;" onclick="kickOff()">‚öΩ Kick Off!</button>
                <div class="mo-err" id="moErr"></div>
              </div>
            </div>
            <div id="endOverlay" style="display:none;" class="end-overlay">
              <div class="end-box">
                <div class="end-title" id="endTitle">FULL TIME</div>
                <div class="end-score" id="endScore">0 : 0</div>
                <div class="end-rank" id="endRankInfo"></div>
                <button class="btn btn-gr" style="width:100%;justify-content:center;" onclick="closeEndOverlay()">Play Again</button>
              </div>
            </div>
          </div>
        </div>
        <div class="match-sidebar">
          <div class="ms-head">
          <div class="ms-title">Match Log</div>
          <div id="diffBadge" style="font-size:.6rem;font-weight:800;padding:2px 7px;border-radius:4px;margin-top:4px;display:inline-block;"></div>
        </div>
          <div class="ms-log" id="matchLog"></div>
          <div class="ms-ctrl">
            <button class="btn btn-s3 btn-sm" id="speedBtn" onclick="toggleSpeed()" style="justify-content:center;">‚è© 3√ó Speed</button>
            <button class="btn btn-re btn-sm" onclick="stopMatch()" style="justify-content:center;">‚èπ Stop</button>
          </div>
        </div>
      </div>
    </div>
    <!-- RANKED -->
    <div id="screen-ranked" class="screen">
      <div style="flex:1;overflow-y:auto;padding:20px;max-width:700px;margin:0 auto;width:100%;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
          <div>
            <div style="font-size:1rem;font-weight:800;">Ranked Mode</div>
            <div style="font-size:.72rem;color:var(--muted);margin-top:2px;">Earn RP ¬∑ Climb divisions ¬∑ Prove your code</div>
          </div>
          <button class="btn btn-gr" onclick="startRankedMatch()">‚ñ∂ Find Match</button>
        </div>
        <div id="rankedTiers"></div>
        <div style="margin-top:18px;">
          <div style="font-size:.65rem;font-weight:800;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:10px;">Your Stats</div>
          <div id="rankedStats"></div>
        </div>
      </div>
    </div>
    <!-- LEAGUES -->
    <div id="screen-leagues" class="screen">
      <div style="flex:1;overflow-y:auto;padding:20px;max-width:800px;margin:0 auto;width:100%;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
          <div>
            <div style="font-size:1rem;font-weight:800;">Leagues</div>
            <div style="font-size:.72rem;color:var(--muted);margin-top:2px;">Season-based competition ¬∑ 8-team tables</div>
          </div>
          <button class="btn btn-gr" onclick="joinLeague()">Join League</button>
        </div>
        <div id="leagueContent"></div>
      </div>
    </div>
    <!-- CLANS -->
    <div id="screen-clans" class="screen">
      <div style="flex:1;overflow-y:auto;padding:20px;max-width:800px;margin:0 auto;width:100%;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
          <div>
            <div style="font-size:1rem;font-weight:800;">Clans</div>
            <div style="font-size:.72rem;color:var(--muted);margin-top:2px;">Team up ¬∑ Climb together ¬∑ Clan wars coming</div>
          </div>
          <div style="display:flex;gap:6px;">
            <button class="btn btn-s3 btn-sm" onclick="openJoinClanModal()">Join Clan</button>
            <button class="btn btn-gr btn-sm" onclick="openCreateClanModal()">+ Create</button>
          </div>
        </div>
        <div id="clanContent"></div>
      </div>
    </div>
    <!-- ONLINE -->
    <div id="screen-online" class="screen">
      <div class="online-wrap">
        <div class="online-grid">
          <div class="o-card">
            <div class="o-card-title">Your Team Code</div>
            <div class="code-big" id="myCodeDisplay">----</div>
            <div style="font-size:.73rem;color:var(--muted);text-align:center;margin-bottom:10px;">Share so friends can challenge you</div>
            <div style="display:flex;gap:6px;justify-content:center;"><button class="btn btn-gr btn-sm" onclick="genCode()">Generate</button><button class="btn btn-s3 btn-sm" onclick="copyCode()">Copy</button></div>
            <div class="divider"></div>
            <div class="o-card-title">Your Record</div>
            <div class="rec-grid">
              <div class="rec-box"><div class="rec-num" style="color:var(--gr)" id="oRecW">0</div><div class="rec-lbl">Wins</div></div>
              <div class="rec-box"><div class="rec-num" style="color:var(--muted)" id="oRecD">0</div><div class="rec-lbl">Draws</div></div>
              <div class="rec-box"><div class="rec-num" style="color:var(--re)" id="oRecL">0</div><div class="rec-lbl">Losses</div></div>
            </div>
          </div>
          <div class="o-card">
            <div class="o-card-title">Challenge a Friend</div>
            <input class="inp" id="challengeInp" placeholder="Enter friend's code‚Ä¶" maxlength="4" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')" style="margin-bottom:10px;">
            <button class="btn btn-bl" style="width:100%;justify-content:center;" onclick="loadChallenge()">‚öîÔ∏è Challenge!</button>
            <div class="divider"></div>
            <div class="o-card-title">How It Works</div>
            <div style="font-size:.76rem;color:var(--muted);line-height:1.9;">1. Build &amp; program your robots<br>2. Generate a Team Code<br>3. Share it with a friend<br>4. Enter their code to battle<br>5. Results update your record</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- MODALS -->
<div class="modal-wrap" id="robotModal">
  <div class="modal">
    <div class="modal-title">Create Robot</div>
    <div style="text-align:center;margin-bottom:14px;">
      <div id="newRobotAva" onclick="openEmojiModal()" style="font-size:2.5rem;cursor:pointer;display:inline-block;padding:10px 16px;border-radius:14px;background:var(--s3);border:2px solid var(--bd2);">ü§ñ</div>
      <div style="font-size:.62rem;color:var(--muted);margin-top:4px;">Click to change</div>
    </div>
    <div style="margin-bottom:10px;"><label class="af-label">Name</label><input class="inp" id="newRobotName" placeholder="Robot name‚Ä¶"></div>
    <div style="margin-bottom:10px;"><label class="af-label">Color</label><div class="cpal" id="newRobotColors"></div></div>
    <label class="af-label" style="margin-bottom:6px;display:block;">Stats</label>
    <div id="newRobotStats"></div>
    <div class="modal-footer"><button class="btn btn-s3" onclick="closeModal('robotModal')">Cancel</button><button class="btn btn-gr" onclick="saveNewRobot()">Create</button></div>
  </div>
</div>
<div class="modal-wrap" id="emojiModal">
  <div class="modal" style="width:300px;">
    <div class="modal-title">Pick Icon</div>
    <div class="emo-grid" id="emojiGrid"></div>
    <div class="modal-footer"><button class="btn btn-s3" onclick="closeModal('emojiModal')">Close</button></div>
  </div>
</div>
<div class="modal-wrap" id="profileModal">
  <div class="modal" style="width:340px;">
    <div class="modal-title">‚öôÔ∏è My Profile</div>
    <div id="profileModalBody"></div>
    <div class="modal-footer">
      <button class="btn btn-re btn-sm" onclick="signOut();closeModal('profileModal')">Sign Out</button>
      <button class="btn btn-s3" onclick="closeModal('profileModal')">Close</button>
    </div>
  </div>
</div>
<div class="modal-wrap" id="createClanModal">
  <div class="modal">
    <div class="modal-title">Create Clan</div>
    <div class="af-field"><label class="af-label">Clan Name</label><input class="inp" id="clanName" placeholder="e.g. Iron Wolves"></div>
    <div class="af-field"><label class="af-label">Tag (3 chars)</label><input class="inp" id="clanTag" placeholder="e.g. IW" maxlength="3" oninput="this.value=this.value.toUpperCase()"></div>
    <div class="af-field"><label class="af-label">Color</label><div class="cpal" id="clanColors"></div></div>
    <div class="af-field"><label class="af-label">Icon</label><div class="emo-grid" id="clanEmojis" style="max-height:100px;overflow-y:auto;"></div></div>
    <div class="modal-footer"><button class="btn btn-s3" onclick="closeModal('createClanModal')">Cancel</button><button class="btn btn-gr" onclick="saveClan()">Create Clan</button></div>
  </div>
</div>
<div class="modal-wrap" id="joinClanModal">
  <div class="modal">
    <div class="modal-title">Join a Clan</div>
    <div id="joinClanList"></div>
    <div class="modal-footer"><button class="btn btn-s3" onclick="closeModal('joinClanModal')">Close</button></div>
  </div>
</div>
<div id="toast"></div>
<script>
'use strict';
const COLORS=['#00e57a','#3d7eff','#ff7a2f','#ff3d5a','#9f6fff','#00d4e8','#f5c400','#ff4fa3','#00d4a8','#7bed9f','#ffa502','#ff6b6b'];
const EMOJIS=['ü§ñ','ü¶æ','üõ°Ô∏è','‚ö°','üî•','üå™Ô∏è','üíé','üß†','üèãÔ∏è','üí®','üéØ','üöÄ','üëæ','ü¶ø','‚öôÔ∏è','üî©','üí™','üåü','üéÆ','üïπÔ∏è','üèÜ','üëä','üõ∏','ü§Ø','ü¶Ö','üêâ','üåä','‚òÑÔ∏è','ü™Ñ','üé™'];
const CC={move:{l:'MOVE',c:'#00e57a',b:'rgba(0,229,122,.13)'},attack:{l:'ATTACK',c:'#ff7a2f',b:'rgba(255,122,47,.13)'},defend:{l:'DEFEND',c:'#3d7eff',b:'rgba(61,127,255,.13)'},special:{l:'SPECIAL',c:'#9f6fff',b:'rgba(159,111,255,.13)'},support:{l:'SUPPORT',c:'#00d4a8',b:'rgba(0,212,168,.13)'},trick:{l:'TRICK',c:'#ff4fa3',b:'rgba(255,79,163,.13)'}};
const CHIPS=[
  {id:'m01',cat:'move',icon:'üèÉ',name:'Sprint',desc:'Charge straight at goal',pow:3,spd:4,def:0},
  {id:'m13',cat:'move',icon:'‚öΩ',name:'Go to Ball',desc:'Rush directly to the ball and carry it',pow:2,spd:5,def:0},
  {id:'m02',cat:'move',icon:'‚ÜîÔ∏è',name:'Wide Run',desc:'Spread play to wings',pow:1,spd:3,def:0},
  {id:'m03',cat:'move',icon:'üéØ',name:'Through Ball',desc:'Split the defensive line',pow:2,spd:3,def:1},
  {id:'m04',cat:'move',icon:'‚§¥Ô∏è',name:'Lofted Pass',desc:'Launch ball over midfield',pow:1,spd:2,def:0},
  {id:'m05',cat:'move',icon:'üîÄ',name:'Overlap Run',desc:'Full-back charges forward',pow:2,spd:3,def:0},
  {id:'m06',cat:'move',icon:'ü§≤',name:'Short Pass',desc:'Keep possession safely',pow:0,spd:1,def:2},
  {id:'m07',cat:'move',icon:'ü™Ñ',name:'Dummy Run',desc:'Decoy to open space',pow:1,spd:2,def:0},
  {id:'m08',cat:'move',icon:'‚ö°',name:'Counter Attack',desc:'Rapid transition on turnover',pow:3,spd:5,def:0},
  {id:'m09',cat:'move',icon:'üåä',name:'Tidal Pass',desc:'Fluid side-to-side passing',pow:1,spd:2,def:2},
  {id:'m10',cat:'move',icon:'üîÉ',name:'Recycle Ball',desc:'Pass back to reset play',pow:0,spd:0,def:3},
  {id:'m11',cat:'move',icon:'üß≤',name:'Magnet Run',desc:'Draw defenders then release',pow:2,spd:2,def:1},
  {id:'m12',cat:'move',icon:'üéµ',name:'Slow Buildup',desc:'Patient passing from deep',pow:0,spd:0,def:3},
  {id:'a01',cat:'attack',icon:'üí•',name:'Power Shot',desc:'Max force strike on goal',pow:5,spd:1,def:0},
  {id:'a02',cat:'attack',icon:'üîÑ',name:'Dribble',desc:'Weave past defenders',pow:2,spd:2,def:0},
  {id:'a03',cat:'attack',icon:'ü™Å',name:'Chip Shot',desc:'Lob over the keeper',pow:3,spd:1,def:0},
  {id:'a04',cat:'attack',icon:'üß†',name:'Header',desc:'Aerial attack from cross',pow:4,spd:0,def:0},
  {id:'a05',cat:'attack',icon:'ü¶∂',name:'Volley',desc:'Strike without trapping',pow:4,spd:2,def:0},
  {id:'a06',cat:'attack',icon:'‚ÜòÔ∏è',name:'Low Cross',desc:'Cut back to penalty spot',pow:2,spd:2,def:0},
  {id:'a07',cat:'attack',icon:'üíÉ',name:'Step Over',desc:'Faked touch to beat marker',pow:2,spd:1,def:0},
  {id:'a08',cat:'attack',icon:'üèì',name:'One-Two',desc:'Quick wall pass and run',pow:3,spd:3,def:0},
  {id:'a09',cat:'attack',icon:'üåÄ',name:'Spin Dribble',desc:'360 spin past defender',pow:2,spd:2,def:0},
  {id:'a10',cat:'attack',icon:'üéØ',name:'Precision Shot',desc:'Aim for the top corner',pow:4,spd:0,def:0},
  {id:'a11',cat:'attack',icon:'üî•',name:'Rabona',desc:'Crossed-foot surprise shot',pow:3,spd:1,def:0},
  {id:'a12',cat:'attack',icon:'üåä',name:'Bicycle Kick',desc:'Overhead scissor kick',pow:5,spd:0,def:0},
  {id:'a13',cat:'attack',icon:'üé™',name:'Nutmeg',desc:'Ball through defender legs',pow:2,spd:3,def:0},
  {id:'a14',cat:'attack',icon:'‚òÑÔ∏è',name:'Knuckleball',desc:'Swerving unpredictable shot',pow:4,spd:1,def:0},
  {id:'a15',cat:'attack',icon:'üëä',name:'Shoulder Barge',desc:'Barge through the defender',pow:3,spd:1,def:0},
  {id:'x01',cat:'attack',icon:'üéØ',name:'Shoot at Goal',desc:'Fire an immediate aimed shot at goal',pow:5,spd:0,def:0,_action:'shoot'},
  {id:'x02',cat:'attack',icon:'üèÉ',name:'Go to Enemy Goal',desc:'Sprint directly into the enemy goal area',pow:0,spd:5,def:0,_action:'goal_run'},
  {id:'d01',cat:'defend',icon:'‚¨ÜÔ∏è',name:'Tackle',desc:'Slide in to win the ball',pow:0,spd:1,def:5},
  {id:'d02',cat:'defend',icon:'üß±',name:'Block',desc:'Intercept the shot',pow:0,spd:0,def:5},
  {id:'d03',cat:'defend',icon:'‚¨áÔ∏è',name:'Drop Back',desc:'Retreat into compact shape',pow:0,spd:0,def:4},
  {id:'d04',cat:'defend',icon:'ü´∏',name:'High Press',desc:'Aggressive pressing high up',pow:0,spd:2,def:4},
  {id:'d05',cat:'defend',icon:'üîí',name:'Tight Marking',desc:'Shadow the striker closely',pow:0,spd:1,def:4},
  {id:'d06',cat:'defend',icon:'ü´¥',name:'Interception',desc:'Read and cut the pass',pow:0,spd:2,def:5},
  {id:'d07',cat:'defend',icon:'ü•Ö',name:'Keeper Rush',desc:'GK sweeps off their line',pow:0,spd:1,def:5},
  {id:'d08',cat:'defend',icon:'ü¶µ',name:'Clearance',desc:'Boot it far out of danger',pow:0,spd:0,def:4},
  {id:'d09',cat:'defend',icon:'üè∞',name:'Park the Bus',desc:'All 10 behind the ball',pow:0,spd:0,def:6},
  {id:'d10',cat:'defend',icon:'üï∏Ô∏è',name:'Spider Web',desc:'Trap the attacker',pow:0,spd:0,def:5},
  {id:'d11',cat:'defend',icon:'ü™§',name:'Offside Trap',desc:'Synced last-man run',pow:0,spd:1,def:5},
  {id:'d12',cat:'defend',icon:'üõ°Ô∏è',name:'Shield',desc:'Body-block incoming shot',pow:0,spd:0,def:6},
  {id:'d13',cat:'defend',icon:'ü•Ö',name:'Go to Goal',desc:'Sprint back and guard the goal mouth',pow:0,spd:3,def:5},
  {id:'s01',cat:'special',icon:'‚ú®',name:'Super Shot',desc:'Unstoppable legendary strike',pow:7,spd:0,def:0},
  {id:'s02',cat:'special',icon:'üåÄ',name:'Tornado Spin',desc:'Confuse every defender',pow:4,spd:4,def:0},
  {id:'s03',cat:'special',icon:'üöÄ',name:'Rocket Pass',desc:'50-yard pinpoint laser',pow:3,spd:5,def:0},
  {id:'s04',cat:'special',icon:'üí´',name:'Turbo Burst',desc:'Max speed sprint',pow:2,spd:7,def:0},
  {id:'s05',cat:'special',icon:'üò§',name:'Berserk Mode',desc:'All stats triple boost',pow:5,spd:5,def:3},
  {id:'s06',cat:'special',icon:'ü™É',name:'Curveball',desc:'Bending shot around wall',pow:5,spd:1,def:0},
  {id:'s07',cat:'special',icon:'üåü',name:'Golden Touch',desc:'Perfect first touch',pow:3,spd:2,def:1},
  {id:'s08',cat:'special',icon:'üèÜ',name:'Clutch Play',desc:'Elevates under pressure',pow:4,spd:3,def:2},
  {id:'s09',cat:'special',icon:'üêâ',name:'Dragon Shot',desc:'A truly legendary strike',pow:8,spd:0,def:0},
  {id:'s10',cat:'special',icon:'üåä',name:'Tidal Wave',desc:'Overwhelming surge forward',pow:5,spd:4,def:0},
  {id:'s11',cat:'special',icon:'ü¶Ö',name:'Eagle Eye',desc:'Spots any open teammate',pow:2,spd:2,def:1},
  {id:'s12',cat:'special',icon:'üéÆ',name:'Overclock',desc:'Execute two chips this tick',pow:3,spd:3,def:2},
  {id:'p01',cat:'support',icon:'üë•',name:'Team Press',desc:'Whole team presses together',pow:0,spd:2,def:3},
  {id:'p02',cat:'support',icon:'üìê',name:'Set Piece',desc:'Organized dead-ball routine',pow:3,spd:0,def:1},
  {id:'p03',cat:'support',icon:'üéµ',name:'Tempo Control',desc:'Slow it down, hold possession',pow:0,spd:0,def:2},
  {id:'p04',cat:'support',icon:'üé≠',name:'False Nine',desc:'Striker drops to confuse',pow:2,spd:2,def:1},
  {id:'p05',cat:'support',icon:'üåê',name:'Long Ball',desc:'Bypass midfield entirely',pow:2,spd:2,def:0},
  {id:'p06',cat:'support',icon:'üí°',name:'Vision Pass',desc:'Always find best option',pow:1,spd:2,def:1},
  {id:'p07',cat:'support',icon:'üîã',name:'Energy Boost',desc:'Boost a teammate next turn',pow:0,spd:3,def:1},
  {id:'p08',cat:'support',icon:'üß¨',name:'Adapt',desc:'Copy opponent best chip',pow:2,spd:2,def:2},
  {id:'p09',cat:'support',icon:'üì°',name:'Intel Scan',desc:'Reveals opponent weakness',pow:0,spd:0,def:3},
  {id:'p10',cat:'support',icon:'üéØ',name:'Precision Drill',desc:'Drilled passing sequence',pow:1,spd:1,def:2},
  {id:'t01',cat:'trick',icon:'üé©',name:'Vanishing Act',desc:'Disappear from all markers',pow:2,spd:4,def:0},
  {id:'t02',cat:'trick',icon:'üÉè',name:'Bluff Run',desc:'Fake direction then burst',pow:2,spd:4,def:0},
  {id:'t03',cat:'trick',icon:'üåà',name:'Rainbow Flick',desc:'Flick ball over a head',pow:3,spd:2,def:0},
  {id:'t04',cat:'trick',icon:'üé™',name:'Circus Kick',desc:'Impossible acrobatic strike',pow:4,spd:1,def:0},
  {id:'t05',cat:'trick',icon:'ü™©',name:'Disco Dribble',desc:'Completely unpredictable moves',pow:2,spd:3,def:0},
  {id:'t06',cat:'trick',icon:'üïµÔ∏è',name:'Shadow Step',desc:'Move without being tracked',pow:1,spd:5,def:0},
  {id:'t07',cat:'trick',icon:'üé≠',name:'Puppet Master',desc:'Control where defenders move',pow:2,spd:2,def:2},
  {id:'t08',cat:'trick',icon:'üé≤',name:'Wild Card',desc:'Completely random action',pow:3,spd:3,def:2},
];
const IF_CONDS=[
  {id:'winning',l:'score is winning'},{id:'losing',l:'score is losing'},{id:'drawing',l:'score is a draw'},
  {id:'possession',l:'team has possession'},{id:'no_poss',l:'team lost possession'},
  {id:'early',l:'first half of match'},{id:'late',l:'second half of match'},
  {id:'close',l:'score within 1 goal'},{id:'high_spd',l:'robot speed > 7'},
  {id:'high_str',l:'robot strength > 7'},{id:'high_int',l:'robot intelligence > 7'},
  {id:'ball_in_their_half',l:'ball is in opponent\'s half'},
  {id:'ball_in_our_half',l:'ball is in our half'},
  {id:'teammate_nearby',l:'teammate is nearby'},
  {id:'near_enemy_goal',l:'ball is near enemy goal'},
  {id:'teammate_has_ball',l:'a teammate has the ball'},
  {id:'enemy_nearby',l:'enemy is nearby'},
  {id:'random',l:'50% chance'},
];
// STADIUMS
const STADIUMS=[
  {id:'classic',name:'Classic',sub:'Standard size',icon:'üèü',scale:1.0,nightMode:false},
  {id:'night',name:'Night',sub:'Classic + lights',icon:'üåÉ',scale:1.0,nightMode:true},
  {id:'rain',name:'Storm',sub:'Slippery ball',icon:'üåß',scale:1.0,nightMode:true,rain:true},
  {id:'small',name:'Micro',sub:'Smaller arena',icon:'‚¨õ',scale:0.78,nightMode:false},
  {id:'big',name:'Mega',sub:'Bigger arena',icon:'‚¨ú',scale:1.28,nightMode:false},
  {id:'nightrain',name:'Night Storm',sub:'Dark + rain',icon:'‚õà',scale:1.0,nightMode:true,rain:true},
];
// RANKED TIERS
const RANK_TIERS=[
  {name:'Wood',icon:'ü™µ',color:'#a0785a',min:0,max:200},
  {name:'Bronze',icon:'ü•â',color:'#cd7f32',min:200,max:500},
  {name:'Silver',icon:'ü•à',color:'#c0c0c0',min:500,max:900},
  {name:'Gold',icon:'ü•á',color:'#f5c400',min:900,max:1400},
  {name:'Platinum',icon:'üí†',color:'#00d4e8',min:1400,max:2000},
  {name:'Diamond',icon:'üíé',color:'#9f6fff',min:2000,max:3000},
  {name:'Elite',icon:'üëë',color:'#ff7a2f',min:3000,max:999999},
];
function getTier(rp){return RANK_TIERS.find(t=>rp>=t.min&&rp<t.max)||RANK_TIERS[0];}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SERVER CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SERVER_URL = localStorage.getItem('bf_server') || 'https://ballerexeserver.onrender.com';

// ‚îÄ‚îÄ API helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let OFFLINE_MODE = false;
async function api(method, path, body){
  try {
    const opts = {
      method,
      headers: {
        'Content-Type':'application/json',
        ...(TOKEN ? {'Authorization':'Bearer '+TOKEN} : {})
      }
    };
    if(body) opts.body = JSON.stringify(body);
    const r = await fetch(SERVER_URL+path, opts);
    const data = await r.json().catch(()=>({}));
    if(!r.ok) throw new Error(data.error||'Server error ('+r.status+')');
    OFFLINE_MODE = false;
    return data;
  } catch(e) {
    if(e.message==='Failed to fetch'||e.name==='TypeError'||e.message.includes('NetworkError')){
      console.warn('Server unreachable ‚Äî offline mode');
      OFFLINE_MODE = true;
      return null;
    }
    throw e;  // real errors (400, 401, 409) bubble up to caller
  }
}

// STATE
let ACCOUNTS={},CUR=null,CUR_USER=null,TOKEN=null;
let DRAG=null,SEL_ROBOT=null,PROG_ROBOT=null,PAL_CAT='move';
let _emojiCb=null,_newEmoji='ü§ñ',_newColor=COLORS[0],_newStats={spd:5,str:5,int:5};
let _clanEmoji='üõ°Ô∏è',_clanColor=COLORS[0];
let fCanvas,fCtx,fDragId=null,mCanvas,mCtx,mRAF=null,rainCanvas,rainCtx;
let MS={running:false,speed:1,vsMode:'ai',duration:60,stadium:'classic',weather:'clear',difficulty:'medium'};
let MG={};
let rainDrops=[];

function acct(){return CUR_USER||ACCOUNTS[CUR]||{};}
let _saveTimer=null;
function save(){
  // Always keep local cache in sync
  if(CUR){
    if(!ACCOUNTS[CUR]) ACCOUNTS[CUR]={};
    Object.assign(ACCOUNTS[CUR], CUR_USER||{});
    localStorage.setItem('bf5_acc',JSON.stringify(ACCOUNTS));
  }
  localStorage.setItem('bf5_cur',CUR||'');
  // Debounced server sync
  if(!OFFLINE_MODE && TOKEN && CUR_USER){
    clearTimeout(_saveTimer);
    _saveTimer = setTimeout(()=>{
      api('PATCH','/api/me',{
        robots:   CUR_USER.robots   || [],
        programs: CUR_USER.programs || {},
        field:    CUR_USER.field    || {},
        teamName: CUR_USER.teamName,
        avatar:   CUR_USER.avatar,
        color:    CUR_USER.color
      }).catch(()=>{});
    }, 800);
  }
}
function loadSt(){
  try{ ACCOUNTS=JSON.parse(localStorage.getItem('bf5_acc')||'{}'); }catch(e){ ACCOUNTS={}; }
  CUR   = localStorage.getItem('bf5_cur')  || null;
  TOKEN = localStorage.getItem('bf_token') || null;
}

let _tt;
function toast(m,t='ok'){const el=document.getElementById('toast');el.textContent=m;el.className='show '+(t==='err'?'err':'ok');clearTimeout(_tt);_tt=setTimeout(()=>el.className='',2400);}
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}

// AUTH
let authMode='login';
function switchAuthTab(t){authMode=t;document.querySelectorAll('.auth-tab').forEach((b,i)=>b.classList.toggle('active',(i===0&&t==='login')||(i===1&&t==='register')));renderAuthForm();}
function renderAuthForm(){
  document.getElementById('authErr').textContent='';
  const el=document.getElementById('authForm');
  if(authMode==='login'){
    el.innerHTML=`<div class="af-field"><label class="af-label">Username</label><input class="af-input" id="liU" placeholder="username" autocomplete="username"></div><div class="af-field"><label class="af-label">Password</label><input class="af-input" type="password" id="liP" placeholder="password" onkeydown="if(event.key==='Enter')doLogin()"></div><button class="af-btn" onclick="doLogin()">Sign In</button>`;
  }else{
    el.innerHTML=`<div class="af-field"><label class="af-label">Username</label><input class="af-input" id="rU" placeholder="choose username"></div><div class="af-field"><label class="af-label">Password</label><input class="af-input" type="password" id="rP" placeholder="choose password"></div><div class="af-field"><label class="af-label">Team Name</label><input class="af-input" id="rT" placeholder="e.g. Robo Rockets"></div><button class="af-btn" onclick="doRegister()">Create Account</button>`;
  }
  renderExisting();
}
function renderExisting(){
  const names=Object.keys(ACCOUNTS); const el=document.getElementById('authExisting');
  if(!names.length){el.innerHTML='';return;}
  el.innerHTML=`<div class="ae-title">Saved Accounts</div>`+names.map(n=>{const a=ACCOUNTS[n];return`<div class="ae-pill" onclick="quickLogin('${n}')"><span style="font-size:1.1rem">${a.avatar||'ü§ñ'}</span><span>${n}</span><span style="color:var(--muted);font-size:.7rem;">${a.teamName||''}</span><button class="ae-del" onclick="delAcc(event,'${n}')">‚úï</button></div>`;}).join('');
}

async function doLogin(){
  const u=document.getElementById('liU').value.trim(), p=document.getElementById('liP').value;
  if(!u||!p){ document.getElementById('authErr').textContent='Fill in both fields.'; return; }
  document.getElementById('authErr').textContent='Signing in‚Ä¶';
  try{
    const data = await api('POST','/api/login',{username:u, password:p});
    if(!data){
      // Server offline ‚Äî fall back to local cache
      if(!ACCOUNTS[u]){ document.getElementById('authErr').textContent='Account not found (server offline).'; return; }
      loginAs(u, null, ACCOUNTS[u]); return;
    }
    // Server returns { token, user: {...} }
    loginAs(data.user.username, data.token, data.user);
  } catch(e){ document.getElementById('authErr').textContent=e.message; }
}

async function doRegister(){
  const u=document.getElementById('rU').value.trim(), p=document.getElementById('rP').value, t=document.getElementById('rT').value.trim()||'Team';
  if(!u||!p){ document.getElementById('authErr').textContent='Fill in all fields.'; return; }
  if(u.length<3){ document.getElementById('authErr').textContent='Username needs 3+ chars.'; return; }
  document.getElementById('authErr').textContent='Creating account‚Ä¶';
  try{
    const data = await api('POST','/api/register',{username:u, password:p, teamName:t});
    if(!data){
      // Offline fallback
      if(ACCOUNTS[u]){ document.getElementById('authErr').textContent='Username taken.'; return; }
      ACCOUNTS[u]={teamName:t,avatar:'ü§ñ',color:COLORS[0],robots:[],field:{},programs:{},record:{w:0,d:0,l:0},rp:250,clan:null,leagueId:null};
      loginAs(u, null, ACCOUNTS[u]); return;
    }
    loginAs(data.user.username, data.token, data.user);
  } catch(e){ document.getElementById('authErr').textContent=e.message; }
}

async function quickLogin(u){
  // Try to refresh from server using stored token
  const storedToken = localStorage.getItem('bf_token');
  if(storedToken){
    TOKEN = storedToken;
    try{
      const me = await api('GET','/api/me');
      if(me && me.username === u){ loginAs(me.username, storedToken, me); return; }
    } catch(e){ TOKEN=null; }  // token expired or wrong user ‚Äî fall through
  }
  // Local fallback
  if(ACCOUNTS[u]) loginAs(u, null, ACCOUNTS[u]);
}

function loginAs(username, token, userData){
  CUR      = username;
  CUR_USER = {...(ACCOUNTS[username]||{}), ...userData};  // merge server data on top of local
  if(token){ TOKEN=token; localStorage.setItem('bf_token',token); }
  save();
  enterApp();
}

function delAcc(e,u){ e.stopPropagation(); if(!confirm(`Remove "${u}" from this device?`))return; delete ACCOUNTS[u]; localStorage.setItem('bf5_acc',JSON.stringify(ACCOUNTS)); renderExisting(); }

function signOut(){
  CUR=null; CUR_USER=null; TOKEN=null;
  localStorage.removeItem('bf_token'); localStorage.setItem('bf5_cur','');
  document.getElementById('app').className=''; document.getElementById('app').style.display='none';
  document.getElementById('authScreen').style.display='flex'; renderAuthForm();
}
function enterApp(){
  document.getElementById('authScreen').style.display='none';
  const app=document.getElementById('app');app.style.display='flex';app.className='on';
  if(!CUR_USER||typeof CUR_USER!=='object') CUR_USER=ACCOUNTS[CUR]||{};
  if(!CUR_USER.programs) CUR_USER.programs={};
  if(!CUR_USER.field)    CUR_USER.field={};
  if(!CUR_USER.record)   CUR_USER.record={w:0,d:0,l:0};
  if(CUR_USER.rp===undefined) CUR_USER.rp=250;
  document.getElementById('userName').textContent=CUR;
  document.getElementById('userAva').textContent=CUR_USER.avatar||'ü§ñ';
  updateRec();updateRankBadge();renderRobotsList();renderScratchTabs();renderFieldSide();renderOnline();
  initStadPicker();initWxPicker();
  if(OFFLINE_MODE) toast('‚ö†Ô∏è Offline mode ‚Äî server unreachable','err');
}
function updateRankBadge(){
  if(!CUR)return;
  const t=getTier(acct().rp||0);
  document.getElementById('rankBadge').textContent=`${t.icon} ${t.name.toUpperCase()}`;
  document.getElementById('rankBadge').style.color=t.color;
  document.getElementById('rankBadge').style.background=t.color+'22';
}

// NAVIGATION
function goScreen(id,btn){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('screen-'+id).classList.add('active');
  if(btn)btn.classList.add('active');
  if(id==='scratch')renderScratchFull();
  if(id==='field')renderFieldScreen();
  if(id==='online')renderOnline();
  if(id==='ranked')renderRanked();
  if(id==='leagues')renderLeagues();
  if(id==='clans')renderClans();
}

// ROBOTS
function renderRobotsList(){
  const el=document.getElementById('robotsList'),R=acct().robots||[];
  if(!R.length){el.innerHTML=`<div class="empty-hint"><div class="big">ü§ñ</div><div class="txt">No robots yet!</div><button class="btn btn-gr btn-sm" onclick="openNewRobotModal()">+ Create</button></div>`;return;}
  el.innerHTML=R.map(r=>`<div class="rli${SEL_ROBOT===r.id?' sel':''}" onclick="selectRobot('${r.id}')">
    <div class="rli-ava" style="background:${r.color}22;border:1px solid ${r.color}44">${r.emoji}</div>
    <div style="flex:1;min-width:0;"><div class="rli-name">${r.name}</div><div class="rli-sub">SPD${r.spd} STR${r.str} INT${r.int}</div></div>
    <span class="rli-ct">${countChips(r.id)}üß©</span>
  </div>`).join('');
}
function countChips(rid){
  let n=0;
  function w(s){s.forEach(i=>{
    if(i.type==='chip') n++;
    else if(i.type==='shoot'||i.type==='goal_run') n++;
    else if(i.type==='if'){w(i.then||[]);w(i.else||[]);}
  });}
  w(acct().programs[rid]||[]);return n;
}
function openProfileModal(){
  renderProfileModal();openModal('profileModal');
}
function renderProfileModal(){
  if(!CUR)return;
  const a=acct(),r=a.record||{w:0,d:0,l:0};
  const tier=getTier(a.rp||0);
  document.getElementById('profileModalBody').innerHTML=`
    <div class="profile-modal-ava" id="profAva" onclick="openEmojiModal(e=>{acct().avatar=e;document.getElementById('profAva').textContent=e;document.getElementById('userAva').textContent=e;save();})">${a.avatar||'ü§ñ'}</div>
    <div class="profile-section">
      <div class="profile-section-title">Account</div>
      <div style="font-size:.72rem;color:var(--muted);margin-bottom:6px;">Username: <strong style="color:var(--txt)">${CUR}</strong></div>
      <div class="af-field"><label class="af-label">Team Name</label><input class="af-input" id="profTeam" value="${a.teamName||''}" placeholder="Team name"></div>
      <div class="af-field"><label class="af-label">New Password (leave blank to keep)</label><input class="af-input" type="password" id="profPw" placeholder="new password"></div>
      <button class="btn btn-gr btn-sm" onclick="saveProfile()" style="margin-top:6px;width:100%">Save Changes</button>
    </div>
    <div class="profile-section">
      <div class="profile-section-title">Stats</div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
        <span style="font-size:1.1rem">${tier.icon}</span>
        <span style="font-weight:800;color:${tier.color}">${tier.name}</span>
        <span style="font-size:.7rem;color:var(--muted);">${a.rp||0} RP</span>
      </div>
      <div class="profile-stat-row">
        <div class="profile-stat"><div class="profile-stat-val" style="color:var(--gr)">${r.w||0}</div><div class="profile-stat-lbl">WINS</div></div>
        <div class="profile-stat"><div class="profile-stat-val" style="color:var(--muted)">${r.d||0}</div><div class="profile-stat-lbl">DRAWS</div></div>
        <div class="profile-stat"><div class="profile-stat-val" style="color:var(--re)">${r.l||0}</div><div class="profile-stat-lbl">LOSSES</div></div>
        <div class="profile-stat"><div class="profile-stat-val" style="color:var(--cy)">${(a.robots||[]).length}</div><div class="profile-stat-lbl">ROBOTS</div></div>
      </div>
    </div>`;
}
function saveProfile(){
  const team=document.getElementById('profTeam').value.trim();
  const pw=document.getElementById('profPw').value;
  if(team) acct().teamName=team;
  if(pw){
    if(pw.length<4){toast('Password must be 4+ chars','err');return;}
    acct().password=btoa(pw);
  }
  save();
  document.getElementById('userName').textContent=CUR;
  toast('Profile saved ‚úì');
}
function selectRobot(id){SEL_ROBOT=id;renderRobotsList();renderRobotEditor();}
function renderRobotEditor(){
  const r=acct().robots.find(x=>x.id===SEL_ROBOT);if(!r)return;
  const el=document.getElementById('robotEditor');
  const sc=(s,c)=>`<div class="stat-c"><div class="lbl">${s.toUpperCase()}</div><div class="val" style="color:${c}">${r[s]}</div><div class="bar"><div class="bfill" style="width:${r[s]*10}%;background:${c}"></div></div><div class="adj"><button class="btn btn-s3 btn-xs" onclick="adjStat('${r.id}','${s}',-1)">‚àí</button><button class="btn btn-s3 btn-xs" onclick="adjStat('${r.id}','${s}',+1)">+</button></div></div>`;
  el.innerHTML=`<div class="re-sec"><div style="display:flex;align-items:center;gap:14px;"><div style="width:60px;height:60px;border-radius:14px;background:${r.color}22;border:2px solid ${r.color}55;display:flex;align-items:center;justify-content:center;font-size:2rem;cursor:pointer;flex-shrink:0;" onclick="openEmojiForRobot('${r.id}')">${r.emoji}</div><div style="flex:1;min-width:0;"><input class="inp" value="${r.name}" onchange="renameRobot('${r.id}',this.value)" style="font-weight:700;margin-bottom:7px;"><div class="cpal">${COLORS.map(c=>`<div class="csw${r.color===c?' on':''}" style="background:${c}" onclick="recolorRobot('${r.id}','${c}')"></div>`).join('')}</div></div></div></div>
  <div class="re-sec"><div class="re-stitle">Stats</div><div class="stat3">${sc('spd','#00e57a')}${sc('str','#ff7a2f')}${sc('int','#9f6fff')}</div></div>
  <div class="re-sec"><div class="re-stitle" style="display:flex;align-items:center;justify-content:space-between;">Chip Program<button class="btn btn-s3 btn-xs" onclick="goScreen('scratch',null);setTimeout(()=>openProgramTab('${r.id}'),50)">Edit ‚Üí</button></div><div style="font-size:.72rem;color:var(--muted);">${countChips(r.id)} chips programmed</div></div>
  <button class="btn btn-re btn-sm" onclick="deleteRobot('${r.id}')">Delete Robot</button>`;
}
function adjStat(id,s,d){const r=acct().robots.find(x=>x.id===id);if(!r)return;r[s]=Math.max(1,Math.min(10,r[s]+d));save();renderRobotEditor();}
function renameRobot(id,v){const r=acct().robots.find(x=>x.id===id);if(r){r.name=v;save();renderRobotsList();}}
function recolorRobot(id,c){const r=acct().robots.find(x=>x.id===id);if(r){r.color=c;save();renderRobotsList();renderRobotEditor();}}
function deleteRobot(id){if(!confirm('Delete this robot?'))return;acct().robots=acct().robots.filter(x=>x.id!==id);delete acct().programs[id];delete acct().field[id];SEL_ROBOT=null;save();renderRobotsList();document.getElementById('robotEditor').innerHTML=`<div class="empty-hint"><div class="big">ü§ñ</div><div class="txt">Select a robot to edit</div></div>`;}
function openEmojiForRobot(id){openEmojiModal(e=>{const r=acct().robots.find(x=>x.id===id);if(r){r.emoji=e;save();renderRobotsList();renderRobotEditor();}});}
function openNewRobotModal(){
  _newEmoji='ü§ñ';_newColor=COLORS[0];_newStats={spd:5,str:5,int:5};
  document.getElementById('newRobotName').value='';document.getElementById('newRobotAva').textContent='ü§ñ';document.getElementById('newRobotAva').style.background='';
  document.getElementById('newRobotColors').innerHTML=COLORS.map(c=>`<div class="csw${c===_newColor?' on':''}" style="background:${c}" onclick="pickNewCol('${c}')"></div>`).join('');
  renderNewStats();openModal('robotModal');
}
function renderNewStats(){
  document.getElementById('newRobotStats').innerHTML=['spd','str','int'].map((s,i)=>{
    const c=['#00e57a','#ff7a2f','#9f6fff'][i],n=['SPEED','STRENGTH','INTELLIGENCE'][i];
    return `<div style="margin-bottom:7px;"><div style="display:flex;justify-content:space-between;margin-bottom:3px;"><span style="font-size:.65rem;font-weight:800;color:${c};letter-spacing:1px;">${n}</span><span id="nrv_${s}" style="font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700;color:${c}">5</span></div><input type="range" min="1" max="10" value="5" style="width:100%;accent-color:${c}" oninput="_newStats.${s}=+this.value;document.getElementById('nrv_${s}').textContent=this.value"></div>`;
  }).join('');
}
function pickNewCol(c){_newColor=c;document.getElementById('newRobotAva').style.background=c+'22';document.querySelectorAll('#newRobotColors .csw').forEach(s=>{s.classList.toggle('on',s.style.background===c||s.style.backgroundColor===c);});}
function openEmojiModal(cb){_emojiCb=cb||null;document.getElementById('emojiGrid').innerHTML=EMOJIS.map(e=>`<div class="emo-opt" onclick="pickEmoji('${e}')">${e}</div>`).join('');openModal('emojiModal');}
function pickEmoji(e){_newEmoji=e;const av=document.getElementById('newRobotAva');if(av)av.textContent=e;if(_emojiCb){_emojiCb(e);_emojiCb=null;}closeModal('emojiModal');}
function saveNewRobot(){
  const name=document.getElementById('newRobotName').value.trim();
  if(!name){toast('Enter a name','err');return;}
  const r={id:'r'+Date.now(),name,emoji:_newEmoji,color:_newColor,spd:_newStats.spd,str:_newStats.str,int:_newStats.int};
  acct().robots.push(r);acct().programs[r.id]=[];
  save();closeModal('robotModal');renderRobotsList();selectRobot(r.id);renderScratchTabs();toast('Robot created!');
}

// SCRATCH
function renderScratchFull(){renderPalette();renderScratchTabs();if(PROG_ROBOT)renderProgram();}
function renderPalette(){
  const q=(document.getElementById('palSearch')?.value||'').toLowerCase();
  document.getElementById('palCats').innerHTML=Object.entries(CC).map(([id,c])=>
    `<button class="pc-btn${PAL_CAT===id?' on':''}" style="background:${c.b};color:${c.c};border:1px solid ${PAL_CAT===id?c.c:'transparent'}" onclick="setPalCat('${id}')">${c.l}</button>`
  ).join('');
  let chips=q?CHIPS.filter(c=>c.name.toLowerCase().includes(q)||c.desc.toLowerCase().includes(q)):CHIPS.filter(c=>c.cat===PAL_CAT);
  document.getElementById('palList').innerHTML=chips.map(c=>`<div class="blk" draggable="true" style="background:${CC[c.cat].b};border-left-color:${CC[c.cat].c}" ondragstart="startDrag(event,'${c.id}')"><span class="blk-icon">${c.icon}</span><div><div class="blk-name">${c.name}</div><div class="blk-sub">${c.desc}</div></div></div>`).join('');
}
function setPalCat(cat){PAL_CAT=cat;renderPalette();}
function startDrag(e,id){DRAG={type:'chip',id};e.dataTransfer.effectAllowed='copy';}
function renderScratchTabs(){
  const el=document.getElementById('progTabs'),R=acct()?.robots||[];
  if(!R.length){el.innerHTML=`<span style="font-size:.68rem;color:var(--muted);font-weight:700;">CREATE ROBOTS FIRST</span>`;return;}
  el.innerHTML=`<span style="font-size:.62rem;color:var(--muted);font-weight:700;letter-spacing:1px;white-space:nowrap;flex-shrink:0;">ROBOT:</span>`+
    R.map(r=>`<div class="rtab${PROG_ROBOT===r.id?' on':''}" onclick="openProgramTab('${r.id}')"><span>${r.emoji}</span><span>${r.name}</span></div>`).join('');
}
function openProgramTab(id){PROG_ROBOT=id;renderScratchTabs();renderProgram();}
function renderProgram(){
  const el=document.getElementById('progCanvas');
  const r=acct().robots.find(x=>x.id===PROG_ROBOT);
  if(!r){el.innerHTML=`<div class="empty-hint"><div class="big">üß©</div><div class="txt">Select a robot tab</div></div>`;return;}
  if(!acct().programs[PROG_ROBOT])acct().programs[PROG_ROBOT]=[];
  const prog=acct().programs[PROG_ROBOT];
  const seq=document.createElement('div');seq.className='prog-seq';
  const startDiv=document.createElement('div');startDiv.className='start-blk';startDiv.innerHTML=`<span>‚ñ∂</span><span>START</span><span style="opacity:.5">‚Äî</span><span>${r.emoji} ${r.name}</span>`;
  seq.appendChild(startDiv);
  renderSeqInto(seq,prog,[]);
  seq.appendChild(mkDZ([]));
  const endDiv=document.createElement('div');endDiv.className='end-blk';endDiv.textContent='‚ñ† END';seq.appendChild(endDiv);
  const acts=document.createElement('div');acts.className='prog-actions';
  acts.innerHTML=`<button class="add-if-btn" onclick="addIfBlock()">üîÄ + IF / ELSE block</button><button class="btn btn-re btn-xs" onclick="clearProgram()">üóë Clear All</button>`;
  el.innerHTML='';el.appendChild(seq);el.appendChild(acts);
}
function renderSeqInto(parent,seq,path){
  seq.forEach((item,i)=>{
    if(item.type==='chip'){parent.appendChild(mkChipBlk(item,i,path));parent.appendChild(mkDZ([...path,i+1]));}
    else if(item.type==='if'){parent.appendChild(mkIfBlk(item,i,path));}
  });
}
function mkChipBlk(item,i,path){
  const c=CHIPS.find(x=>x.id===item.id),cc=CC[c?.cat||'move'];
  const d=document.createElement('div');d.className='prog-blk';d.style.background=cc.b;d.style.borderLeftColor=cc.c;
  d.innerHTML=`<span class="pb-num">${i+1}</span><span class="pb-icon">${c?.icon||'?'}</span><span class="pb-label">${c?.name||'Unknown'}</span><span class="pb-cat" style="background:${cc.b};color:${cc.c}">${(c?.cat||'').toUpperCase()}</span><button class="pb-del" onclick="removeBlock(${JSON.stringify([...path,i])})">‚úï</button>`;
  return d;
}
function mkIfBlk(item,i,path){
  const wrap=document.createElement('div');wrap.className='if-wrap';
  const head=document.createElement('div');head.className='if-head';
  const sel=document.createElement('select');sel.className='if-cond-sel';
  IF_CONDS.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent='IF '+c.l;o.selected=c.id===item.cond;sel.appendChild(o);});
  sel.onchange=()=>{item.cond=sel.value;save();};
  const del=document.createElement('button');del.className='pb-del';del.textContent='‚úï';del.onclick=()=>removeBlock([...path,i]);
  head.innerHTML='<span style="font-size:.9rem">üîÄ</span>';head.appendChild(sel);head.appendChild(del);
  wrap.appendChild(head);
  const thenBody=document.createElement('div');thenBody.className='if-body';
  renderSeqInto(thenBody,item.then||[],...[[...path,i,'then']]);
  thenBody.appendChild(mkDZ([...path,i,'then']));
  wrap.appendChild(thenBody);
  const elHead=document.createElement('div');elHead.className='else-head';elHead.innerHTML='<span>‚Ü≥</span><span>ELSE</span>';wrap.appendChild(elHead);
  const elBody=document.createElement('div');elBody.className='else-body';
  renderSeqInto(elBody,item.else||[],...[[...path,i,'else']]);
  elBody.appendChild(mkDZ([...path,i,'else']));
  wrap.appendChild(elBody);
  const endDiv=document.createElement('div');endDiv.className='if-end';endDiv.textContent='END IF';wrap.appendChild(endDiv);
  return wrap;
}
function mkDZ(path){
  const dz=document.createElement('div');dz.className='dz';dz.textContent='+ drop chip here';
  dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('over');});
  dz.addEventListener('dragleave',()=>dz.classList.remove('over'));
  dz.addEventListener('drop',e=>{
    e.preventDefault();dz.classList.remove('over');
    if(!DRAG||DRAG.type!=='chip')return;
    insertBlock(path,{type:'chip',id:DRAG.id});DRAG=null;
  });
  return dz;
}
function getSeq(path){
  let cur=acct().programs[PROG_ROBOT];
  for(const s of path){if(typeof s==='number')cur=cur[s];else cur=cur[s];}
  return cur;
}
function insertBlock(path,item){
  if(!path.length||typeof path[path.length-1]==='string'){const s=getSeq(path);if(Array.isArray(s))s.push(item);}
  else{const idx=path[path.length-1];const s=getSeq(path.slice(0,-1));if(Array.isArray(s))s.splice(idx,0,item);}
  save();renderProgram();renderRobotsList();
}
function removeBlock(path){
  const idx=path[path.length-1];const s=getSeq(path.slice(0,-1));if(Array.isArray(s))s.splice(idx,1);
  save();renderProgram();renderRobotsList();
}
function renderSeqInto(parent,seq,path){
  seq.forEach((item,i)=>{
    if(item.type==='chip'||item.type==='shoot'||item.type==='goal_run'){
      // legacy shoot/goal_run blocks rendered as chip blocks
      const renderItem = (item.type==='shoot') ? {type:'chip',id:'x01'} : (item.type==='goal_run') ? {type:'chip',id:'x02'} : item;
      parent.appendChild(mkChipBlk(renderItem,i,path));
      parent.appendChild(mkDZ([...path,i+1]));
    }
    else if(item.type==='if'){parent.appendChild(mkIfBlk(item,i,path));}
  });
}
function mkShootBlk(item,i,path){
  const d=document.createElement('div');d.className='shoot-blk';
  d.innerHTML=`<span class="pb-num">${i+1}</span><span>üéØ</span><span style="flex:1">SHOOT AT GOAL</span><span style="font-size:.65rem;opacity:.6;margin-right:6px">fires immediately</span><button class="pb-del" onclick="removeBlock(${JSON.stringify([...path,i])})">‚úï</button>`;
  return d;
}
function mkGoalRunBlk(item,i,path){
  const d=document.createElement('div');d.className='goalrun-blk';
  d.innerHTML=`<span class="pb-num">${i+1}</span><span>üèÉ</span><span style="flex:1">GO TO ENEMY GOAL</span><span style="font-size:.65rem;opacity:.6;margin-right:6px">sprints to goal</span><button class="pb-del" onclick="removeBlock(${JSON.stringify([...path,i])})">‚úï</button>`;
  return d;
}
function addShootBlock(){
  if(!PROG_ROBOT){toast('Select a robot first','err');return;}
  acct().programs[PROG_ROBOT].push({type:'shoot'});
  save();renderProgram();
}
function addGoalRunBlock(){
  if(!PROG_ROBOT){toast('Select a robot first','err');return;}
  acct().programs[PROG_ROBOT].push({type:'goal_run'});
  save();renderProgram();
}
function addIfBlock(){
  if(!PROG_ROBOT){toast('Select a robot first','err');return;}
  acct().programs[PROG_ROBOT].push({type:'if',cond:'winning',then:[],else:[]});
  save();renderProgram();
}
function clearProgram(){if(!PROG_ROBOT)return;if(!confirm('Clear all chips?'))return;acct().programs[PROG_ROBOT]=[];save();renderProgram();renderRobotsList();}

// FIELD
function renderFieldSide(){
  const placed=Object.keys(acct().field||{});
  document.getElementById('fieldSideRobots').innerHTML=(acct().robots||[]).map(r=>`<div class="frd${placed.includes(r.id)?' placed':''}" draggable="true" ondragstart="fDragStart(event,'${r.id}')"><span>${r.emoji}</span><span>${r.name}</span></div>`).join('');
}
function renderFieldScreen(){
  renderFieldSide();
  fCanvas=document.getElementById('fieldCanvas');
  const area=document.getElementById('fieldCanvasArea');
  const W=area.clientWidth-24,H=Math.min(area.clientHeight-24,W*.62);
  fCanvas.width=W;fCanvas.height=H;fCtx=fCanvas.getContext('2d');
  fCanvas.ondragover=e=>e.preventDefault();
  fCanvas.ondrop=e=>{
    e.preventDefault();if(!fDragId)return;
    const rect=fCanvas.getBoundingClientRect();
    // RIGHT half = your half (x > 0.5)
    let nx=(e.clientX-rect.left)/rect.width,ny=(e.clientY-rect.top)/rect.height;
    nx=Math.max(.52,Math.min(.97,nx));ny=Math.max(.05,Math.min(.95,ny));
    acct().field[fDragId]={x:nx,y:ny};fDragId=null;save();drawField();renderFieldSide();
  };
  fCanvas.onclick=e=>{
    const rect=fCanvas.getBoundingClientRect();
    const mx=(e.clientX-rect.left)/rect.width*fCanvas.width,my=(e.clientY-rect.top)/rect.height*fCanvas.height;
    for(const[rid,pos] of Object.entries(acct().field||{})){
      if(Math.hypot(mx-pos.x*fCanvas.width,my-pos.y*fCanvas.height)<16){delete acct().field[rid];save();drawField();renderFieldSide();return;}
    }
  };
  drawField();
}
function fDragStart(e,id){fDragId=id;}
function drawField(){
  const W=fCanvas.width,H=fCanvas.height,ctx=fCtx;
  const g=ctx.createLinearGradient(0,0,W,0);g.addColorStop(0,'#173321');g.addColorStop(.5,'#1e4a2e');g.addColorStop(1,'#173321');
  ctx.fillStyle=g;ctx.fillRect(0,0,W,H);
  for(let i=0;i<8;i++){ctx.fillStyle=i%2?'rgba(255,255,255,.03)':'rgba(0,0,0,.06)';ctx.fillRect(i*W/8,0,W/8,H);}
  ctx.strokeStyle='rgba(255,255,255,.45)';ctx.lineWidth=1.4;const p=14;
  ctx.strokeRect(p,p,W-p*2,H-p*2);ctx.beginPath();ctx.moveTo(W/2,p);ctx.lineTo(W/2,H-p);ctx.stroke();
  ctx.beginPath();ctx.arc(W/2,H/2,H*.18,0,Math.PI*2);ctx.stroke();
  const gw=7,gh=H*.22;
  [[p-gw,(H-gh)/2],[W-p,(H-gh)/2]].forEach(([gx,gy])=>{ctx.fillStyle='rgba(255,255,255,.08)';ctx.fillRect(gx,gy,gw,gh);ctx.strokeRect(gx,gy,gw,gh);});
  const paw=W*.13,pah=H*.5;ctx.strokeRect(p,(H-pah)/2,paw,pah);ctx.strokeRect(W-p-paw,(H-pah)/2,paw,pah);
  // highlight YOUR half (right)
  ctx.fillStyle='rgba(0,229,122,.07)';ctx.fillRect(W/2,p,W/2-p,H-p*2);
  ctx.font=`700 ${Math.max(9,W*.01)}px Syne`;ctx.fillStyle='rgba(0,229,122,.4)';ctx.textAlign='center';ctx.fillText('YOUR HALF (attack right ‚Üí)',W*.75,H*.08);
  ctx.fillStyle='rgba(255,61,90,.07)';ctx.fillRect(p,p,W/2-p,H-p*2);
  ctx.fillStyle='rgba(255,61,90,.3)';ctx.fillText('‚Üê ENEMY GOAL',W*.25,H*.08);
  for(const[rid,pos] of Object.entries(acct().field||{})){
    const r=(acct().robots||[]).find(x=>x.id===rid);if(!r)continue;
    const px=pos.x*W,py=pos.y*H;
    ctx.beginPath();ctx.ellipse(px,py+13,11,5,0,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,.25)';ctx.fill();
    ctx.beginPath();ctx.arc(px,py,13,0,Math.PI*2);ctx.fillStyle=r.color+'cc';ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.5)';ctx.lineWidth=1.2;ctx.stroke();
    ctx.font='13px serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(r.emoji,px,py);
    ctx.font=`700 ${Math.max(8,W*.009)}px Syne`;ctx.fillStyle='rgba(255,255,255,.85)';ctx.textBaseline='top';ctx.fillText(r.name,px,py+15);
  }
}
function applyFormation(f){
  if(!(acct().robots||[]).length){toast('Add robots first','err');return;}
  // formations are in the RIGHT half (your half, x>0.5)
  const fm={'442':[[.76,.5],[.67,.22],[.67,.44],[.67,.60],[.67,.78],[.60,.28],[.60,.50],[.60,.66],[.55,.22],[.55,.50],[.55,.78]],
    '433':[[.76,.5],[.67,.18],[.67,.43],[.67,.58],[.67,.82],[.60,.28],[.60,.50],[.60,.72],[.55,.22],[.55,.50],[.55,.78]],
    '352':[[.76,.5],[.67,.22],[.67,.50],[.67,.78],[.60,.15],[.60,.35],[.60,.50],[.60,.65],[.60,.85],[.55,.33],[.55,.67]],
    '532':[[.76,.5],[.66,.12],[.66,.30],[.66,.50],[.66,.70],[.66,.88],[.59,.30],[.59,.50],[.59,.70],[.54,.33],[.54,.67]]};
  acct().field={};(acct().robots||[]).slice(0,11).forEach((r,i)=>{if(fm[f][i])acct().field[r.id]={x:fm[f][i][0],y:fm[f][i][1]};});
  save();if(fCanvas)drawField();renderFieldSide();toast(`Formation ${f} applied`);
}

// STADIUM & WEATHER PICKERS
function initStadPicker(){
  document.getElementById('stadGrid').innerHTML=STADIUMS.map(s=>
    `<div class="stad-card${MS.stadium===s.id?' on':''}" onclick="pickStad('${s.id}')"><div class="stad-ico">${s.icon}</div><div class="stad-lbl">${s.name}</div><div class="stad-sub">${s.sub}</div></div>`
  ).join('');
}
function pickStad(id){
  MS.stadium=id;
  document.querySelectorAll('.stad-card').forEach(c=>c.classList.remove('on'));
  event.currentTarget.classList.add('on');
}
function initWxPicker(){
  const wxOptions=[{id:'clear',icon:'‚òÄÔ∏è',label:'Clear'},{id:'night',icon:'üåô',label:'Night'},{id:'rain',icon:'üåß',label:'Rain'}];
  document.getElementById('wxRow').innerHTML=wxOptions.map(w=>
    `<button class="wx-btn${MS.weather===w.id?' on':''}" onclick="pickWx('${w.id}',this)">${w.icon} ${w.label}</button>`
  ).join('');
}
function pickWx(id,btn){
  MS.weather=id;
  document.querySelectorAll('.wx-btn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
}
function pickDur(d,btn){MS.duration=d;document.querySelectorAll('.dur-btn').forEach(b=>b.classList.remove('on'));btn.classList.add('on');}
function toggleSpeed(){MS.speed=MS.speed===1?3:1;document.getElementById('speedBtn').textContent=MS.speed===3?'üê¢ 1√ó Speed':'‚è© 3√ó Speed';}
function stopMatch(){
  MS.running=false;
  if(mRAF)cancelAnimationFrame(mRAF);
  stopRain();
  document.getElementById('matchOverlay').style.display='flex';
}
function closeEndOverlay(){
  document.getElementById('endOverlay').style.display='none';
  document.getElementById('matchOverlay').style.display='flex';
}

function pickDiff(d,btn){
  MS.difficulty=d;
  document.querySelectorAll('.diff-btn').forEach(b=>{b.classList.remove('on-easy','on-medium','on-hard');});
  btn.classList.add('on-'+d);
}

function pickVs(v){
  MS.vsMode=v;
  document.getElementById('vsAI').classList.toggle('on',v==='ai');
  document.getElementById('vsFriend').classList.toggle('on',v==='friend');
  document.getElementById('friendCodeRow').style.display=v==='friend'?'block':'none';
  document.getElementById('diffRow').style.display=v==='friend'?'none':'block';
}

function kickOff(){
  const err=document.getElementById('moErr');err.textContent='';
  const robots=acct().robots||[];
  if(!robots.length){err.textContent='You need robots!';return;}
  if(!robots.some(r=>countChips(r.id)>0)){err.textContent='Program your robots first!';return;}
  let awayData;
  if(MS.vsMode==='friend'){
    const code=document.getElementById('friendCodeInp').value.trim();
    if(code.length<4){err.textContent='Enter a 4-char code';return;}
    const saved=localStorage.getItem('bf3_team_'+code)||localStorage.getItem('bf5_team_'+code);
    if(!saved){err.textContent='No team found for that code';return;}
    try{awayData=JSON.parse(saved);}catch(e){err.textContent='Invalid code';return;}
  }else{awayData=buildAITeam();}
  document.getElementById('matchOverlay').style.display='none';
  document.getElementById('endOverlay').style.display='none';
  const stad=STADIUMS.find(s=>s.id===MS.stadium)||STADIUMS[0];
  const isRain=(stad.rain||MS.weather==='rain');
  const isNight=(stad.nightMode||MS.weather==='night'||MS.weather==='rain');
  initMatch(robots,acct().programs||{},acct().field||{},acct().teamName||CUR,awayData,isRain,isNight,stad.scale||1);
}

function buildAITeam(){
  const mk=ids=>ids.map(id=>({type:'chip',id}));
  const diff=MS.difficulty||'medium';

  // Stat profiles by difficulty
  // Easy: weaker stats, simpler chips
  // Medium: balanced, mixed chips
  // Hard: high stats, smart chip combinations with conditionals
  const statMult = diff==='easy'?0.6 : diff==='hard'?1.0 : 0.8;
  const s=(base)=>Math.round(Math.max(1,Math.min(10, base*statMult + (diff==='hard'?1:0))));

  // Robots: goalkeeper/defenders (deep), midfielders (mid), attackers (forward)
  // Each has a distinct role identity via stats and chips
  const aiR=[
    // GK/Sweeper ‚Äî deep defender, high DEF-chip focus
    {id:'ai1', name: diff==='hard'?'IRON':'HAL',    emoji:'üõ°Ô∏è', color:'#ff3d5a', spd:s(5), str:s(7), int:s(7)},
    // Left defender
    {id:'ai2', name: diff==='hard'?'WALL':'BRACE',  emoji:'ü¶æ', color:'#ff3d5a', spd:s(5), str:s(8), int:s(5)},
    // Right defender
    {id:'ai3', name: diff==='hard'?'FORT':'HOLD',   emoji:'üè∞', color:'#ff3d5a', spd:s(5), str:s(8), int:s(5)},
    // Central midfielder ‚Äî engine, high INT
    {id:'ai4', name: diff==='hard'?'SAGE':'MID',    emoji:'üß†', color:'#ff3d5a', spd:s(7), str:s(6), int:s(9)},
    // Wide midfielder
    {id:'ai5', name: diff==='hard'?'WIRE':'LINK',   emoji:'‚ö°', color:'#ff3d5a', spd:s(9), str:s(5), int:s(6)},
    // Striker ‚Äî high STR + SPD
    {id:'ai6', name: diff==='hard'?'APEX':'RUSH',   emoji:'üî•', color:'#ff3d5a', spd:s(9), str:s(9), int:s(6)},
  ];

  // Chip programs by difficulty and role
  let progs;
  if(diff==='easy'){
    // Easy: basic single chips, no conditionals, slow reaction
    progs={
      ai1: mk(['d03','d09','d08']),           // just drop back and clear
      ai2: mk(['d01','d02','d03']),           // tackle and hold
      ai3: mk(['d01','d02','d12']),           // tackle and shield
      ai4: mk(['m06','m09','m10']),           // safe passes only
      ai5: mk(['m01','m06','a02']),           // basic move
      ai6: mk(['a02','a01','m01']),           // simple dribble+shoot
    };
  } else if(diff==='medium'){
    // Medium: conditionals, smarter chip combos
    progs={
      ai1:[{type:'if',cond:'losing',then:mk(['d04','d01']),else:mk(['d03','d09'])}],
      ai2:[{type:'if',cond:'possession',then:mk(['m09','p03']),else:mk(['d01','d05'])}],
      ai3:[{type:'if',cond:'no_poss',then:mk(['d06','d01']),else:mk(['d03','d12'])}],
      ai4:[{type:'if',cond:'winning',then:mk(['p03','m06']),else:mk(['m08','a08'])},{type:'chip',id:'m03'}],
      ai5:[{type:'if',cond:'possession',then:mk(['m05','a06']),else:mk(['m08','d04'])},{type:'chip',id:'m02'}],
      ai6:[{type:'if',cond:'losing',then:mk(['s05','a01']),else:mk(['a02','a10'])},{type:'chip',id:'a08'}],
    };
  } else {
    // Hard: deep conditional trees, high-power chips, smart responses
    progs={
      ai1:[
        {type:'if',cond:'losing',then:mk(['d04','d06','d01']),else:[{type:'if',cond:'no_poss',then:mk(['d09','d12']),else:mk(['d03','p03'])}]},
        {type:'chip',id:'d07'},
      ],
      ai2:[
        {type:'if',cond:'no_poss',then:[{type:'if',cond:'close',then:mk(['d04','d05']),else:mk(['d09','d12'])}],else:mk(['m08','m05'])},
        {type:'chip',id:'d11'},
      ],
      ai3:[
        {type:'if',cond:'no_poss',then:mk(['d06','d01','d10']),else:[{type:'if',cond:'early',then:mk(['m06','p03']),else:mk(['m08','p05'])}]},
      ],
      ai4:[
        {type:'if',cond:'possession',then:[{type:'if',cond:'winning',then:mk(['p03','m06']),else:mk(['s08','m08','m03'])}],else:mk(['d04','m08','p06'])},
        {type:'chip',id:'p06'},
      ],
      ai5:[
        {type:'if',cond:'possession',then:[{type:'if',cond:'late',then:mk(['s03','a06','a08']),else:mk(['m05','m02','a13'])}],else:mk(['d04','m08'])},
        {type:'chip',id:'s04'},
      ],
      ai6:[
        {type:'if',cond:'losing',then:mk(['s05','s01','a12']),else:[{type:'if',cond:'close',then:mk(['a10','a14','a01']),else:mk(['a08','a02','a09'])}]},
        {type:'chip',id:'s09'},
      ],
    };
  }

  // Formation: 2 deep defenders, 1 midfielder, 1 wide mid, 1 forward, 1 sweeper
  // All in left half (x<0.5) ‚Äî away team
  const field={
    ai1:{x:0.06, y:0.50},   // sweeper/GK deep
    ai2:{x:0.16, y:0.28},   // left CB
    ai3:{x:0.16, y:0.72},   // right CB
    ai4:{x:0.30, y:0.50},   // CM
    ai5:{x:0.32, y:0.22},   // wide mid
    ai6:{x:0.42, y:0.50},   // striker
  };

  const names={easy:'Tin FC', medium:'Bot FC', hard:'TITAN AI'};
  const colors={easy:'#ff6b6b', medium:'#ff3d5a', hard:'#ff0033'};
  // Apply difficulty color to all robots
  aiR.forEach(r=>r.color=colors[diff]);

  return{name:names[diff], robots:aiR, programs:progs, field, difficulty:diff};
}

// ‚îÄ‚îÄ‚îÄ REPLACED: full physics match engine below ‚îÄ‚îÄ‚îÄ

function rnd(r){return(Math.random()-.5)*r*2;}

// Spawn formations: evenly spaced, no clumping
// HOME = right half (x 0.55‚Äì0.92), attacks LEFT goal (x=0)
// AWAY = left half  (x 0.08‚Äì0.45), attacks RIGHT goal (x=1)
function makeSpawnPositions(isAway, count){
  const cols=3, rows=Math.ceil(count/cols);
  const positions=[];
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      if(positions.length>=count)break;
      const t=(count<=1)?0.5:(positions.length/(count-1));
      // stagger nicely
      const yBase=0.12+(r/(Math.max(rows-1,1)))*0.76;
      const xBase=isAway?(0.10+c*0.12):(0.92-c*0.12);
      positions.push({x:xBase+rnd(0.03), y:yBase+rnd(0.04)});
    }
  }
  return positions;
}

function initMatch(homeRobots,homeProgs,homeField,homeName,away,isRain,isNight,scale){
  mCanvas=document.getElementById('matchCanvas');
  rainCanvas=document.getElementById('rainCanvas');
  const wrap=document.getElementById('matchCanvasWrap');
  // Force layout so we get real dimensions
  const baseW=wrap.offsetWidth||wrap.clientWidth||800;
  const baseH=wrap.offsetHeight||wrap.clientHeight||500;
  mCanvas.width=baseW; mCanvas.height=baseH;
  rainCanvas.width=baseW; rainCanvas.height=baseH;
  // Make canvas fill wrap
  mCanvas.style.position='absolute';mCanvas.style.inset='0';mCanvas.style.width='100%';mCanvas.style.height='100%';
  rainCanvas.style.position='absolute';rainCanvas.style.inset='0';
  mCtx=mCanvas.getContext('2d');
  rainCtx=rainCanvas.getContext('2d');

  document.getElementById('hudH').textContent=homeName||'Home';
  document.getElementById('hudA').textContent=away.name||'Away';
  document.getElementById('hudSH').textContent='0';
  document.getElementById('hudSA').textContent='0';
  document.getElementById('matchLog').innerHTML='';

  // ‚îÄ‚îÄ Build player lists with proper half-locked spawn positions ‚îÄ‚îÄ
  function buildPlayers(robots, progs, userField, team, isAway){
    const n=Math.min(robots.length,11);
    // Try to use user-placed field positions, clamped to correct half
    const spawns=makeSpawnPositions(isAway, n);
    return robots.slice(0,n).map((r,i)=>{
      let bx,by;
      const fp=userField[r.id];
      if(fp){
        // Mirror user field: user places in right half; away gets left half mirror
        bx=isAway?(1-fp.x):fp.x;
        by=fp.y;
      } else {
        bx=spawns[i].x;
        by=spawns[i].y;
      }
      // Hard clamp to correct half
      bx=isAway?Math.max(0.04,Math.min(0.45,bx)):Math.max(0.55,Math.min(0.96,bx));
      by=Math.max(0.05,Math.min(0.95,by));
      return{
        id:r.id, team, robot:r,
        prog:buildFlatProg(progs[r.id]||[]), progIdx:0,
        // Physics position (pixel-space fraction 0‚Äì1)
        x:bx, y:by,
        vx:0, vy:0,
        baseX:bx, baseY:by,
        // AI state
        chipTimer:40+Math.floor(Math.random()*60),
        lastChip:null,
        trail:[],
        aiState:'hold',
        aiReactTimer:Math.floor(Math.random()*20),
      };
    });
  }

  const homePlayers=buildPlayers(homeRobots,homeProgs,homeField,'home',false);
  const awayPlayers=buildPlayers(away.robots,away.programs||{},away.field||{},'away',true);

  const ticksPerPeriod=MS.duration*60;

  MG={
    tick:0, maxTick:ticksPerPeriod,
    homeScore:0, awayScore:0,
    // Ball: normalised coords, with real velocity
    ball:{x:0.5, y:0.5, vx:0, vy:0, trail:[]},
    players:[...homePlayers,...awayPlayers],
    homeName, awayName:away.name,
    particles:[], phase:'playing',
    pendingLog:[], logFlush:0,
    period:1, maxPeriods:4,
    isRain, isNight, scale:scale||1,
    elapsedSec:0,
    goalCooldown:0,  // prevent double-goals
    possession:'home',
    awayDifficulty: MS.difficulty||'medium',
    _awaySweeper: null,   // assigned once by tickAwayAI on first tick
  };

  // Rain drops
  if(isRain){
    rainCanvas.style.display='block';
    rainDrops=[];
    for(let i=0;i<220;i++){
      rainDrops.push({x:Math.random()*baseW,y:Math.random()*baseH,
        l:8+Math.random()*18,s:5+Math.random()*5,a:Math.random()*.5+.25});
    }
  }else{
    rainCanvas.style.display='none';
    rainDrops=[];
  }

  MS.running=true;
  addLog('‚öΩ Kick off!','info');
  // Set difficulty badge
  const dBadge=document.getElementById('diffBadge');
  if(dBadge){
    const dc={easy:{c:'#00e57a',bg:'rgba(0,229,122,.12)',t:'üü¢ EASY'},medium:{c:'#f5c400',bg:'rgba(245,196,0,.12)',t:'üü° MEDIUM'},hard:{c:'#ff3d5a',bg:'rgba(255,61,90,.12)',t:'üî¥ HARD'}};
    const dp=dc[MG.awayDifficulty]||dc.medium;
    dBadge.style.color=dp.c; dBadge.style.background=dp.bg; dBadge.textContent='AI: '+dp.t;
  }
  let lastT=0;
  function loop(ts){
    if(!MS.running)return;
    if(lastT===0)lastT=ts;
    lastT=ts;
    const steps=MS.speed===3?3:1;
    for(let s=0;s<steps;s++)tickMatch();
    drawMatch();
    if(MG.isRain)drawRain();
    mRAF=requestAnimationFrame(loop);
  }
  mRAF=requestAnimationFrame(loop);
}

function buildFlatProg(seq){
  const flat=[];
  seq.forEach(item=>{
    if(item.type==='chip') flat.push(item.id);
    else if(item.type==='if') flat.push(item);
    else if(item.type==='shoot') flat.push('x01');   // legacy ‚Üí action chip
    else if(item.type==='goal_run') flat.push('x02'); // legacy ‚Üí action chip
  });
  return flat;
}

function resolveChip(player){
  if(!player.prog.length)return CHIPS[0];
  for(let tries=0;tries<player.prog.length*2+2;tries++){
    const item=player.prog[player.progIdx%Math.max(1,player.prog.length)];
    player.progIdx++;
    if(typeof item==='string'){
      const chip=CHIPS.find(c=>c.id===item)||CHIPS[0];
      // ‚îÄ‚îÄ Action chips: x01=shoot, x02=goal_run ‚îÄ‚îÄ
      if(chip._action==='shoot'){ player._shootNow=true; addLog(`üéØ ${player.robot.emoji} SHOOT AT GOAL!`,'action'); }
      if(chip._action==='goal_run'){ player._goalRun=true; addLog(`üèÉ ${player.robot.emoji} CHARGING TO GOAL!`,'action'); }
      return chip;
    }
    // ‚îÄ‚îÄ SHOOT block: force an immediate aimed shot at goal ‚îÄ‚îÄ
    if(item&&item.type==='shoot'){
      player._shootNow=true;
      addLog(`üéØ ${player.robot.emoji} SHOOT AT GOAL!`,'action');
      return CHIPS.find(c=>c.id==='x01')||CHIPS[0];
    }
    // ‚îÄ‚îÄ GOAL RUN block: sprint directly to enemy goal ‚îÄ‚îÄ
    if(item&&item.type==='goal_run'){
      player._goalRun=true;
      addLog(`üèÉ ${player.robot.emoji} CHARGING TO GOAL!`,'action');
      return CHIPS.find(c=>c.id==='x02')||CHIPS[0];
    }
    if(item&&(item.type==='if'||item.then)){
      const branch=evalCond(item.cond||'random',player)?item.then:item.else||[];
      const flat=buildFlatProg(branch);
      if(flat.length){
        const cid=flat[0];
        if(typeof cid==='string'){
          const chip=CHIPS.find(c=>c.id===cid)||CHIPS[0];
          const condL=IF_CONDS.find(x=>x.id===(item.cond||'random'))?.l||item.cond;
          addLog(`üîÄ IF ${condL} ‚Üí ${chip.icon} ${chip.name}`,'if');
          return chip;
        }
        // shoot block inside an if branch
        if(cid&&cid.type==='shoot'){
          player._shootNow=true;
          const condL=IF_CONDS.find(x=>x.id===(item.cond||'random'))?.l||item.cond;
          addLog(`üîÄ IF ${condL} ‚Üí üéØ SHOOT AT GOAL`,'if');
          return CHIPS.find(c=>c.id==='x01')||CHIPS[0];
        }
        // goal_run block inside an if branch
        if(cid&&cid.type==='goal_run'){
          player._goalRun=true;
          const condL=IF_CONDS.find(x=>x.id===(item.cond||'random'))?.l||item.cond;
          addLog(`üîÄ IF ${condL} ‚Üí üèÉ GO TO ENEMY GOAL`,'if');
          return CHIPS.find(c=>c.id==='x02')||CHIPS[0];
        }
      }
    }
  }
  return CHIPS[0];
}

function evalCond(cond,player){
  const hs=MG.homeScore,as=MG.awayScore;
  const isHome=player.team==='home';
  const myS=isHome?hs:as,oppS=isHome?as:hs;
  const pct=MG.tick/MG.maxTick,r=player.robot;
  switch(cond){
    case 'winning': return myS>oppS;
    case 'losing':  return myS<oppS;
    case 'drawing': return myS===oppS;
    case 'possession':return MG.possession===player.team;
    case 'no_poss': return MG.possession!==player.team;
    case 'early':   return pct<.5;
    case 'late':    return pct>=.5;
    case 'close':   return Math.abs(hs-as)<=1;
    case 'high_spd':return (r.spd||5)>7;
    case 'high_str':return (r.str||5)>7;
    case 'high_int':return (r.int||5)>7;
    case 'ball_in_their_half': {
      // "their half" = opponent's side. Home attacks left (x<0.5), Away attacks right (x>0.5)
      const isHome2=player.team==='home';
      return isHome2 ? MG.ball.x < 0.5 : MG.ball.x > 0.5;
    }
    case 'ball_in_our_half': {
      const isHome3=player.team==='home';
      return isHome3 ? MG.ball.x > 0.5 : MG.ball.x < 0.5;
    }
    case 'teammate_nearby': {
      // True if any teammate is within ~0.18 normalised units (~18% of field width)
      const teammates = MG.players.filter(q => q !== player && q.team === player.team);
      return teammates.some(q => Math.hypot(q.x - player.x, q.y - player.y) < 0.18);
    }
    case 'near_enemy_goal': {
      // True when ball is within ~0.20 of the opponent's goal
      // Home attacks left (goal at x‚âà0.02), Away attacks right (goal at x‚âà0.98)
      const isHome4 = player.team === 'home';
      return isHome4 ? MG.ball.x < 0.20 : MG.ball.x > 0.80;
    }
    case 'teammate_has_ball': {
      // True when a teammate (not this player) is touching the ball right now
      const touchDist = PLAYER_RADIUS + BALL_RADIUS + 0.012;
      return MG.players.some(q =>
        q !== player &&
        q.team === player.team &&
        Math.hypot(q.x - MG.ball.x, q.y - MG.ball.y) < touchDist
      );
    }
    case 'enemy_nearby': {
      // True if any opponent is within ~0.18 of this player
      return MG.players.some(q =>
        q.team !== player.team &&
        Math.hypot(q.x - player.x, q.y - player.y) < 0.18
      );
    }
    case 'random':  return Math.random()<.5;
    default:        return true;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PHYSICS CONSTANTS  (all in normalised 0‚Äì1 space)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PLAYER_RADIUS = 0.030;   // collision radius
const BALL_RADIUS   = 0.018;
const PLAYER_SPEED  = 0.0045;  // base move speed per tick
const BALL_FRICTION = 0.982;   // multiplied each tick
const RAIN_FRICTION = 0.991;   // less friction in rain
const BALL_BOUNCE   = 0.60;    // wall bounce damping
const KICK_POWER    = 0.022;   // base kick velocity

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OPPOSING TEAM AI ‚Äî runs for all 'away' players
//  This is separate from the chip system. The away AI uses real
//  football decision logic: role-based states, reaction delays,
//  spatial awareness, coordination signals, difficulty scaling.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Difficulty parameter profiles
const DIFF_PARAMS = {
  easy: {
    reactionDelay: 90,     // ticks before AI reacts to new situation (sluggish)
    speedMult:     0.72,   // movement speed multiplier
    aimNoise:      0.18,   // kick direction noise (high = inaccurate)
    pressRadius:   0.15,   // how close ball must be for defender to press
    shotRange:     0.25,   // only shoot if within this distance of goal
    passChance:    0.15,   // probability of choosing to pass vs shoot/dribble
    tackleRadius:  0.07,   // effective tackle reach
    defLineX:      0.22,   // how deep defenders hold (away coords)
    midPressure:   0.2,    // how aggressively midfielders press
    updateEvery:   4,      // recalculate target every N ticks
    kickMult:      0.85,   // kick power multiplier
    predictTicks:  0,      // how far ahead to predict ball position (ticks)
    dribbleTight:  1.00,   // carry tap jitter multiplier (lower=tighter control)
    stealReact:    6,      // ticks before attempting steal after losing ball
    longBall:      false,  // whether defenders use long ball counter-attack
    sweeper:       false,  // whether one def acts as a pure sweeper
  },
  medium: {
    reactionDelay: 50,
    speedMult:     0.90,
    aimNoise:      0.09,
    pressRadius:   0.22,
    shotRange:     0.35,
    passChance:    0.30,
    tackleRadius:  0.09,
    defLineX:      0.18,
    midPressure:   0.35,
    updateEvery:   2,
    kickMult:      1.00,
    predictTicks:  4,
    dribbleTight:  0.75,
    stealReact:    4,
    longBall:      false,
    sweeper:       false,
  },
  hard: {
    reactionDelay: 20,
    speedMult:     1.10,   // slightly faster than before
    aimNoise:      0.025,  // near-perfect aim
    pressRadius:   0.42,   // aggressive pressing from wide range
    shotRange:     0.52,
    passChance:    0.45,
    tackleRadius:  0.13,
    defLineX:      0.13,
    midPressure:   0.58,
    updateEvery:   1,      // reacts every single tick
    kickMult:      1.22,   // boss-tier kick power
    predictTicks:  12,     // predicts ball position 12 ticks ahead
    dribbleTight:  0.35,   // very tight dribbling ‚Äî ball barely leaves feet
    stealReact:    1,      // steals back almost instantly
    longBall:      true,   // defenders launch long balls to strikers
    sweeper:       true,   // one defender is a pure sweeper
  },
};

// AI state machine states for each away player
// 'hold'     ‚Äî stay in formation position
// 'press'    ‚Äî move toward ball to win possession
// 'cover'    ‚Äî mark / shadow a home player
// 'support'  ‚Äî move into a passing lane for teammate
// 'attack'   ‚Äî advance toward enemy goal with or without ball
// 'shoot'    ‚Äî position for or take a shot
// 'recover'  ‚Äî sprint back to defensive position

function getAwayAIDifficulty(){
  return DIFF_PARAMS[MG.awayDifficulty||'medium'];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  üî¥ RED TEAM AI  ‚Äî  Boss-tier opponent
//
//  What makes Red different from Blue (home, chip-driven):
//  ‚Ä¢ Predictive targeting: aims at ball.pos + ball.vel √ó predictTicks
//  ‚Ä¢ Wider press radius: D.pressRadius (up to 0.42 on hard)
//  ‚Ä¢ Dedicated sweeper: deepest def always guards goal-ball line
//  ‚Ä¢ Faster reaction: updateEvery ‚àí 1 per cycle
//  ‚Ä¢ Harder kicks: base power √ó D.kickMult (1.22 on hard)
//  ‚Ä¢ Tighter carry: jitter √ó D.dribbleTight (0.35 on hard)
//  ‚Ä¢ Long ball: defender wins ball in own half ‚Üí launch to striker
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function tickAwayAI(){
  const B  = MG.ball;
  const D  = getAwayAIDifficulty();
  const awayPlayers = MG.players.filter(p=>p.team==='away');
  const homePlayers = MG.players.filter(p=>p.team==='home');
  const weHaveBall  = MG.possession === 'away';

  const DEFEND_X = 0.02;
  const ATTACK_X = 0.98;

  // ‚îÄ‚îÄ üî¥ Predicted ball position ‚Äî Red's core edge over Blue ‚îÄ‚îÄ
  const look  = D.predictTicks || 0;
  const predX = Math.max(0.02, Math.min(0.98, B.x + B.vx * look));
  const predY = Math.max(0.03, Math.min(0.97, B.y + B.vy * look));

  // ‚îÄ‚îÄ Assign roles once per player (cached) ‚îÄ‚îÄ
  awayPlayers.forEach(p => {
    if(!p._role){
      const rs = Math.max(0, Math.min(1, (p.baseX - 0.02) / 0.46));
      p._role = rs < 0.13 ? 'gk' : rs < 0.40 ? 'def' : rs < 0.68 ? 'mid' : 'fwd';
    }
  });

  // ‚îÄ‚îÄ üî¥ Sweeper: deepest defender ALWAYS covers the goal-ball line ‚îÄ‚îÄ
  const defs = awayPlayers.filter(p=>p._role==='def');
  const sweeper = D.sweeper && defs.length
    ? defs.reduce((a,b)=> a.baseX < b.baseX ? a : b)
    : null;

  // ‚îÄ‚îÄ Striker target for long ball (most forward non-def, non-gk) ‚îÄ‚îÄ
  const fwds = awayPlayers.filter(p=>p._role==='fwd'||p._role==='mid');
  const striker = fwds.length
    ? fwds.reduce((a,b)=> a.baseX > b.baseX ? a : b)
    : null;

  // ‚îÄ‚îÄ Sort by distance to PREDICTED ball ‚Äî determines who presses ‚îÄ‚îÄ
  const pressable = awayPlayers.filter(p=> p !== sweeper);
  const sorted = [...pressable].sort((a,b)=>
    Math.hypot(a.x-predX,a.y-predY) - Math.hypot(b.x-predX,b.y-predY)
  );
  const ballPresser = sorted[0];
  const ballSupport = sorted[1];

  // ‚îÄ‚îÄ Ball zone flags ‚îÄ‚îÄ
  const ballInOurHalf     = B.x < 0.50;
  const ballNearOurGoal   = B.x < 0.20;
  const ballInTheirHalf   = B.x > 0.50;
  const ballNearTheirGoal = B.x > 0.80;

  const losing  = MG.awayScore < MG.homeScore;
  const timePct = MG.tick / (MG.maxTick || 1);

  // ‚îÄ‚îÄ üî¥ Faster reaction: minimum 1 fewer tick than Blue ‚îÄ‚îÄ
  const reactBase = Math.max(1, (D.updateEvery||2) - 1);

  // ‚îÄ‚îÄ State decisions ‚îÄ‚îÄ
  awayPlayers.forEach(p => {
    if(p.aiReactTimer > 0){ p.aiReactTimer--; return; }
    p.aiReactTimer = reactBase + Math.floor(Math.random()*2);

    const r          = p._role;
    const distToBall = Math.hypot(p.x-B.x, p.y-B.y);
    const isPresser  = p === ballPresser;
    const isSupport  = p === ballSupport;

    // ‚îÄ‚îÄ üî¥ SWEEPER: permanently on goal-ball line ‚îÄ‚îÄ
    if(p === sweeper){
      p.aiState = 'sweeper';
      return;
    }

    // ‚îÄ‚îÄ GOALKEEPER ‚îÄ‚îÄ
    if(r === 'gk'){
      if(ballNearOurGoal && distToBall < 0.14) p.aiState = 'gk_rush';
      else if(ballInOurHalf)                   p.aiState = 'gk_set';
      else                                     p.aiState = 'gk_idle';
      return;
    }

    // ‚îÄ‚îÄ WE HAVE BALL ‚îÄ‚îÄ
    if(weHaveBall){
      if(r === 'def'){
        // üî¥ Long ball flag: defender touches ball in own half ‚Üí launch to striker
        p._wantsLongBall = D.longBall && ballInOurHalf && striker && striker !== p;
        if(isPresser && losing && timePct > 0.65) p.aiState = 'attack';
        else                                       p.aiState = 'hold';
      } else if(r === 'mid'){
        if(isPresser)      p.aiState = 'attack';
        else if(isSupport) p.aiState = 'support';
        else               p.aiState = 'hold';
      } else if(r === 'fwd'){
        const distToGoal = Math.hypot(p.x-ATTACK_X, p.y-0.5);
        if(isPresser && distToGoal < D.shotRange) p.aiState = 'shoot';
        else if(isPresser)                         p.aiState = 'carry';
        else                                       p.aiState = 'lurk';
      }
      return;
    }

    // ‚îÄ‚îÄ OPPONENT HAS BALL ‚îÄ‚îÄ
    const pressR = D.pressRadius;

    if(ballInOurHalf){
      if(r === 'def'){
        p.aiState = isPresser ? 'press' : 'defend_line';
      } else if(r === 'mid'){
        if(isPresser)                                   p.aiState = 'press';
        else if(isSupport && distToBall < pressR*1.5)   p.aiState = 'cover_zone';
        else                                             p.aiState = 'defend_line';
      } else if(r === 'fwd'){
        p.aiState = 'recover';
      }
      return;
    }

    if(ballNearOurGoal){
      if(r === 'def')      p.aiState = isPresser ? 'press' : 'goal_cover';
      else if(r === 'mid') p.aiState = distToBall < pressR*1.3 ? 'press' : 'goal_cover';
      else if(r === 'fwd') p.aiState = 'recover';
      return;
    }

    // Ball in their half / midfield
    if(r === 'def'){
      p.aiState = 'hold';
    } else if(r === 'mid'){
      // üî¥ Presses from further (pressRadius already 0.42 on hard)
      p.aiState = (isPresser && distToBall < pressR) ? 'press' : 'hold';
    } else if(r === 'fwd'){
      // üî¥ Forwards aggressively press home defenders in their half
      let nearestDef = null, nearestDist = 999;
      homePlayers.forEach(h=>{
        if(h.x > 0.55){
          const d = Math.hypot(h.x-p.x, h.y-p.y);
          if(d < nearestDist){ nearestDist=d; nearestDef=h; }
        }
      });
      p._pressTarget = nearestDef;
      p.aiState = (isPresser || distToBall < pressR*0.85) ? 'fwd_press' : 'lurk';
    }
  });

  // ‚îÄ‚îÄ Movement targets ‚îÄ‚îÄ
  awayPlayers.forEach(p => {
    const distToBall = Math.hypot(p.x-B.x, p.y-B.y);
    const jit = D.dribbleTight || 0.015;   // üî¥ tighter on hard (0.35 scale)
    let tx = p.baseX, ty = p.baseY;

    switch(p.aiState){

      case 'hold':
        tx = p.baseX + rnd(0.022);
        ty = p.baseY + rnd(0.022);
        break;

      case 'press':
        // üî¥ Aim at PREDICTED ball position
        tx = predX + rnd(0.015);
        ty = predY + rnd(0.015);
        break;

      case 'sweeper':
        // üî¥ Always on the line between ball and our goal
        {
          const svdx = B.x - DEFEND_X, svdy = B.y - 0.5;
          const svd  = Math.hypot(svdx, svdy) || 0.001;
          const hold = 0.11;
          tx = DEFEND_X + (svdx/svd)*hold + rnd(0.018);
          ty = 0.5       + (svdy/svd)*hold + rnd(0.018);
          tx = Math.max(DEFEND_X, Math.min(0.34, tx));
          ty = Math.max(0.05, Math.min(0.95, ty));
        }
        break;

      case 'defend_line':
        {
          const lineX = Math.min(p.baseX+0.04, Math.max(DEFEND_X+0.06, B.x-0.10));
          tx = lineX + rnd(0.03);
          ty = p.baseY + (B.y-0.5)*0.15 + rnd(0.04);
        }
        break;

      case 'cover_zone':
        {
          const zx = (B.x+DEFEND_X)*0.5 + rnd(0.04);
          const zy = (B.y+p.baseY)*0.5  + rnd(0.05);
          tx = Math.max(DEFEND_X+0.05, zx);
          ty = Math.max(0.08, Math.min(0.92, zy));
        }
        break;

      case 'goal_cover':
        tx = DEFEND_X + 0.07 + rnd(0.04);
        ty = 0.5 + (p.baseY-0.5)*0.55 + rnd(0.04);
        break;

      case 'gk_rush':
        tx = Math.min(0.17, B.x+0.01) + rnd(0.02);
        ty = B.y + rnd(0.025);
        break;

      case 'gk_set':
        tx = DEFEND_X + 0.10 + rnd(0.02);
        ty = B.y + (0.5-B.y)*0.35 + rnd(0.025);
        break;

      case 'gk_idle':
        tx = DEFEND_X + 0.04 + rnd(0.025);
        ty = 0.5 + rnd(0.10);
        break;

      case 'support':
        {
          let bestX=B.x+0.10, bestY=0.5, best=-9e9;
          const tries = D.updateEvery<=1 ? 9 : 6;
          for(let i=0;i<tries;i++){
            const cx = Math.min(0.94, B.x+0.06+Math.random()*0.22);
            const cy = 0.10+Math.random()*0.80;
            let sc2  = (cx-0.5)*4;
            homePlayers.forEach(h=>{ sc2 -= Math.max(0,0.20-Math.hypot(h.x-cx,h.y-cy))*10; });
            awayPlayers.forEach(a=>{ if(a!==p) sc2 -= Math.max(0,0.11-Math.hypot(a.x-cx,a.y-cy))*7; });
            if(sc2>best){best=sc2;bestX=cx;bestY=cy;}
          }
          tx = bestX+rnd(0.02);
          ty = Math.max(0.06,Math.min(0.94,bestY))+rnd(0.02);
        }
        break;

      case 'attack':
        // üî¥ Move toward predicted ball position
        if(distToBall < 0.14){
          tx = predX + rnd(0.016); ty = predY + rnd(0.020);
        } else {
          tx = Math.min(0.93, B.x+0.09+(p._role==='fwd'?0.05:0))+rnd(0.04);
          ty = p.baseY+(B.y-p.baseY)*0.35+rnd(0.06);
        }
        break;

      case 'carry':
        // üî¥ Tighter dribble ‚Äî jitter scaled down by dribbleTight
        tx = B.x + rnd(jit * 0.6);
        ty = B.y + rnd(jit * 0.6);
        break;

      case 'shoot':
        if(distToBall < 0.16){
          tx = B.x+rnd(jit*0.5); ty = B.y+rnd(jit*0.5);
        } else {
          tx = ATTACK_X-0.08+rnd(0.04);
          ty = 0.5+rnd(0.12);
        }
        break;

      case 'lurk':
        tx = ATTACK_X-0.12-Math.random()*0.09+rnd(0.04);
        ty = p.baseY+rnd(0.09);
        break;

      case 'fwd_press':
        // üî¥ Press home defenders with purpose ‚Äî head straight at them
        if(p._pressTarget){
          tx = p._pressTarget.x + rnd(0.020);
          ty = p._pressTarget.y + rnd(0.020);
        } else {
          tx = predX+rnd(0.020); ty = predY+rnd(0.020);
        }
        break;

      case 'recover':
        tx = p.baseX+rnd(0.018); ty = p.baseY+rnd(0.018);
        break;

      default:
        tx = p.baseX+rnd(0.04); ty = p.baseY+rnd(0.04);
    }

    // Speed
    const chip    = p.lastChip||CHIPS[0];
    const chipSpd = chip.spd||0;
    const sprint  = ['press','recover','gk_rush','fwd_press','sweeper'].includes(p.aiState);
    const idle    = ['hold','gk_idle','defend_line'].includes(p.aiState);
    const spdMult = sprint ? 1.15 : idle ? 0.68 : 1.00;

    const moveSpd = PLAYER_SPEED *
      (0.55 + (p.robot.spd||5)/10 * 0.90) *
      (1.00 + chipSpd/10 * 0.32) *
      D.speedMult * spdMult *
      (MG.isRain ? 0.84 : 1.0);

    const ddx = tx-p.x, ddy = ty-p.y;
    const moveDist = Math.hypot(ddx,ddy);
    if(moveDist > 0.002){
      p.vx = ddx/moveDist * moveSpd;
      p.vy = ddy/moveDist * moveSpd;
    } else {
      p.vx *= 0.55; p.vy *= 0.55;
    }

    p.x += p.vx; p.y += p.vy;

    const canCross = ['attack','carry','shoot','lurk','support','fwd_press'].includes(p.aiState) && B.x > 0.40;
    if(!canCross) p.x = Math.min(0.50, p.x);
    p.x = Math.max(0.02, Math.min(0.98, p.x));
    p.y = Math.max(0.03, Math.min(0.97, p.y));

    p.trail.push({x:p.x,y:p.y});
    if(p.trail.length>10) p.trail.shift();
  });
}

// ‚îÄ‚îÄ üî¥ Red Team kick ‚Äî boss power, tight carry, long ball counter-attack ‚îÄ‚îÄ
function applyAwayAIKick(p, B, nx, ny){
  const D       = getAwayAIDifficulty();
  const ATTACK_X = 0.98;
  const str     = (p.robot.str||5)/10;
  const intl    = (p.robot.int||5)/10;
  const chip    = p.lastChip||CHIPS[0];
  const chipPow = (chip.pow||0)/10;
  const chipSpd = (chip.spd||0)/10;
  const awayPlayers = MG.players.filter(q=>q.team==='away');

  // üî¥ Harder kick ‚Äî kickMult up to 1.22 on hard
  const basePow = KICK_POWER * (0.45 + str*0.85 + chipPow*0.55)
                * (0.82 + D.speedMult*0.18)
                * (D.kickMult || 1.0);
  const kickPow  = basePow * (MG.isRain ? 0.80 : 1.0);

  // üî¥ Better aim ‚Äî aimNoise as low as 0.025 on hard
  const noiseBase = D.aimNoise * (1.0 - intl*0.50) * kickPow * 1.8;

  const state  = p.aiState || 'attack';
  const ballInOurHalf = B.x < 0.50;
  let kickVx, kickVy;

  // ‚îÄ‚îÄ üî¥ LONG BALL: defender wins ball in own half ‚Üí launch to striker ‚îÄ‚îÄ
  if(p._wantsLongBall && (state==='hold'||state==='defend_line'||state==='press'||state==='carry')){
    p._wantsLongBall = false;
    const target = awayPlayers
      .filter(q=>q!==p && q._role!=='gk' && q._role!=='def')
      .reduce((best,q)=> q.baseX > (best?best.baseX:-1) ? q : best, null);
    if(target){
      const toTgtX = target.x - B.x;
      const toTgtY = target.y - B.y;
      const td = Math.hypot(toTgtX, toTgtY)||0.001;
      kickVx = (toTgtX/td) * kickPow * 1.45 + rnd(noiseBase*0.45);
      kickVy = (toTgtY/td) * kickPow * 1.45 + rnd(noiseBase*0.45);
      addLog(`‚ö° ${p.robot.emoji} LONG BALL ‚Üí ${target.robot.emoji}!`,'action');
      B.vx = B.vx*0.08 + kickVx*0.92;
      B.vy = B.vy*0.08 + kickVy*0.92;
      MG.possession = 'away';
      return;
    }
  }

  if(state === 'carry'){
    // Hold ball glued just ahead of player ‚Äî same as home dribble carry
    const moveDir  = Math.atan2(p.vy, p.vx);
    const holdDist = PLAYER_RADIUS + BALL_RADIUS + 0.005;
    B.x = Math.max(0.02, Math.min(0.98, p.x + Math.cos(moveDir)*holdDist));
    B.y = Math.max(0.03, Math.min(0.97, p.y + Math.sin(moveDir)*holdDist));
    B.vx = p.vx * 0.85;
    B.vy = p.vy * 0.85;
    MG.possession = 'away';
    if(Math.hypot(B.x-ATTACK_X, B.y-0.5) < D.shotRange*0.85){
      p.aiState = 'shoot';
      addLog(`${chip.icon} ${p.robot.emoji} drives in... üî¥ SHOT!`,'action');
    }
    return;

  } else if(state === 'shoot'){
    const toGoalX = ATTACK_X - B.x, toGoalY = 0.5 - B.y;
    const gd = Math.hypot(toGoalX, toGoalY*0.5)||0.001;
    // üî¥ Boss shot: 1.40√ó multiplier on top of kickMult already baked in
    kickVx = (toGoalX/gd)*kickPow*1.40 + rnd(noiseBase*0.50);
    kickVy = (toGoalY*0.5/gd)*kickPow  + rnd(noiseBase*0.75);
    if(Math.random()<0.35) addLog(`${chip.icon} ${p.robot.emoji} üî¥ FIRES!`,'action');
    if(Math.random()>0.08) MG.possession='away';

  } else if(state === 'lurk'){
    const toGoalX = ATTACK_X - B.x, toGoalY = 0.5 - B.y;
    const gd = Math.hypot(toGoalX, toGoalY*0.4)||0.001;
    kickVx = (toGoalX/gd)*kickPow*1.22 + rnd(noiseBase*0.72);
    kickVy = (toGoalY*0.4/gd)*kickPow  + rnd(noiseBase*0.78);
    if(Math.random()>0.08) MG.possession='away';

  } else if(state === 'attack'){
    kickVx = kickPow*(0.76+chipSpd*0.18) + nx*kickPow*0.22 + rnd(noiseBase*0.78);
    kickVy = ny*kickPow*0.18 + (0.5-B.y)*kickPow*0.10 + rnd(noiseBase*0.92);
    if(Math.random()>0.08) MG.possession='away';

  } else if(state === 'support'){
    kickVx = kickPow*0.52 + rnd(noiseBase*0.48);
    kickVy = ny*kickPow*0.18 + rnd(noiseBase*0.58);
    if(Math.random()>0.08) MG.possession='away';

  } else if(['press','defend_line','cover_zone','goal_cover','sweeper'].includes(state)){
    // Smart clear: on long ball difficulty, pass to teammate; otherwise just boot it
    const fwdTarget = D.longBall
      ? awayPlayers.filter(q=>q!==p&&q._role!=='gk'&&q.x>B.x).sort((a,b)=>b.x-a.x)[0]
      : null;
    if(fwdTarget){
      const ttx = fwdTarget.x-B.x, tty = fwdTarget.y-B.y;
      const td = Math.hypot(ttx,tty)||0.001;
      kickVx = (ttx/td)*kickPow*1.12 + rnd(noiseBase*0.65);
      kickVy = (tty/td)*kickPow*1.12 + rnd(noiseBase*0.65);
    } else {
      kickVx = kickPow*(0.84+chipPow*0.10) + rnd(noiseBase*0.70);
      kickVy = (0.5-B.y)*kickPow*0.20    + rnd(noiseBase*1.20);
    }
    if(Math.random()>0.08) MG.possession='away';

  } else if(state==='gk_rush'||state==='gk_set'){
    kickVx = kickPow*0.72 + rnd(noiseBase*0.42);
    kickVy = (0.5-B.y)*kickPow*0.28 + rnd(noiseBase*0.85);
    if(Math.random()>0.08) MG.possession='away';

  } else {
    kickVx = kickPow*0.62 + rnd(noiseBase*0.88);
    kickVy = ny*kickPow*0.22 + rnd(noiseBase*0.88);
    if(Math.random()>0.08) MG.possession='away';
  }

  B.vx = B.vx*0.10 + kickVx*0.90;
  B.vy = B.vy*0.10 + kickVy*0.90;
}


function tickMatch(){
  if(MG.phase==='ended')return;
  MG.tick++;
  MG.elapsedSec=MG.tick/60;
  if(MG.goalCooldown>0)MG.goalCooldown--;

  const B=MG.ball;

  // ‚îÄ‚îÄ 1. Chip execution timer & role assignment ‚îÄ‚îÄ
  // Each player has a role derived from their BASE position:
  //   Defender:   deepest 30% of their half (far from midline)
  //   Midfielder: middle 40% of their half
  //   Attacker:   closest 30% of their half to midline
  // This role is FIXED by formation placement and doesn't change mid-match.
  // Chips MODIFY BEHAVIOUR within that role rather than override it entirely.

  // Pre-compute team context once per tick
  const teamBall={};  // which team is closest to ball
  ['home','away'].forEach(team=>{
    const ps=MG.players.filter(p=>p.team===team);
    let minD=999,closest=null;
    ps.forEach(p=>{const d=Math.hypot(p.x-B.x,p.y-B.y);if(d<minD){minD=d;closest=p;}});
    teamBall[team]={closest,minDist:minD};
  });

  // Run away team through their own tactical AI (not chip movement)
  tickAwayAI();

  // Away players also still advance their chip program (for logging / kick physics)
  MG.players.filter(p=>p.team==='away').forEach(p=>{
    p.chipTimer--;
    if(p.chipTimer<=0){
      p.chipTimer=Math.max(20,90-((p.robot.spd||5)*6))+Math.floor(Math.random()*30);
      p.lastChip=resolveChip(p);
    }
  });

  // Home players use chip-driven movement
  MG.players.filter(p=>p.team==='home').forEach(p=>{
    // Chip timer ‚Äî fires at a rate based on robot SPEED stat
    p.chipTimer--;
    if(p.chipTimer<=0){
      p.chipTimer=Math.max(20,90-((p.robot.spd||5)*6))+Math.floor(Math.random()*30);
      p.lastChip=resolveChip(p);
    }

    const chip=p.lastChip||CHIPS[0];
    const isHome=true;  // this forEach is home-only

    // Directional constants ‚Äî home attacks LEFT goal (x=0)
    const attackGoalX = 0.02;
    const defendGoalX = 0.98;
    const attackDir   = -1;  // leftward

    // Role derived from base X position within team's half
    // Home half is x>0.5: deepest defender is near x=0.98, attacker near x=0.52
    let roleScore = 1 - ((p.baseX - 0.5) / 0.48); // x=0.98‚Üí0, x=0.52‚Üí~1
    roleScore = Math.max(0, Math.min(1, roleScore));
    const isDefender   = roleScore < 0.33;
    const isMidfielder = roleScore >= 0.33 && roleScore < 0.67;
    const isAttacker   = roleScore >= 0.67;

    const distToBall = Math.hypot(p.x-B.x, p.y-B.y);
    const ballInMyHalf = B.x > 0.5;
    const amClosest = (teamBall[p.team].closest === p);
    const myTeamHasBall = (MG.possession === p.team);

    // Chip stat bonuses ‚Äî these are REAL modifiers on behaviour
    const chipSpd  = chip.spd || 0;
    const chipPow  = chip.pow || 0;
    const chipDef  = chip.def || 0;
    const robotSpd = p.robot.spd || 5;
    const robotStr = p.robot.str || 5;
    const robotInt = p.robot.int || 5;

    // ‚îÄ‚îÄ MOVEMENT TARGET LOGIC ‚îÄ‚îÄ
    // Each chip category produces genuinely different spatial behaviour.
    let tx = p.baseX, ty = p.baseY;

    // ‚îÄ‚îÄ üèÉ GO TO ENEMY GOAL block: override all chip logic ‚Äî sprint to goal mouth ‚îÄ‚îÄ
    if(p._goalRun){
      p._goalRun = false;
      // Home attacks left goal at x‚âà0.02, y=0.5
      tx = attackGoalX + 0.06 + rnd(0.04);
      ty = 0.5 + rnd(0.18);
      // Apply movement immediately and skip chip movement switch
      const goalSpd = PLAYER_SPEED * (0.5 + (robotSpd/10)*1.0) * 1.35 * (MG.isRain ? 0.82 : 1.0);
      const gdx = tx-p.x, gdy = ty-p.y, gdist = Math.hypot(gdx,gdy);
      if(gdist>0.002){ p.vx=(gdx/gdist)*goalSpd; p.vy=(gdy/gdist)*goalSpd; }
      p.x+=p.vx; p.y+=p.vy;
      p.x=Math.max(0.02,Math.min(0.98,p.x)); p.y=Math.max(0.03,Math.min(0.97,p.y));
      p.trail.push({x:p.x,y:p.y}); if(p.trail.length>10)p.trail.shift();
      return;  // skip all chip movement logic
    }

    if(chip.cat === 'defend'){
      // DEFEND chips: Stay disciplined. Press hard if chip is aggressive (high chipDef+chipSpd).
      // High-press chips (d04 High Press, d06 Interception) move toward ball actively.
      // Holding chips (d09 Park Bus, d12 Shield) stay in a compact block near own goal.
      const pressRadius = 0.1 + (chipSpd / 10) * 0.25;  // how far they press
      const isHighPress = chip.id==='d04'||chip.id==='d06'||chip.id==='d11';
      const isHolding   = chip.id==='d03'||chip.id==='d09'||chip.id==='d12'||chip.id==='d08';

      if(isHolding){
        // Compact block: hold deep near own goal (home goal is right side x~0.98)
        const blockX = 0.72 + p.baseY*0.04;
        tx = blockX + rnd(0.03);
        ty = p.baseY + rnd(0.03);
      } else if(chip.id === 'd13'){
        // ‚îÄ‚îÄ GO TO GOAL: sprint straight back and stand in the goal mouth ‚îÄ‚îÄ
        // Position on the line between the ball and the centre of own goal,
        // standing just in front of the goal line. Moves with ball angle.
        const goalX = defendGoalX;  // home goal is right side x‚âà0.98
        const goalY = 0.5;
        // Stand on the ball-to-goal line, offset inward by ~0.08
        const dx = goalX - B.x, dy = goalY - B.y;
        const dist = Math.hypot(dx, dy) || 0.001;
        const guardDist = 0.08;  // distance in front of goal line
        tx = goalX - (dx/dist)*guardDist + rnd(0.02);
        ty = goalY - (dy/dist)*guardDist + rnd(0.04);
        // If ball is very close and no team-mate is between ‚Äî press it
        if(distToBall < 0.14 && amClosest){
          tx = B.x + rnd(0.02);
          ty = B.y + rnd(0.02);
        }
      } else if(isHighPress || (!myTeamHasBall && distToBall < pressRadius + 0.15)){
        // Press the ball carrier
        tx = B.x + rnd(0.03);
        ty = B.y + rnd(0.03);
      } else if(ballInMyHalf){
        // Ball is in our half: close down but don't overcommit
        const t = 0.4 + (chipDef/10)*0.3;
        tx = p.baseX + (B.x - p.baseX)*t + rnd(0.04);
        ty = p.baseY + (B.y - p.baseY)*t + rnd(0.04);
      } else {
        // Hold position
        tx = p.baseX + rnd(0.04);
        ty = p.baseY + rnd(0.04);
      }

    } else if(chip.cat === 'attack'){
      // ATTACK chips: Move toward goal or into shooting positions.
      // Power shots (a01, a05, a12) position for a shot ‚Äî close to goal.
      // Dribble chips (a02, a09) stay glued to ball.
      // Cross chips (a06) move wide and toward byline.
      // Header chips (a04) move to penalty box area.
      const shotChips   = ['a01','a05','a10','a11','a12','a14','s01','s09'];
      const dribbleChips= ['a02','a09','t05','t01','t02'];
      const crossChips  = ['a06','m02'];
      const headerChips = ['a04','s10'];

      if(dribbleChips.includes(chip.id)){
        // Chase the ball ‚Äî it just got tapped ahead, so run onto it
        // Slightly ahead of current ball pos toward goal to intercept next touch
        tx = B.x + attackDir*0.05 + rnd(0.04);
        ty = B.y + rnd(0.05);
      } else if(crossChips.includes(chip.id)){
        // Wide wing position, push toward byline (home attacks left so byline is x~0.08)
        const wingY = p.baseY < 0.5 ? 0.15 : 0.85;
        tx = 0.12 + rnd(0.05);
        ty = wingY + rnd(0.06);
      } else if(headerChips.includes(chip.id)){
        // Move into penalty box for aerial ball (home pen box is left side)
        tx = 0.08 + rnd(0.06);
        ty = 0.5 + rnd(0.2);
      } else if(shotChips.includes(chip.id)){
        // Position for shot: get in front of goal
        if(amClosest || distToBall < 0.2){
          tx = attackGoalX + (isHome ? 0.1 : -0.1) + rnd(0.05);
          ty = 0.5 + rnd(0.15);
        } else {
          tx = B.x + attackDir*0.05 + rnd(0.05);
          ty = B.y + rnd(0.08);
        }
      } else {
        // Generic attack: pressure ball or support
        if(amClosest || distToBall < 0.15){
          tx = B.x + rnd(0.03);
          ty = B.y + rnd(0.04);
        } else if(myTeamHasBall){
          // Support run: get ahead of ball toward goal
          tx = B.x + attackDir*(0.06 + (chipPow/10)*0.08) + rnd(0.06);
          ty = B.y + rnd(0.1);
        } else {
          // Recover back
          tx = p.baseX + rnd(0.06);
          ty = p.baseY + rnd(0.06);
        }
      }

    } else if(chip.cat === 'move'){
      // MOVE chips: Positional/passing play. Based on chip type:
      // Sprint/Counter (m01, m08): charge forward if we have ball
      // Short Pass (m06): stay safe, don't overextend
      // Through Ball (m03): run in behind
      // Wide run (m02): spread to wings
      // Overlap (m05): fullback runs forward when team has ball
      const sprintChips  = ['m01','m08'];
      const goToBallChip = chip.id === 'm13';
      const safeChips    = ['m06','m10','m12'];
      const throughChips = ['m03','m07'];
      const wideChips    = ['m02','m05'];

      if(goToBallChip){
        // Go to Ball: rush directly to ball ‚Äî the kick handler will carry it gently
        tx = B.x + rnd(0.015);
        ty = B.y + rnd(0.015);
        p._carrying = amClosest && distToBall < 0.10;
      } else if(sprintChips.includes(chip.id) && myTeamHasBall){
        // Charge forward to create overload
        tx = B.x + attackDir*(0.08+(chipSpd/10)*0.1) + rnd(0.04);
        ty = B.y + rnd(0.08);
      } else if(safeChips.includes(chip.id)){
        // Hold shape, don't advance
        tx = p.baseX + rnd(0.05);
        ty = p.baseY + rnd(0.05);
      } else if(throughChips.includes(chip.id) && myTeamHasBall){
        // Run in behind: dash to the space behind the defensive line (home attacks left)
        tx = 0.18 + rnd(0.06);
        ty = 0.3 + Math.random()*0.4;
      } else if(wideChips.includes(chip.id)){
        // Spread play wide
        const wingY = p.baseY < 0.5 ? 0.15 : 0.85;
        tx = B.x + attackDir*(0.03) + rnd(0.04);
        ty = wingY + rnd(0.08);
      } else {
        // Default: track ball loosely based on role
        if(isAttacker){
          tx = B.x + attackDir*(0.04) + rnd(0.06);
          ty = B.y + rnd(0.1);
        } else if(isMidfielder){
          // Midfielders: stay between ball and their base position
          const t = myTeamHasBall ? 0.5 : 0.25;
          tx = p.baseX + (B.x - p.baseX)*t + rnd(0.05);
          ty = p.baseY + (B.y - p.baseY)*t + rnd(0.05);
        } else {
          // Defenders: hold shape, only advance if ball is far away
          tx = p.baseX + rnd(0.05);
          ty = p.baseY + rnd(0.05);
        }
      }

    } else if(chip.cat === 'special'){
      // SPECIAL chips: dramatic committed actions
      // Turbo Burst (s04): pure speed dash at ball
      // Berserk (s05): charge regardless of position
      // Super Shot / Dragon Shot: get into shooting lane NOW
      const turboChips = ['s04','s02','s06'];
      const shotChips  = ['s01','s09','s10'];

      if(turboChips.includes(chip.id)){
        // Raw speed dash toward ball
        tx = B.x + rnd(0.02);
        ty = B.y + rnd(0.02);
      } else if(shotChips.includes(chip.id)){
        // Get into prime shooting position
        tx = attackGoalX + (isHome ? 0.12 : -0.12) + rnd(0.04);
        ty = 0.5 + rnd(0.12);
      } else {
        // Default special: aggressive forward run
        tx = B.x + attackDir*(0.05) + rnd(0.04);
        ty = B.y + rnd(0.06);
      }

    } else if(chip.cat === 'support'){
      // SUPPORT chips: team tactical positioning
      // Team Press (p01): whole team closes in
      // Long Ball (p05): players run long to receive
      // False Nine (p04): striker drops to midfield to confuse
      // Tempo/Possession chips: hold position, don't rush
      const pressChips  = ['p01'];
      const longChips   = ['p05'];
      const holdChips   = ['p03','p07','p09','p10'];
      const falseNineId = 'p04';

      if(pressChips.includes(chip.id)){
        // Every player presses toward ball
        tx = B.x + rnd(0.05);
        ty = B.y + rnd(0.05);
      } else if(holdChips.includes(chip.id)){
        tx = p.baseX + rnd(0.04);
        ty = p.baseY + rnd(0.04);
      } else if(chip.id===falseNineId && isAttacker){
        // Attacker drops into midfield (home: toward higher x = deeper)
        const dropX = p.baseX + 0.12;
        tx = dropX + rnd(0.05);
        ty = 0.5 + rnd(0.15);
      } else if(longChips.includes(chip.id) && myTeamHasBall){
        // Run long ball channel
        tx = attackGoalX + (isHome ? 0.2 : -0.2) + rnd(0.05);
        ty = 0.2 + Math.random()*0.6;
      } else {
        // Default support: stay in shape, slight ball awareness
        const t = isMidfielder ? 0.3 : 0.15;
        tx = p.baseX + (B.x - p.baseX)*t + rnd(0.05);
        ty = p.baseY + (B.y - p.baseY)*t + rnd(0.05);
      }

    } else if(chip.cat === 'trick'){
      // TRICK chips: unpredictable, random-ish movement
      // This is intentionally somewhat chaotic
      if(amClosest || distToBall < 0.12){
        // Near ball: erratic weave
        tx = B.x + rnd(0.10);
        ty = B.y + rnd(0.10);
      } else {
        // Create space: move to unexpected position
        tx = B.x + attackDir*(0.04+Math.random()*0.12) + rnd(0.08);
        ty = 0.1 + Math.random()*0.8;
      }
    } else {
      // Fallback
      tx = p.baseX + rnd(0.05);
      ty = p.baseY + rnd(0.05);
    }

    // ‚îÄ‚îÄ SPEED: robot SPD stat + chip SPD modifier are REAL ‚îÄ‚îÄ
    // Base speed √ó robot stat scaling √ó chip bonus
    const moveSpd = PLAYER_SPEED *
      (0.5 + (robotSpd/10)*1.0) *          // robot SPD: 50%‚Äì150% speed
      (1.0 + (chipSpd/10)*0.6) *            // chip SPD: up to +60%
      (MG.isRain ? 0.82 : 1.0);

    const dx = tx - p.x, dy = ty - p.y;
    const dist = Math.hypot(dx, dy);
    if(dist > 0.002){
      p.vx = (dx/dist) * moveSpd;
      p.vy = (dy/dist) * moveSpd;
    } else {
      p.vx *= 0.6;
      p.vy *= 0.6;
    }

    // Apply velocity
    p.x += p.vx;
    p.y += p.vy;

    // Half-clamp: only home DEFENDERS stay back, and only when it's not an emergency
    // Attackers and midfielders can cross freely ‚Äî no restriction at all
    // Defenders cross only when ball is near their goal (x > 0.80 = danger zone)
    const ballNearHomeGoal = MG.ball.x > 0.80;
    const defenderShouldStay = isDefender && !ballNearHomeGoal;
    if(defenderShouldStay) p.x = Math.max(0.50, p.x);
    p.x = Math.max(0.02, Math.min(0.98, p.x));
    p.y = Math.max(0.03, Math.min(0.97, p.y));

    // Trail
    p.trail.push({x:p.x, y:p.y});
    if(p.trail.length > 10) p.trail.shift();
  });

  // ‚îÄ‚îÄ 2. Player‚ÜîPlayer collision ‚îÄ‚îÄ
  for(let i=0;i<MG.players.length;i++){
    for(let j=i+1;j<MG.players.length;j++){
      const a=MG.players[i],b=MG.players[j];
      const dx=a.x-b.x, dy=a.y-b.y;
      const dist=Math.hypot(dx,dy);
      const minD=PLAYER_RADIUS*2;
      if(dist<minD&&dist>0.0001){
        const overlap=(minD-dist)/2;
        const nx=dx/dist, ny=dy/dist;
        a.x+=nx*overlap; a.y+=ny*overlap;
        b.x-=nx*overlap; b.y-=ny*overlap;
      }
    }
  }

  // ‚îÄ‚îÄ 3. Player‚ÜîBall collision ‚Äî chips and stats drive REAL kick physics ‚îÄ‚îÄ
  MG.players.forEach(p=>{
    const dx=B.x-p.x, dy=B.y-p.y;
    const dist=Math.hypot(dx,dy);
    const minD=PLAYER_RADIUS+BALL_RADIUS;
    if(dist<minD&&dist>0.0001){
      // Positional separation
      const overlap=minD-dist;
      const nx=dx/dist, ny=dy/dist;
      B.x+=nx*overlap*0.8;
      B.y+=ny*overlap*0.8;
      p.x-=nx*overlap*0.2;
      p.y-=ny*overlap*0.2;

      // Away players: use tactical AI kick function (difficulty-aware)
      if(p.team==='away'){
        applyAwayAIKick(p, B, nx, ny);
        return;
      }

      const chip    = p.lastChip||CHIPS[0];
      const isHome  = true;  // this branch is home-only now
      const attackGoalX = 0.0;
      const attackDir   = -1;

      // Robot stats as 0‚Äì1 scalars
      const str = (p.robot.str||5)/10;  // affects kick power
      const spd = (p.robot.spd||5)/10;  // affects reaction speed (already in movement)
      const intl= (p.robot.int||5)/10;  // affects aim precision

      // Chip power and category determine kick force and direction quality
      const chipPow  = (chip.pow||0)/10;
      const chipSpd  = (chip.spd||0)/10;
      const chipDef  = (chip.def||0)/10;

      // ‚îÄ‚îÄ KICK FORCE: STR + chip.pow ‚îÄ‚îÄ
      const basePower = KICK_POWER * (0.4 + str*0.9 + chipPow*0.7);
      const rainPenalty = MG.isRain ? 0.78 : 1.0;
      const kickPow = basePower * rainPenalty;

      // ‚îÄ‚îÄ AIM: INT + chip type determines how precisely we aim ‚îÄ‚îÄ
      // High int / special chips ‚Üí aimed shot at goal center
      // Low int / trick chips ‚Üí more random
      const aimQuality = Math.min(1, intl*0.7 + chipPow*0.3 + (chip.cat==='attack'?0.2:0) + (chip.cat==='special'?0.25:0));
      const scatter = (1-aimQuality) * kickPow * 1.8;  // noise on kick direction

      // ‚îÄ‚îÄ üéØ SHOOT AT GOAL block: override everything ‚Äî fire directly at goal ‚îÄ‚îÄ
      if(p._shootNow){
        p._shootNow = false;
        const toGoalX = attackGoalX - B.x;
        const toGoalY = 0.5 - B.y;
        const gd = Math.hypot(toGoalX, toGoalY*0.5)||0.001;
        // Full power aimed shot, minimal scatter (uses INT for precision)
        const shotPow = KICK_POWER * (0.55 + str*1.0 + chipPow*0.5) * rainPenalty;
        B.vx = (toGoalX/gd)*shotPow*1.35 + rnd(scatter*0.35);
        B.vy = (toGoalY*0.5/gd)*shotPow   + rnd(scatter*0.40);
        MG.possession = p.team;
        return;
      }

      // ‚îÄ‚îÄ DRIBBLE MODE: a02, a09, m13 ‚Äî ball held close to player (carry, not kick) ‚îÄ‚îÄ
      // The ball is repositioned just ahead of the player each touch and its
      // velocity is almost fully killed ‚Äî it moves WITH the player, not away from them.
      // Enemies can still steal: collision physics still runs, so if an opponent
      // contacts the ball the separation force will break the hold naturally.
      const isDribbleCarry = chip.id==='m13' || chip.id==='a02' || chip.id==='a09';
      if(isDribbleCarry){
        // Offset ball to sit just in front of player in their movement direction
        const moveDir  = Math.atan2(p.vy, p.vx);               // which way player is moving
        const holdDist = PLAYER_RADIUS + BALL_RADIUS + 0.005;  // snug against body
        const bx = p.x + Math.cos(moveDir) * holdDist;
        const by = p.y + Math.sin(moveDir) * holdDist;

        // Clamp to field
        B.x = Math.max(0.02, Math.min(0.98, bx));
        B.y = Math.max(0.03, Math.min(0.97, by));

        // Kill ball velocity almost entirely ‚Äî it travels with the player
        B.vx = p.vx * 0.85;
        B.vy = p.vy * 0.85;

        // Auto-shoot when close to enemy goal
        const distToGoalNow = Math.hypot(B.x-attackGoalX, B.y-0.5);
        if(distToGoalNow < 0.20){
          const toGoalX2 = attackGoalX - B.x;
          const toGoalY2 = 0.5 - B.y;
          const gd2 = Math.hypot(toGoalX2, toGoalY2*0.4)||0.001;
          B.vx = (toGoalX2/gd2)*kickPow*1.30 + rnd(scatter*0.5);
          B.vy = (toGoalY2*0.4/gd2)*kickPow   + rnd(scatter*0.6);
          if(Math.random()<0.3) addLog(`${chip.icon} ${p.robot.emoji} dribbles in... SHOOTS!`,'action');
        }

        if(Math.random()>0.12) MG.possession=p.team;
        if(Math.random()<0.04) addLog(`${chip.icon} ${p.robot.emoji} ${chip.name}!`,'action');
        p._didCarry = true;
      }

      // ‚îÄ‚îÄ DIRECTION: depends on chip category ‚îÄ‚îÄ
      if(p._didCarry){ p._didCarry=false; }
      else {
      let kickVx, kickVy;

      if(chip.cat==='defend'){
        // Defend chips: clear the ball AWAY from own goal (kick toward midfield/forward)
        // Clearance chips kick harder but less aimed; Interception chips are precise
        const clearDir = attackDir;  // clear toward opponent's side
        const clearPow = kickPow * (0.8 + chipDef*0.4);
        kickVx = clearDir * clearPow + rnd(scatter * 0.8);
        kickVy = (0.5 - B.y) * clearPow * 0.3 + rnd(scatter);
        // Park-the-bus chips: just kick it out wide, not toward goal
        if(chip.id==='d09'||chip.id==='d12'||chip.id==='d08'){
          kickVx = clearDir * clearPow * 1.2 + rnd(scatter);
          kickVy = (Math.random() > 0.5 ? 1 : -1) * clearPow * 0.5 + rnd(scatter*0.5);
        }

      } else if(chip.cat==='attack'){
        // Attack chips: aimed at goal, power from chip.pow + str
        const toGoalX = attackGoalX - B.x;
        const toGoalY = 0.5 - B.y;
        const goalDist = Math.hypot(toGoalX, toGoalY*0.4) || 0.001;

        // Shot chips hit hard toward goal
        const isShotChip = ['a01','a05','a10','a12','a14'].includes(chip.id);
        const isDribble  = ['a02','a09'].includes(chip.id);

        if(isShotChip){
          // Powerful direct shot at goal mouth
          kickVx = (toGoalX/goalDist)*kickPow*1.3 + rnd(scatter*0.5);
          kickVy = (toGoalY*0.4/goalDist)*kickPow + rnd(scatter*0.6);
        } else if(isDribble){
          // Dribble: gentle directional tap, keep ball close
          kickVx = attackDir * kickPow * 0.4 + nx*kickPow*0.3 + rnd(scatter*0.4);
          kickVy = ny*kickPow*0.3 + rnd(scatter*0.5);
        } else if(chip.id==='a06'){
          // Low cross: lateral ball into box
          kickVx = (toGoalX/goalDist)*kickPow*0.9 + rnd(scatter*0.4);
          kickVy = (p.baseY<0.5?1:-1)*kickPow*0.7 + rnd(scatter*0.3);
        } else if(chip.id==='a04'){
          // Header: angled downward into goal
          kickVx = (toGoalX/goalDist)*kickPow*1.1 + rnd(scatter*0.5);
          kickVy = (toGoalY/Math.max(0.1,Math.abs(toGoalY)))*kickPow*0.4 + rnd(scatter*0.4);
        } else {
          // Generic attack: toward goal with moderate scatter
          kickVx = (toGoalX/goalDist)*kickPow + nx*kickPow*0.3 + rnd(scatter*0.6);
          kickVy = (toGoalY*0.3/goalDist)*kickPow + ny*kickPow*0.2 + rnd(scatter*0.7);
        }

      } else if(chip.cat==='move'){
        // Move chips: directional passes and runs
        const isSprint  = ['m01','m08'].includes(chip.id);
        const isLofted  = chip.id==='m04';
        const isRecycle = ['m06','m10','m12'].includes(chip.id);

        if(isSprint){
          // Sprint/counter: powerful forward ball
          kickVx = attackDir * kickPow * (1.0 + chipSpd*0.5) + rnd(scatter*0.4);
          kickVy = (0.5-B.y)*kickPow*0.2 + rnd(scatter*0.5);
        } else if(isLofted){
          // Lofted pass: high kick, moderate power
          kickVx = attackDir * kickPow * 0.9 + rnd(scatter*0.5);
          kickVy = rnd(kickPow*0.4);
        } else if(isRecycle){
          // Short pass: gentle touch, controlled
          kickVx = attackDir * kickPow * 0.35 + rnd(scatter*0.3);
          kickVy = rnd(scatter*0.4);
        } else {
          // General move: forward-biased kick
          kickVx = attackDir * kickPow * 0.75 + nx*kickPow*0.2 + rnd(scatter*0.6);
          kickVy = ny*kickPow*0.2 + rnd(scatter*0.6);
        }

      } else if(chip.cat==='special'){
        // Special chips: maximum power or special effects
        const toGoalX = attackGoalX - B.x;
        const toGoalY = 0.5 - B.y;
        const goalDist = Math.hypot(toGoalX, toGoalY*0.4) || 0.001;
        const specialPow = kickPow * (1.4 + chipPow*0.4);  // extra power

        if(chip.id==='s04'||chip.id==='s02'){
          // Turbo burst: just blast it forward with speed
          kickVx = attackDir * specialPow * 1.2 + rnd(scatter*0.3);
          kickVy = rnd(scatter*0.5);
        } else if(chip.id==='s06'){
          // Curveball: veering shot
          kickVx = (toGoalX/goalDist)*specialPow + rnd(scatter*0.4);
          kickVy = (toGoalY*0.4/goalDist)*specialPow + (p.baseY<0.5?1:-1)*specialPow*0.3;
        } else {
          // Super shot, dragon shot, etc: aimed blast at goal
          kickVx = (toGoalX/goalDist)*specialPow*1.1 + rnd(scatter*0.25);
          kickVy = (toGoalY*0.4/goalDist)*specialPow + rnd(scatter*0.3);
        }

      } else if(chip.cat==='trick'){
        // Trick chips: unpredictable kicks, sometimes brilliant, sometimes wild
        const coinFlip = Math.random();
        const toGoalX  = attackGoalX - B.x;
        const toGoalY  = 0.5 - B.y;
        const goalDist = Math.hypot(toGoalX,toGoalY)||0.001;
        if(coinFlip > 0.55){
          // Lucky strike: aimed at goal
          kickVx = (toGoalX/goalDist)*kickPow*(1.0+coinFlip*0.5) + rnd(scatter*0.8);
          kickVy = (toGoalY/goalDist)*kickPow*0.4 + rnd(scatter);
        } else {
          // Wild: completely random direction with full power
          const a = Math.random()*Math.PI*2;
          kickVx = Math.cos(a)*kickPow + rnd(scatter);
          kickVy = Math.sin(a)*kickPow + rnd(scatter);
        }

      } else if(chip.cat==='support'){
        // Support chips: positional passes, generally safe
        kickVx = attackDir * kickPow * 0.6 + nx*kickPow*0.2 + rnd(scatter*0.5);
        kickVy = ny*kickPow*0.2 + rnd(scatter*0.5);

      } else {
        // Fallback
        kickVx = nx * kickPow + rnd(scatter*0.5);
        kickVy = ny * kickPow + rnd(scatter*0.5);
      }

      // Blend with existing ball velocity (80% kick, 20% existing momentum)
      B.vx = B.vx*0.2 + kickVx*0.8;
      B.vy = B.vy*0.2 + kickVy*0.8;
      } // end non-carry kick

      // Possession: player touching ball = their team
      if(Math.random() > 0.12) MG.possession = p.team;

      // Log interesting kicks
      if((Math.abs(B.vx)>0.018||chipPow>0.5) && Math.random()<0.15){
        addLog(`${chip.icon} ${p.robot.emoji} ${chip.name}!`, 'action');
      }
    }
  });

  // ‚îÄ‚îÄ 4. Ball physics ‚îÄ‚îÄ
  const friction=MG.isRain?RAIN_FRICTION:BALL_FRICTION;
  B.x+=B.vx;
  B.y+=B.vy;
  B.vx*=friction;
  B.vy*=friction;

  // Top/bottom wall bounce
  if(B.y-BALL_RADIUS<0.03){B.y=0.03+BALL_RADIUS;B.vy=Math.abs(B.vy)*BALL_BOUNCE;}
  if(B.y+BALL_RADIUS>0.97){B.y=0.97-BALL_RADIUS;B.vy=-Math.abs(B.vy)*BALL_BOUNCE;}

  // Left/right wall (excluding goal mouth)
  // HOME spawns RIGHT, attacks LEFT goal (x=0) ‚Üí home scores when ball enters left goal
  // AWAY spawns LEFT, attacks RIGHT goal (x=1) ‚Üí away scores when ball enters right goal
  const goalTop=0.38, goalBot=0.62;
  if(B.x-BALL_RADIUS<0.02){
    if(B.y>goalTop&&B.y<goalBot){
      // Ball in LEFT goal ‚Üí HOME scores (home attacked this goal)
      if(MG.goalCooldown===0){MG.homeScore++;document.getElementById('hudSH').textContent=MG.homeScore;onGoal('home');}
    } else {
      B.x=0.02+BALL_RADIUS;B.vx=Math.abs(B.vx)*BALL_BOUNCE;
    }
  }
  if(B.x+BALL_RADIUS>0.98){
    if(B.y>goalTop&&B.y<goalBot){
      // Ball in RIGHT goal ‚Üí AWAY scores (away attacked this goal)
      if(MG.goalCooldown===0){MG.awayScore++;document.getElementById('hudSA').textContent=MG.awayScore;onGoal('away');}
    } else {
      B.x=0.98-BALL_RADIUS;B.vx=-Math.abs(B.vx)*BALL_BOUNCE;
    }
  }

  // Ball trail
  B.trail.push({x:B.x,y:B.y});
  if(B.trail.length>14)B.trail.shift();

  // ‚îÄ‚îÄ 5. Particles ‚îÄ‚îÄ
  MG.particles=MG.particles.filter(p=>{p.life--;p.x+=p.vx;p.y+=p.vy;p.vy+=.00055;return p.life>0;});

  // ‚îÄ‚îÄ 6. HUD ‚îÄ‚îÄ
  document.getElementById('hudPH').textContent=MG.possession==='home'?'‚óè possession':'';
  document.getElementById('hudPA').textContent=MG.possession==='away'?'possession ‚óè':'';
  const secLeft=Math.max(0,MS.duration-Math.floor(MG.elapsedSec));
  document.getElementById('hudTime').innerHTML=`${secLeft}s <span class="live-dot">üî¥</span>`;
  document.getElementById('hudPeriodBadge').textContent=`P${MG.period}/${MG.maxPeriods}`;

  // ‚îÄ‚îÄ 7. Log flush ‚îÄ‚îÄ
  MG.logFlush++;
  if(MG.logFlush%4===0&&MG.pendingLog.length){
    const el=document.getElementById('matchLog');
    MG.pendingLog.splice(0,4).forEach(({msg,type})=>{
      const d=document.createElement('div');d.className=`le le-${type}`;d.textContent=msg;
      el.insertBefore(d,el.firstChild);if(el.children.length>80)el.removeChild(el.lastChild);
    });
    MG.pendingLog=[];
  }

  if(MG.tick>=MG.maxTick)endPeriod();
}

function addLog(msg,type){
  if(type==='info'||type==='goal'){
    const el=document.getElementById('matchLog');
    const d=document.createElement('div');d.className=`le le-${type}`;d.textContent=msg;
    el.insertBefore(d,el.firstChild);return;
  }
  if(!MG.pendingLog)MG.pendingLog=[];
  MG.pendingLog.push({msg,type});
}

function onGoal(team){
  MG.goalCooldown=90; // ~1.5s cooldown
  const scorer=MG.players.filter(p=>p.team===team)
    .sort((a,b)=>Math.hypot(a.x-MG.ball.x,a.y-MG.ball.y)-Math.hypot(b.x-MG.ball.x,b.y-MG.ball.y))[0];
  const sn=scorer?`${scorer.robot.emoji} ${scorer.robot.name}`:'';
  addLog(`‚öΩ GOAL! ${sn} ‚Äî ${team==='home'?MG.homeName:MG.awayName} scores!`,'goal');
  spawnParticles(team);
  // Reset ball to centre
  MG.ball={x:0.5,y:0.5,vx:rnd(0.004),vy:rnd(0.003),trail:[]};
  // Reset players to base positions
  MG.players.forEach(p=>{
    p.x=p.baseX+rnd(0.03); p.y=p.baseY+rnd(0.03);
    p.vx=0; p.vy=0; p.trail=[];
    p.aiState='hold'; p.aiReactTimer=Math.floor(Math.random()*15);
    p._longBallTarget=null;
  });
  MG._awaySweeper=null; // re-assign sweeper each restart
  MG.possession=team==='home'?'away':'home';
}

function spawnParticles(team){
  // Home scores in LEFT goal (x=0.02), away scores in RIGHT goal (x=0.98)
  const cx=team==='home'?0.02:0.98;
  for(let i=0;i<70;i++){
    const a=Math.random()*Math.PI*2, s=0.004+Math.random()*0.014;
    MG.particles.push({x:cx,y:0.5,vx:Math.cos(a)*s,vy:Math.sin(a)*s-0.003,
      life:55+Math.random()*45, maxLife:100,
      color:`hsl(${Math.random()*60+20},100%,60%)`});
  }
}

function endPeriod(){
  addLog(`‚è∏ END P${MG.period} ‚Äî ${MG.homeName} ${MG.homeScore}:${MG.awayScore} ${MG.awayName}`,'info');
  if(MG.period>=MG.maxPeriods){finalizeMatch();return;}
  MG.period++;MG.tick=0;
  MG.ball={x:0.5,y:0.5,vx:rnd(0.003),vy:rnd(0.002),trail:[]};
  MG.players.forEach(p=>{
    p.x=p.baseX+rnd(0.04);p.y=p.baseY+rnd(0.04);
    p.vx=0;p.vy=0;p.trail=[];
    p.chipTimer=30+Math.floor(Math.random()*50);
    p.aiState='hold'; p.aiReactTimer=Math.floor(Math.random()*15);
    p._longBallTarget=null;
  });
  MG._awaySweeper=null;
  MG.possession=MG.period%2===0?'away':'home';
  addLog(`‚ñ∂ PERIOD ${MG.period} KICKS OFF`,'info');
}

async function finalizeMatch(){
  MS.running=false;MG.phase='ended';
  const h=MG.homeScore,a=MG.awayScore;
  let rpChange=0,resultStr='';
  const result=h>a?'win':a>h?'loss':'draw';
  if(result==='win') {resultStr=`üèÜ ${MG.homeName} WIN! ${h}‚Äì${a}`;}
  else if(result==='loss'){resultStr=`${MG.awayName} WIN ${a}‚Äì${h}`;}
  else{resultStr=`DRAW ${h}‚Äì${a}`;}
  addLog(resultStr,'goal');
  stopRain();

  // Report to server (handles RP + record update)
  try{
    const res=await api('POST','/api/match-result',{result,homeScore:h,awayScore:a});
    if(res){
      CUR_USER.rp=res.rp; CUR_USER.record=res.record;
      ACCOUNTS[CUR]=Object.assign(ACCOUNTS[CUR]||{},CUR_USER);
      rpChange=res.rpChange;
    } else {
      // Offline fallback
      const rpMap={win:25,draw:5,loss:-15};
      rpChange=rpMap[result]||0;
      if(!CUR_USER.record)CUR_USER.record={w:0,d:0,l:0};
      CUR_USER.rp=Math.max(0,(CUR_USER.rp||0)+rpChange);
      if(result==='win')CUR_USER.record.w++;
      if(result==='loss')CUR_USER.record.l++;
      if(result==='draw')CUR_USER.record.d++;
    }
  }catch(e){
    const rpMap={win:25,draw:5,loss:-15};
    rpChange=rpMap[result]||0;
    if(!CUR_USER.record)CUR_USER.record={w:0,d:0,l:0};
    CUR_USER.rp=Math.max(0,(CUR_USER.rp||0)+rpChange);
    if(result==='win')CUR_USER.record.w++;
    if(result==='loss')CUR_USER.record.l++;
    if(result==='draw')CUR_USER.record.d++;
  }
  updateRec();updateRankBadge();save();
  updateLeagueStandings(result,h,a);
  document.getElementById('endTitle').textContent=result==='win'?'üèÜ VICTORY!':(result==='loss'?'üò§ DEFEAT':'ü§ù DRAW');
  document.getElementById('endTitle').style.color=result==='win'?'var(--gr)':(result==='loss'?'var(--re)':'var(--ye)');
  document.getElementById('endScore').textContent=`${h} : ${a}`;
  const tier=getTier(CUR_USER.rp||0);
  document.getElementById('endRankInfo').innerHTML=`RP: ${rpChange>=0?'+':''}${rpChange} ‚Üí ${CUR_USER.rp||0} &nbsp;${tier.icon} ${tier.name}`;
  document.getElementById('endOverlay').style.display='flex';
}

function stopRain(){
  if(rainCanvas)rainCanvas.style.display='none';
  rainDrops=[];
}

function drawRain(){
  if(!rainCtx||!rainDrops.length)return;
  const W=rainCanvas.width,H=rainCanvas.height;
  rainCtx.clearRect(0,0,W,H);
  rainDrops.forEach(d=>{
    rainCtx.beginPath();
    rainCtx.moveTo(d.x,d.y);
    rainCtx.lineTo(d.x+d.l*0.28,d.y+d.l);
    rainCtx.strokeStyle=`rgba(174,214,255,${d.a})`;
    rainCtx.lineWidth=1;rainCtx.stroke();
    d.y+=d.s;d.x+=d.s*0.28;
    if(d.y>H){d.y=-20;d.x=Math.random()*W;}
    if(d.x>W)d.x=0;
  });
}

function drawMatch(){
  if(!mCanvas||!mCtx)return;
  const W=mCanvas.width,H=mCanvas.height,ctx=mCtx;
  const sc=MG.scale||1;

  // Field boundaries in canvas pixels ‚Äî minimal padding so pitch fills the screen
  const pad=Math.max(6, Math.min(W,H)*0.016*(2-sc));
  const FL=pad+2, FR=W-pad-2, FT=pad*2.2, FB=H-pad*2.2;
  const FW=FR-FL, FH=FB-FT;

  // Normalised ‚Üí pixel
  const px=v=>FL+v*FW;
  const py=v=>FT+v*FH;

  // ‚îÄ‚îÄ Background ‚îÄ‚îÄ
  ctx.fillStyle=MG.isNight?'#07090f':'#0a0a0a';
  ctx.fillRect(0,0,W,H);

  // Stands / crowd area
  if(MG.isNight){
    ctx.fillStyle='#0c0e1a';
    ctx.fillRect(0,0,W,H);
    // crowd silhouette
    for(let i=0;i<6;i++){
      ctx.fillStyle=`rgba(${20+i*4},${15+i*3},${40+i*5},0.9)`;
      ctx.fillRect(0,i*(FT/6),W,FT/6+2);
      ctx.fillRect(0,FB+i*(H-FB)/6,W,(H-FB)/6+2);
    }
  } else {
    // Day: tiled grass
    ctx.fillStyle='#121a10';ctx.fillRect(0,0,W,H);
    // checkerboard grass stripes
    const stripeW=FW/10;
    for(let i=0;i<10;i++){
      ctx.fillStyle=i%2===0?'#162014':'#19271a';
      ctx.fillRect(FL+i*stripeW,FT,stripeW,FH);
    }
  }

  // ‚îÄ‚îÄ Night floodlights ‚îÄ‚îÄ
  if(MG.isNight){
    [[0,0],[1,0],[0,1],[1,1]].forEach(([lx,ly])=>{
      const lg=ctx.createRadialGradient(px(lx),py(ly),5,px(lx),py(ly),Math.max(FW,FH)*0.7);
      lg.addColorStop(0,'rgba(255,245,200,.06)');
      lg.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=lg;ctx.fillRect(0,0,W,H);
    });
  }

  // ‚îÄ‚îÄ Field outline ‚îÄ‚îÄ
  ctx.strokeStyle=MG.isNight?'rgba(255,255,255,.55)':'rgba(255,255,255,.75)';
  ctx.lineWidth=2;
  ctx.strokeRect(FL,FT,FW,FH);

  // Halfway line
  ctx.beginPath();ctx.moveTo(px(0.5),FT);ctx.lineTo(px(0.5),FB);ctx.stroke();

  // Centre circle
  ctx.beginPath();
  ctx.arc(px(0.5),py(0.5),FH*0.16,0,Math.PI*2);
  ctx.stroke();
  // Centre dot
  ctx.beginPath();ctx.arc(px(0.5),py(0.5),4,0,Math.PI*2);
  ctx.fillStyle='rgba(255,255,255,.6)';ctx.fill();

  // Penalty areas
  const paW=FW*0.14, paH=FH*0.48;
  ctx.strokeStyle=MG.isNight?'rgba(255,255,255,.4)':'rgba(255,255,255,.55)';
  ctx.lineWidth=1.5;
  ctx.strokeRect(FL, py(0.5)-paH/2, paW, paH);             // left pen area
  ctx.strokeRect(FR-paW, py(0.5)-paH/2, paW, paH);         // right pen area

  // Penalty spots
  ctx.fillStyle='rgba(255,255,255,.4)';
  ctx.beginPath();ctx.arc(FL+paW*0.65,py(0.5),3,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(FR-paW*0.65,py(0.5),3,0,Math.PI*2);ctx.fill();

  // Corner arcs
  [[0,0],[1,0],[0,1],[1,1]].forEach(([cx2,cy2])=>{
    ctx.beginPath();
    ctx.arc(px(cx2),py(cy2),FH*0.04,0,Math.PI*2);
    ctx.strokeStyle='rgba(255,255,255,.35)';ctx.lineWidth=1.2;ctx.stroke();
  });

  // ‚îÄ‚îÄ GOALS ‚îÄ‚îÄ
  const goalDepth=FW*0.028, goalH=FH*0.22;
  const goalTop=py(0.5)-goalH/2, goalBot=py(0.5)+goalH/2;

  // LEFT goal ‚Äî HOME scores here (home attacks left from right half)
  ctx.fillStyle='rgba(0,229,122,.15)';
  ctx.fillRect(FL-goalDepth, goalTop, goalDepth, goalH);
  ctx.strokeStyle='rgba(0,229,122,.7)';ctx.lineWidth=2;
  ctx.strokeRect(FL-goalDepth, goalTop, goalDepth, goalH);
  ctx.strokeStyle='rgba(0,229,122,.25)';ctx.lineWidth=0.8;
  for(let g=0;g<4;g++){
    ctx.beginPath();ctx.moveTo(FL-goalDepth,goalTop+g*(goalH/4));ctx.lineTo(FL,goalTop+g*(goalH/4));ctx.stroke();
  }

  // RIGHT goal ‚Äî AWAY scores here (away attacks right from left half)
  ctx.fillStyle='rgba(255,61,90,.15)';
  ctx.fillRect(FR, goalTop, goalDepth, goalH);
  ctx.strokeStyle='rgba(255,61,90,.7)';ctx.lineWidth=2;
  ctx.strokeRect(FR, goalTop, goalDepth, goalH);
  ctx.strokeStyle='rgba(255,61,90,.25)';ctx.lineWidth=0.8;
  for(let g=0;g<4;g++){
    ctx.beginPath();ctx.moveTo(FR,goalTop+g*(goalH/4));ctx.lineTo(FR+goalDepth,goalTop+g*(goalH/4));ctx.stroke();
  }

  // Goal labels
  ctx.textAlign='center';ctx.textBaseline='bottom';ctx.font='bold 9px Syne';
  ctx.fillStyle='rgba(0,229,122,.85)';ctx.fillText('‚óÑ HOME GOAL',px(0.08),FT-3);
  ctx.fillStyle='rgba(255,61,90,.85)';ctx.fillText('AWAY GOAL ‚ñ∫',px(0.92),FT-3);

  // Rain puddles (static shimmer)
  if(MG.isRain){
    ctx.globalAlpha=0.07;
    for(let i=0;i<6;i++){
      const pux=FL+Math.sin(i*1.7+MG.tick*0.01)*FW*0.3+FW*0.5;
      const puy=FT+Math.cos(i*2.3+MG.tick*0.008)*FH*0.3+FH*0.5;
      ctx.beginPath();ctx.ellipse(pux,puy,30+i*10,8+i*3,0,0,Math.PI*2);
      ctx.fillStyle='rgba(120,180,255,1)';ctx.fill();
    }
    ctx.globalAlpha=1;
  }

  // ‚îÄ‚îÄ Ball trail ‚îÄ‚îÄ
  MG.ball.trail.forEach((pt,i)=>{
    const a=(i/MG.ball.trail.length)*0.35;
    const r=(i/MG.ball.trail.length)*5;
    ctx.beginPath();ctx.arc(px(pt.x),py(pt.y),r,0,Math.PI*2);
    ctx.fillStyle=`rgba(255,255,255,${a})`;ctx.fill();
  });

  // ‚îÄ‚îÄ Player trails ‚îÄ‚îÄ
  MG.players.forEach(pl=>{
    if(pl.trail.length<2)return;
    ctx.beginPath();
    ctx.moveTo(px(pl.trail[0].x),py(pl.trail[0].y));
    for(let i=1;i<pl.trail.length;i++) ctx.lineTo(px(pl.trail[i].x),py(pl.trail[i].y));
    ctx.strokeStyle=pl.robot.color+'30';ctx.lineWidth=3;ctx.stroke();
  });

  // ‚îÄ‚îÄ Players ‚îÄ‚îÄ
  MG.players.forEach(pl=>{
    const ppx=px(pl.x), ppy=py(pl.y);
    const R=Math.max(10,FH*PLAYER_RADIUS);
    const distToBall=Math.hypot(pl.x-MG.ball.x,pl.y-MG.ball.y);
    const hasBall=distToBall<(PLAYER_RADIUS+BALL_RADIUS+0.02);

    // Shadow
    ctx.beginPath();ctx.ellipse(ppx,ppy+R*0.9,R*0.85,R*0.3,0,0,Math.PI*2);
    ctx.fillStyle='rgba(0,0,0,.35)';ctx.fill();

    // Glow if has ball
    if(hasBall){
      ctx.beginPath();ctx.arc(ppx,ppy,R*1.7,0,Math.PI*2);
      ctx.fillStyle=pl.robot.color+'22';ctx.fill();
    }

    // üî¥ Sweeper ring ‚Äî pulsing red halo around the designated sweeper
    if(pl.team==='away' && pl.aiState==='sweeper'){
      const pulse = 0.55 + 0.45*Math.sin(MG.tick*0.12);
      ctx.beginPath();ctx.arc(ppx,ppy,R*2.0,0,Math.PI*2);
      ctx.strokeStyle=`rgba(255,61,90,${pulse*0.7})`;ctx.lineWidth=2;ctx.stroke();
      ctx.beginPath();ctx.arc(ppx,ppy,R*1.4,0,Math.PI*2);
      ctx.strokeStyle=`rgba(255,61,90,${pulse*0.4})`;ctx.lineWidth=1;ctx.stroke();
    }

    // üî¥ Hard difficulty: show AI state as tiny label above player
    if(pl.team==='away' && MG.awayDifficulty==='hard' && pl.aiState && pl.aiState!=='hold'){
      const stateColors = {
        press:'#ff3d5a', fwd_press:'#ff6b00', shoot:'#f5c400',
        carry:'#00e57a', sweeper:'#ff3d5a', attack:'#3d7eff',
        lurk:'#9f6fff', recover:'#aaaaaa', gk_rush:'#ff3d5a'
      };
      const sc = stateColors[pl.aiState]||'#888';
      ctx.font='bold 7px JetBrains Mono';
      ctx.textAlign='center';ctx.textBaseline='bottom';
      ctx.fillStyle=sc;
      ctx.fillText(pl.aiState.toUpperCase(), ppx, ppy-R-2);
    }

    // Body circle
    ctx.beginPath();ctx.arc(ppx,ppy,R,0,Math.PI*2);
    ctx.fillStyle=pl.robot.color+'ee';ctx.fill();
    ctx.strokeStyle=hasBall?'#f5c400':'rgba(255,255,255,.3)';
    ctx.lineWidth=hasBall?2.5:1.2;ctx.stroke();

    // Emoji
    ctx.font=`${R*1.1}px serif`;
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(pl.robot.emoji,ppx,ppy);

    // Team dot
    ctx.beginPath();ctx.arc(ppx,ppy+R+3,3.5,0,Math.PI*2);
    ctx.fillStyle=pl.team==='home'?'#00e57a':'#ff3d5a';ctx.fill();

    // Ball-carrier name tag
    if(hasBall){
      const nw=pl.robot.name.length*5.8+12;
      ctx.fillStyle='rgba(0,0,0,.8)';
      ctx.beginPath();
      if(ctx.roundRect)ctx.roundRect(ppx-nw/2,ppy-R-18,nw,14,4);
      else ctx.rect(ppx-nw/2,ppy-R-18,nw,14);
      ctx.fill();
      ctx.font='bold 8px Syne';ctx.fillStyle='#f5c400';
      ctx.textBaseline='top';ctx.fillText(pl.robot.name,ppx,ppy-R-17);
    }
  });

  // ‚îÄ‚îÄ Ball ‚îÄ‚îÄ
  const BR=Math.max(7,FH*BALL_RADIUS);
  const bpx=px(MG.ball.x),bpy=py(MG.ball.y);
  // Shadow
  ctx.beginPath();ctx.ellipse(bpx,bpy+BR*0.7,BR*0.75,BR*0.25,0,0,Math.PI*2);
  ctx.fillStyle='rgba(0,0,0,.4)';ctx.fill();
  // Ball gradient
  const bg=ctx.createRadialGradient(bpx-BR*0.3,bpy-BR*0.3,BR*0.1,bpx,bpy,BR);
  bg.addColorStop(0,'#ffffff');bg.addColorStop(0.6,'#e0e0e0');bg.addColorStop(1,'#aaaaaa');
  ctx.beginPath();ctx.arc(bpx,bpy,BR,0,Math.PI*2);
  ctx.fillStyle=bg;ctx.fill();
  ctx.strokeStyle='#333';ctx.lineWidth=1;ctx.stroke();
  // Seam patches
  [[0,-0.45],[0.38,0.22],[-0.38,0.22]].forEach(([dx,dy])=>{
    ctx.beginPath();ctx.arc(bpx+dx*BR,bpy+dy*BR,BR*0.28,0,Math.PI*2);
    ctx.fillStyle='rgba(40,40,40,.5)';ctx.fill();
  });

  // ‚îÄ‚îÄ Particles ‚îÄ‚îÄ
  MG.particles.forEach(pt=>{
    const a=pt.life/pt.maxLife;
    ctx.beginPath();ctx.arc(px(pt.x),py(pt.y),3.5*a,0,Math.PI*2);
    ctx.fillStyle=pt.color.replace('hsl','hsla').replace(')',`,${a})`);ctx.fill();
  });

  // ‚îÄ‚îÄ Possession bar ‚îÄ‚îÄ
  const barW=120, barH=7, barX=W/2-barW/2, barY=H-14;
  ctx.fillStyle='rgba(0,0,0,.55)';ctx.fillRect(barX,barY,barW,barH);
  const homePct=MG.possession==='home'?65:45;
  ctx.fillStyle='rgba(0,229,122,.7)';ctx.fillRect(barX,barY,homePct/100*barW,barH);
  ctx.fillStyle='rgba(255,61,90,.7)';ctx.fillRect(barX+homePct/100*barW,barY,(100-homePct)/100*barW,barH);
  ctx.strokeStyle='rgba(255,255,255,.1)';ctx.lineWidth=1;ctx.strokeRect(barX,barY,barW,barH);
}

// ==================== RANKED ====================
async function renderRanked(){
  if(!CUR)return;
  const rp=acct().rp||0;
  const tier=getTier(rp);
  const el=document.getElementById('rankedTiers');
  el.innerHTML=RANK_TIERS.map(t=>{
    const isCur=tier.name===t.name;
    const progress=t.max===999999?100:Math.min(100,Math.max(0,(rp-t.min)/(t.max-t.min)*100));
    return `<div class="rank-tier" style="${isCur?`border-color:${t.color};background:${t.color}11`:''};margin-bottom:6px;">
      <div class="rank-ico">${t.icon}</div>
      <div style="flex:1">
        <div class="rank-name" style="color:${t.color}">${t.name}${isCur?' ‚Üê YOU':''}</div>
        <div class="rank-pts">${t.min}‚Äì${t.max===999999?'‚àû':t.max} RP</div>
        ${isCur?`<div class="rank-bar-wrap"><div class="rank-bar-fill" style="width:${progress}%;background:${t.color}"></div></div>`:''}
      </div>
      ${isCur?`<div style="font-family:'JetBrains Mono',monospace;font-size:.8rem;font-weight:700;color:${t.color}">${rp} RP</div>`:''}
    </div>`;
  }).join('');
  document.getElementById('rankedStats').innerHTML=`
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
      <div class="rec-box"><div class="rec-num" style="color:var(--gr)">${acct().record?.w||0}</div><div class="rec-lbl">Wins</div></div>
      <div class="rec-box"><div class="rec-num" style="color:var(--muted)">${acct().record?.d||0}</div><div class="rec-lbl">Draws</div></div>
      <div class="rec-box"><div class="rec-num" style="color:var(--re)">${acct().record?.l||0}</div><div class="rec-lbl">Losses</div></div>
    </div>
    <div style="margin-top:10px;font-size:.72rem;color:var(--muted);">Win: +25 RP &nbsp;|&nbsp; Draw: +5 RP &nbsp;|&nbsp; Loss: -15 RP</div>
    <div style="margin-top:14px;font-size:.65rem;font-weight:800;color:var(--muted);letter-spacing:2px;text-transform:uppercase;">üåç Global Leaderboard</div>
    <div id="leaderboardList" style="margin-top:8px;font-size:.75rem;color:var(--muted);text-align:center;">Loading‚Ä¶</div>`;
  // Fetch global leaderboard
  if(!OFFLINE_MODE){
    try{
      const lb=await api('GET','/api/leaderboard')||[];
      document.getElementById('leaderboardList').innerHTML=lb.slice(0,20).map((p,i)=>`
        <div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--bd);${p.username===CUR?'background:rgba(0,229,122,.05);border-radius:5px;padding:5px 6px;':''}">
          <span style="font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--muted);width:18px">${i+1}</span>
          <span style="font-size:1rem">${p.avatar||'ü§ñ'}</span>
          <span style="font-weight:700;flex:1">${p.teamName||p.username}${p.username===CUR?' üë§':''}</span>
          <span style="color:${getTier(p.rp).color};font-weight:800;">${getTier(p.rp).icon} ${p.rp}</span>
        </div>`).join('')||'<div style="padding:12px;text-align:center;">No players yet</div>';
    }catch(e){
      document.getElementById('leaderboardList').innerHTML=`<div style="color:var(--muted);padding:10px">Offline ‚Äî leaderboard unavailable</div>`;
    }
  } else {
    document.getElementById('leaderboardList').innerHTML=`<div style="color:var(--muted);padding:10px">‚ö†Ô∏è Offline mode</div>`;
  }
}

function startRankedMatch(){
  goScreen('match',null);
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('active',b.textContent.includes('Match')));
  toast('Ranked match ‚Äî win to earn RP!');
}

// ==================== LEAGUES ====================
// ==================== LEAGUES (SERVER) ====================
async function joinLeague(){
  if(OFFLINE_MODE){toast('Server offline ‚Äî leagues unavailable','err');return;}
  try{
    const league=await api('POST','/api/leagues/join');
    acct().leagueId=league.id;save();
    toast('Joined league!');renderLeagues();
  }catch(e){toast(e.message,'err');}
}

async function updateLeagueStandings(result,gf,ga){
  // Handled server-side by /api/match-result ‚Äî nothing to do client-side
}

async function renderLeagues(){
  const el=document.getElementById('leagueContent');
  if(!acct().leagueId){
    el.innerHTML=`<div class="empty-hint"><div class="big">ü•á</div><div class="txt">Not in a league yet</div><button class="btn btn-gr btn-sm" onclick="joinLeague()" style="margin-top:10px;">Join a League</button></div>`;
    return;
  }
  el.innerHTML=`<div style="color:var(--muted);font-size:.75rem;padding:20px;text-align:center;">Loading‚Ä¶</div>`;
  try{
    const leagues=await api('GET','/api/leagues')||[];
    const league=leagues.find(l=>l.id===acct().leagueId);
    if(!league){
      el.innerHTML=`<div class="empty-hint"><div class="big">ü•á</div><div class="txt">League not found</div></div>`;return;
    }
    const sorted=[...league.teams].sort((a,b)=>b.pts-a.pts||(b.gf-b.ga)-(a.gf-a.ga));
    el.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div style="font-size:.72rem;color:var(--muted);">${league.name} ¬∑ ${league.teams.length} Teams</div>
        <button class="btn btn-s3 btn-xs" onclick="leaveLeague()">Leave League</button>
      </div>
      <table class="league-table">
        <thead><tr><th>#</th><th>Team</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>PTS</th></tr></thead>
        <tbody>${sorted.map((t,i)=>`<tr style="${t.player===CUR?'background:rgba(0,229,122,.06);':''}">
          <td class="lt-pos">${i+1}</td>
          <td style="font-weight:700;font-size:.75rem;">${t.name}${t.player===CUR?' üë§':''}</td>
          <td style="color:var(--gr)">${t.w}</td><td style="color:var(--muted)">${t.d}</td><td style="color:var(--re)">${t.l}</td>
          <td>${t.gf}</td><td>${t.ga}</td><td class="lt-pts">${t.pts}</td>
        </tr>`).join('')}</tbody>
      </table>
      <div style="margin-top:10px;font-size:.72rem;color:var(--muted);">Record updates automatically after each match.</div>`;
  }catch(e){el.innerHTML=`<div style="color:var(--muted);padding:20px;text-align:center;">${e.message}</div>`;}
}

async function leaveLeague(){
  if(!confirm('Leave league?'))return;
  try{
    await api('POST','/api/leagues/leave');
    acct().leagueId=null;save();renderLeagues();toast('Left league');
  }catch(e){toast(e.message,'err');}
}

// ==================== CLANS (SERVER) ====================
async function renderClans(){
  const el=document.getElementById('clanContent');
  el.innerHTML=`<div style="color:var(--muted);font-size:.75rem;padding:20px;text-align:center;">Loading‚Ä¶</div>`;
  try{
    const clans=OFFLINE_MODE?[]:await api('GET','/api/clans')||[];
    const myClanId=acct().clan;
    const myClan=myClanId?clans.find(c=>c.id===myClanId):null;
    if(myClan){
      const members=myClan.members||[];
      el.innerHTML=`<div class="clan-card" style="border-color:${myClan.color}44">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
          <div style="font-size:2rem">${myClan.icon}</div>
          <div><div style="font-size:1rem;font-weight:800;">${myClan.name}</div>
          <span class="clan-tag" style="background:${myClan.color}22;color:${myClan.color};">[${myClan.tag}]</span>
          <span style="font-size:.65rem;color:var(--muted);">${members.length} members</span></div>
          <button class="btn btn-re btn-xs" style="margin-left:auto;" onclick="leaveClan()">Leave</button>
        </div>
        <div style="font-size:.72rem;font-weight:700;color:var(--muted);letter-spacing:1px;margin-bottom:8px;">MEMBERS</div>
        ${members.map(u=>`<div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--bd);">
          <span>${u.avatar||'ü§ñ'}</span>
          <span style="font-size:.78rem;font-weight:700;">${u.username}${u.username===CUR?' (you)':''}</span>
          <span style="margin-left:auto;font-size:.65rem;color:${getTier(u.rp||0).color};">${getTier(u.rp||0).icon} ${getTier(u.rp||0).name}</span>
        </div>`).join('')}
      </div>`;
    } else {
      el.innerHTML=`<div class="empty-hint"><div class="big">üõ°</div><div class="txt">Not in a clan</div></div>`;
      if(clans.length>0){
        el.innerHTML+='<div style="font-size:.65rem;font-weight:800;color:var(--muted);letter-spacing:2px;margin:14px 0 8px;text-transform:uppercase;">All Clans</div>'+
          clans.map(c=>`<div class="clan-card"><div style="display:flex;align-items:center;gap:10px;">
            <div style="font-size:1.5rem">${c.icon}</div>
            <div><div style="font-size:.9rem;font-weight:800;">${c.name}</div>
            <span class="clan-tag" style="background:${c.color}22;color:${c.color}">[${c.tag}]</span>
            <span style="font-size:.65rem;color:var(--muted)">${(c.members||[]).length} members</span></div>
            <button class="btn btn-gr btn-xs" style="margin-left:auto;" onclick="joinClanById('${c.id}')">Join</button>
          </div></div>`).join('');
      }
    }
  }catch(e){el.innerHTML=`<div style="color:var(--muted);padding:20px;text-align:center;">${e.message}</div>`;}
}

function openCreateClanModal(){
  _clanEmoji='üõ°Ô∏è';_clanColor=COLORS[0];
  document.getElementById('clanName').value='';document.getElementById('clanTag').value='';
  document.getElementById('clanColors').innerHTML=COLORS.map(c=>`<div class="csw${c===_clanColor?' on':''}" style="background:${c}" onclick="_clanColor='${c}';document.querySelectorAll('#clanColors .csw').forEach(s=>s.classList.remove('on'));this.classList.add('on');"></div>`).join('');
  document.getElementById('clanEmojis').innerHTML=EMOJIS.map(e=>`<div class="emo-opt" style="font-size:1rem;" onclick="_clanEmoji='${e}';document.querySelectorAll('#clanEmojis .emo-opt').forEach(s=>s.style.background='');this.style.background='var(--s4)';">${e}</div>`).join('');
  openModal('createClanModal');
}
async function saveClan(){
  const name=document.getElementById('clanName').value.trim(),tag=document.getElementById('clanTag').value.trim();
  if(!name||!tag){toast('Fill in name and tag','err');return;}
  if(acct().clan){toast('Leave current clan first','err');return;}
  try{
    const clan=await api('POST','/api/clans',{name,tag,color:_clanColor,icon:_clanEmoji});
    acct().clan=clan.id;save();
    closeModal('createClanModal');renderClans();toast('Clan created!');
  }catch(e){toast(e.message,'err');}
}
async function openJoinClanModal(){
  try{
    const clans=(await api('GET','/api/clans')||[]).filter(c=>c.id!==acct().clan);
    document.getElementById('joinClanList').innerHTML=clans.length
      ?clans.map(c=>`<div class="clan-card"><div style="display:flex;align-items:center;gap:10px;"><span style="font-size:1.5rem">${c.icon}</span><div><div style="font-size:.85rem;font-weight:800;">${c.name}</div><span class="clan-tag" style="background:${c.color}22;color:${c.color}">[${c.tag}]</span></div><button class="btn btn-gr btn-xs" style="margin-left:auto" onclick="joinClanById('${c.id}');closeModal('joinClanModal')">Join</button></div></div>`).join('')
      :`<div style="text-align:center;color:var(--muted);padding:20px;">No clans yet. Create one!</div>`;
  }catch(e){document.getElementById('joinClanList').innerHTML=`<div style="color:var(--re);padding:20px">${e.message}</div>`;}
  openModal('joinClanModal');
}
async function joinClanById(id){
  if(acct().clan){toast('Leave current clan first','err');return;}
  try{
    await api('POST',`/api/clans/${id}/join`);
    acct().clan=id;save();renderClans();toast('Joined clan!');
  }catch(e){toast(e.message,'err');}
}
async function leaveClan(){
  if(!confirm('Leave clan?'))return;
  try{
    await api('POST','/api/clans/leave');
    acct().clan=null;save();renderClans();
  }catch(e){toast(e.message,'err');}
}

// ==================== ONLINE / TEAM SHARING (SERVER) ====================
function renderOnline(){
  if(!CUR)return;
  document.getElementById('myCodeDisplay').textContent=acct().code||'----';
  document.getElementById('oRecW').textContent=acct().record?.w||0;
  document.getElementById('oRecD').textContent=acct().record?.d||0;
  document.getElementById('oRecL').textContent=acct().record?.l||0;
}
async function genCode(){
  if(OFFLINE_MODE){
    // Offline fallback
    const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let code='';for(let i=0;i<4;i++)code+=c[Math.floor(Math.random()*c.length)];
    acct().code=code;
    localStorage.setItem('bf5_team_'+code,JSON.stringify({name:acct().teamName||CUR,robots:acct().robots,programs:acct().programs,field:acct().field}));
    save();renderOnline();toast('Code generated (offline)!');
    return;
  }
  try{
    const {code}=await api('POST','/api/share-team');
    acct().code=code;save();renderOnline();toast('Code generated!');
  }catch(e){toast(e.message,'err');}
}
function copyCode(){
  const code=acct().code;
  if(!code){toast('Generate a code first','err');return;}
  navigator.clipboard.writeText(code).then(()=>toast('Copied!')).catch(()=>toast('Copy failed','err'));
}
async function loadChallenge(){
  const code=document.getElementById('challengeInp').value.trim().toUpperCase();
  if(code.length<4){toast('Enter a 4-char code','err');return;}
  try{
    let saved=null;
    if(!OFFLINE_MODE){
      saved=await api('GET',`/api/team/${code}`).catch(()=>null);
    }
    if(!saved){
      const ls=localStorage.getItem('bf5_team_'+code)||localStorage.getItem('bf3_team_'+code);
      if(ls) saved=JSON.parse(ls);
    }
    if(!saved){toast('No team found for that code','err');return;}
    document.getElementById('friendCodeInp').value=code;
    // Store for match use
    localStorage.setItem('bf5_team_'+code,JSON.stringify(saved));
    pickVs('friend');
    goScreen('match',null);
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('active',b.textContent.includes('Match')));
    toast('Code loaded ‚Äî hit Kick Off!');
  }catch(e){toast('Code error: '+e.message,'err');}
}

function updateRec(){
  if(!CUR)return;const r=acct().record||{w:0,d:0,l:0};
  document.getElementById('recW').textContent='W '+r.w;document.getElementById('recD').textContent='D '+r.d;document.getElementById('recL').textContent='L '+r.l;
  document.getElementById('oRecW').textContent=r.w;document.getElementById('oRecD').textContent=r.d;document.getElementById('oRecL').textContent=r.l;
}

// INIT
loadSt();
renderAuthForm();
// Auto-login: if we have a stored token, verify it with server first
(async()=>{
  if(TOKEN){
    try{
      const me = await api('GET','/api/me');
      if(me && me.username){
        // Token still valid ‚Äî log straight in with fresh server data
        loginAs(me.username, TOKEN, me);
        return;
      }
    } catch(e){
      // Token expired or server error ‚Äî clear it and fall through
      TOKEN=null; localStorage.removeItem('bf_token');
    }
  }
  // Fallback: restore last session from local cache
  if(CUR && ACCOUNTS[CUR]){
    document.getElementById('authScreen').style.display='none';
    enterApp();
  }
})();
</script>
</body>
</html>
