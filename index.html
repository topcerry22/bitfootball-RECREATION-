
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BIT FOOTBALL</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;600;700&display=swap');
:root{
  --bg:#07080e;--s1:#0d0f18;--s2:#131620;--s3:#1a1d2c;--s4:#222537;--s5:#2a2e45;
  --bd:rgba(255,255,255,.07);--bd2:rgba(255,255,255,.13);
  --txt:#dde4f0;--muted:#5a6480;
  --gr:#00e57a;--gr2:#00c065;--bl:#3d7eff;--or:#ff7a2f;--re:#ff3d5a;--pu:#9f6fff;--cy:#00d4e8;--ye:#f5c400;
}
*{box-sizing:border-box;margin:0;padding:0;}html,body{height:100%;overflow:hidden;-webkit-font-smoothing:antialiased;}
body{font-family:'Syne',sans-serif;background:var(--bg);color:var(--txt);}
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--s3);border:1px solid var(--bd2);border-radius:10px;padding:9px 20px;font-size:.8rem;font-weight:700;z-index:9999;opacity:0;transition:all .25s;pointer-events:none;white-space:nowrap;}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}#toast.ok{border-color:var(--gr);color:var(--gr);}#toast.err{border-color:var(--re);color:var(--re);}
.modal-wrap{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:800;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;}
.modal-wrap.open{opacity:1;pointer-events:all;}
.modal{background:var(--s2);border:1px solid var(--bd2);border-radius:16px;padding:24px;width:360px;max-width:95vw;max-height:85vh;overflow-y:auto;transform:translateY(8px);transition:transform .2s;}
.modal-wrap.open .modal{transform:translateY(0);}
.modal-title{font-size:.85rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;margin-bottom:18px;}
.modal-footer{display:flex;justify-content:flex-end;gap:8px;margin-top:18px;}
/* AUTH */
#authScreen{position:fixed;inset:0;z-index:9000;background:radial-gradient(ellipse at 35% 55%,#091830 0%,var(--bg) 65%);display:flex;align-items:center;justify-content:center;}
.auth-box{background:var(--s1);border:1px solid var(--bd2);border-radius:20px;padding:36px;width:380px;max-width:95vw;box-shadow:0 40px 80px rgba(0,0,0,.7);}
.auth-logo{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:700;color:var(--gr);letter-spacing:5px;text-align:center;margin-bottom:3px;}
.auth-tagline{text-align:center;color:var(--muted);font-size:.72rem;letter-spacing:3px;margin-bottom:28px;}
.auth-tabs{display:flex;gap:3px;background:var(--s2);border-radius:9px;padding:3px;margin-bottom:18px;}
.auth-tab{flex:1;padding:8px;border:none;border-radius:7px;cursor:pointer;font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;background:transparent;color:var(--muted);transition:all .15s;}
.auth-tab.active{background:var(--s4);color:var(--txt);}
.af-field{margin-bottom:10px;}.af-label{font-size:.68rem;font-weight:800;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;display:block;}
.af-input{width:100%;background:var(--s2);border:1px solid var(--bd2);border-radius:8px;color:var(--txt);font-family:'Syne',sans-serif;font-size:.88rem;padding:9px 12px;outline:none;transition:border-color .15s;}
.af-input:focus{border-color:var(--gr);}
.af-btn{width:100%;padding:11px;border:none;border-radius:9px;cursor:pointer;font-family:'Syne',sans-serif;font-size:.9rem;font-weight:800;background:var(--gr);color:#07080e;margin-top:8px;transition:all .15s;}
.af-btn:hover{background:var(--gr2);}
.auth-err{font-size:.73rem;color:var(--re);text-align:center;min-height:18px;margin-top:4px;}
.auth-existing{margin-top:16px;border-top:1px solid var(--bd);padding-top:14px;}
.ae-title{font-size:.65rem;font-weight:800;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;}
.ae-pill{display:flex;align-items:center;gap:8px;padding:7px 9px;border-radius:8px;background:var(--s2);border:1px solid var(--bd);cursor:pointer;margin-bottom:5px;transition:all .15s;font-size:.8rem;font-weight:600;}
.ae-pill:hover{border-color:var(--gr);}
.ae-del{margin-left:auto;font-size:.65rem;color:var(--muted);padding:2px 6px;border-radius:4px;background:transparent;border:none;cursor:pointer;}
.ae-del:hover{color:var(--re);}
/* APP */
#app{display:none;flex-direction:column;height:100%;}#app.on{display:flex;}
.topbar{display:flex;align-items:center;height:46px;background:var(--s1);border-bottom:1px solid var(--bd);flex-shrink:0;}
.topbar-logo{font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700;color:var(--gr);letter-spacing:4px;padding:0 18px;border-right:1px solid var(--bd);height:100%;display:flex;align-items:center;}
.nav-list{display:flex;height:100%;}
.nav-btn{display:flex;align-items:center;gap:5px;padding:0 14px;border:none;background:none;color:var(--muted);cursor:pointer;font-family:'Syne',sans-serif;font-size:.75rem;font-weight:700;letter-spacing:.5px;text-transform:uppercase;border-bottom:2px solid transparent;height:100%;transition:all .15s;}
.nav-btn:hover{color:var(--txt);}.nav-btn.active{color:var(--gr);border-bottom-color:var(--gr);}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:8px;padding-right:14px;}
.user-pill{display:flex;align-items:center;gap:7px;background:var(--s2);border:1px solid var(--bd);border-radius:7px;padding:4px 10px;font-size:.75rem;font-weight:700;cursor:pointer;}
.rec-row{display:flex;gap:3px;}
.rb{font-size:.65rem;font-weight:800;padding:2px 6px;border-radius:4px;}
.rb-w{background:rgba(0,229,122,.12);color:var(--gr);}.rb-d{background:rgba(90,99,128,.12);color:var(--muted);}.rb-l{background:rgba(255,61,90,.12);color:var(--re);}
.main{flex:1;overflow:hidden;position:relative;}
.screen{display:none;width:100%;height:100%;}.screen.active{display:flex;flex-direction:column;}
/* PANELS */
.two-col{display:flex;flex:1;overflow:hidden;}
.col-left{width:250px;flex-shrink:0;border-right:1px solid var(--bd);display:flex;flex-direction:column;background:var(--s1);}
.col-right{flex:1;overflow-y:auto;padding:16px;}
.col-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--bd);flex-shrink:0;}
.col-title{font-size:.65rem;font-weight:800;color:var(--muted);letter-spacing:3px;text-transform:uppercase;}
.col-body{flex:1;overflow-y:auto;padding:8px;}
::-webkit-scrollbar{width:3px;height:3px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:var(--s4);border-radius:2px;}
/* BTNS */
.btn{font-family:'Syne',sans-serif;font-size:.76rem;font-weight:700;padding:7px 14px;border:none;border-radius:7px;cursor:pointer;transition:all .15s;display:inline-flex;align-items:center;gap:5px;}
.btn:active{transform:scale(.97);}
.btn-gr{background:var(--gr);color:#07080e;}.btn-gr:hover{background:var(--gr2);}
.btn-s3{background:var(--s4);color:var(--txt);border:1px solid var(--bd2);}.btn-s3:hover{background:var(--s5);}
.btn-re{background:rgba(255,61,90,.12);color:var(--re);border:1px solid rgba(255,61,90,.2);}.btn-re:hover{background:rgba(255,61,90,.2);}
.btn-bl{background:var(--bl);color:#fff;}
.btn-sm{font-size:.68rem;padding:5px 10px;}.btn-xs{font-size:.62rem;padding:3px 7px;}
.inp{font-family:'Syne',sans-serif;font-size:.82rem;background:var(--s3);border:1px solid var(--bd2);border-radius:7px;color:var(--txt);padding:7px 10px;outline:none;transition:border-color .15s;width:100%;}
.inp:focus{border-color:var(--gr);}.inp::placeholder{color:var(--muted);}
/* ROBOTS */
.rli{display:flex;align-items:center;gap:9px;padding:8px 10px;border-radius:8px;border:1px solid var(--bd);background:var(--s2);cursor:pointer;transition:all .12s;margin-bottom:5px;}
.rli:hover{border-color:var(--bd2);}.rli.sel{border-color:var(--gr);background:rgba(0,229,122,.05);}
.rli-ava{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;}
.rli-name{font-size:.82rem;font-weight:700;}.rli-sub{font-size:.65rem;color:var(--muted);margin-top:1px;}
.rli-ct{font-size:.62rem;font-weight:800;color:var(--cy);background:rgba(0,212,232,.1);padding:2px 6px;border-radius:4px;}
.re-sec{background:var(--s2);border:1px solid var(--bd);border-radius:12px;padding:14px;margin-bottom:12px;}
.re-stitle{font-size:.65rem;font-weight:800;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:10px;}
.stat3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;}
.stat-c{background:var(--s3);border:1px solid var(--bd);border-radius:8px;padding:8px;text-align:center;}
.stat-c .lbl{font-size:.58rem;font-weight:800;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
.stat-c .val{font-family:'JetBrains Mono',monospace;font-size:1.05rem;font-weight:700;margin:3px 0;}
.stat-c .bar{height:3px;background:var(--s4);border-radius:2px;overflow:hidden;}.stat-c .bfill{height:100%;border-radius:2px;}
.stat-c .adj{display:flex;gap:3px;justify-content:center;margin-top:4px;}
.cpal{display:flex;flex-wrap:wrap;gap:5px;}
.csw{width:20px;height:20px;border-radius:5px;cursor:pointer;border:2px solid transparent;transition:transform .1s;}.csw:hover{transform:scale(1.2);}.csw.on{border-color:rgba(255,255,255,.8);}
.emo-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.emo-opt{font-size:1.2rem;text-align:center;cursor:pointer;padding:4px;border-radius:6px;}.emo-opt:hover{background:var(--s4);}
.empty-hint{text-align:center;padding:40px 16px;color:var(--muted);}
.empty-hint .big{font-size:2.5rem;margin-bottom:8px;}.empty-hint .txt{font-size:.83rem;font-weight:600;margin-bottom:14px;}
/* SCRATCH */
.scratch-wrap{display:flex;flex:1;overflow:hidden;}
.palette{width:230px;flex-shrink:0;background:var(--s1);border-right:1px solid var(--bd);display:flex;flex-direction:column;}
.pal-cats{display:flex;flex-wrap:wrap;gap:3px;padding:8px;border-bottom:1px solid var(--bd);flex-shrink:0;}
.pc-btn{font-size:.6rem;font-weight:800;padding:3px 8px;border-radius:5px;border:none;cursor:pointer;letter-spacing:.5px;text-transform:uppercase;opacity:.5;transition:all .12s;}.pc-btn.on{opacity:1;}
.pal-search{padding:6px 8px;border-bottom:1px solid var(--bd);flex-shrink:0;}
.pal-list{flex:1;overflow-y:auto;padding:6px;}
.blk{display:flex;align-items:center;gap:7px;padding:7px 10px;border-radius:8px;margin-bottom:3px;cursor:grab;border:none;width:100%;text-align:left;transition:filter .12s,transform .1s;border-left:3px solid transparent;user-select:none;}
.blk:active{cursor:grabbing;transform:scale(.96);}.blk:hover{filter:brightness(1.18);}
.blk-icon{font-size:.95rem;flex-shrink:0;}.blk-name{font-size:.72rem;font-weight:700;color:rgba(255,255,255,.95);}.blk-sub{font-size:.6rem;color:rgba(255,255,255,.45);margin-top:1px;}
.prog-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.prog-tabs-row{display:flex;align-items:center;gap:6px;padding:8px 12px;border-bottom:1px solid var(--bd);background:var(--s1);flex-shrink:0;overflow-x:auto;}
.prog-tabs-row::-webkit-scrollbar{height:0;}
.rtab{display:flex;align-items:center;gap:5px;padding:5px 10px;border-radius:7px;background:var(--s2);border:1px solid var(--bd);cursor:pointer;font-size:.72rem;font-weight:700;transition:all .12s;white-space:nowrap;flex-shrink:0;}
.rtab.on{border-color:var(--gr);background:rgba(0,229,122,.08);color:var(--gr);}
.prog-canvas{flex:1;overflow-y:auto;padding:14px;background:var(--bg);}
/* program blocks */
.prog-seq{display:flex;flex-direction:column;gap:2px;}
.start-blk{display:flex;align-items:center;gap:8px;padding:9px 14px;border-radius:9px 9px 0 0;background:#153a20;border:1.5px solid #2a7040;font-size:.78rem;font-weight:800;color:#00ff88;letter-spacing:.5px;}
.end-blk{padding:7px 14px;border-radius:0 0 9px 9px;background:#0d1f12;border:1.5px solid #1a4028;border-top:none;font-size:.68rem;font-weight:800;color:rgba(0,255,136,.3);letter-spacing:.5px;}
.prog-blk{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:4px;font-size:.76rem;font-weight:700;color:rgba(255,255,255,.92);border-left:3px solid transparent;}
.pb-num{font-family:'JetBrains Mono',monospace;font-size:.6rem;color:rgba(255,255,255,.25);width:16px;flex-shrink:0;}
.pb-icon{font-size:.9rem;flex-shrink:0;}.pb-label{flex:1;}
.pb-cat{font-size:.58rem;font-weight:800;padding:2px 6px;border-radius:4px;text-transform:uppercase;margin-left:auto;}
.pb-del{background:none;border:none;color:rgba(255,255,255,.2);cursor:pointer;font-size:.75rem;padding:2px 5px;border-radius:4px;margin-left:4px;flex-shrink:0;transition:all .1s;}
.pb-del:hover{color:var(--re);background:rgba(255,61,90,.15);}
/* IF */
.if-wrap{border-radius:6px;overflow:hidden;margin:2px 0;}
.if-head{display:flex;align-items:center;gap:8px;padding:8px 12px;font-size:.76rem;font-weight:700;background:#2a1650;border-left:3px solid var(--pu);}
.if-cond-sel{background:rgba(159,111,255,.2);border:1px solid rgba(159,111,255,.3);border-radius:5px;color:var(--pu);font-family:'Syne',sans-serif;font-size:.7rem;font-weight:700;padding:3px 7px;cursor:pointer;outline:none;flex:1;max-width:230px;}
.if-body{padding:3px 3px 3px 18px;background:#180d36;border-left:3px solid rgba(159,111,255,.25);}
.else-head{display:flex;align-items:center;gap:6px;padding:5px 12px;font-size:.7rem;font-weight:800;color:var(--or);background:#201000;border-left:3px solid var(--or);}
.else-body{padding:3px 3px 3px 18px;background:#110900;border-left:3px solid rgba(255,122,47,.25);}
.if-end{padding:4px 12px;font-size:.65rem;font-weight:800;color:rgba(255,255,255,.2);background:var(--s2);letter-spacing:1px;}
.dz{min-height:36px;border:2px dashed var(--s5);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:.68rem;color:var(--muted);transition:all .15s;margin:3px 0;}
.dz.over{border-color:var(--gr);background:rgba(0,229,122,.05);color:var(--gr);}
.prog-actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;}
.add-if-btn{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:7px;border:1.5px dashed rgba(159,111,255,.35);background:transparent;color:var(--pu);font-family:'Syne',sans-serif;font-size:.72rem;font-weight:700;cursor:pointer;transition:all .12s;justify-content:center;}
.add-if-btn:hover{border-color:var(--pu);background:rgba(159,111,255,.08);}
/* FIELD */
.field-wrap{display:flex;flex:1;overflow:hidden;}
.field-side{width:180px;flex-shrink:0;background:var(--s1);border-right:1px solid var(--bd);display:flex;flex-direction:column;padding:10px;}
.field-side-title{font-size:.65rem;font-weight:800;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px;}
.frd{display:flex;align-items:center;gap:7px;padding:7px 9px;border-radius:8px;border:1px solid var(--bd);background:var(--s2);margin-bottom:5px;cursor:grab;font-size:.78rem;font-weight:600;}
.frd:hover{border-color:var(--bd2);}.frd.placed{border-color:var(--gr);opacity:.7;}
.field-canvas-area{flex:1;display:flex;align-items:center;justify-content:center;background:var(--bg);padding:12px;}
.fmt-btns{display:flex;flex-wrap:wrap;gap:4px;margin-top:auto;padding-top:8px;border-top:1px solid var(--bd);}
/* MATCH */
.match-shell{display:flex;flex:1;overflow:hidden;}
.match-main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.match-hud{display:flex;align-items:center;justify-content:space-between;padding:10px 18px;background:var(--s1);border-bottom:1px solid var(--bd);flex-shrink:0;}
.hud-team{display:flex;flex-direction:column;align-items:center;gap:2px;min-width:100px;}
.hud-name{font-size:.75rem;font-weight:800;letter-spacing:1px;}
.hud-poss{font-size:.6rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;min-height:14px;}
.hud-score-c{display:flex;align-items:center;flex-direction:column;gap:3px;}
.hud-score-row{display:flex;align-items:center;gap:14px;}
.hud-score{font-family:'JetBrains Mono',monospace;font-size:2rem;font-weight:700;}
.hud-time{font-size:.68rem;font-weight:800;color:var(--muted);letter-spacing:2px;}
.match-canvas-wrap{flex:1;display:flex;align-items:center;justify-content:center;background:var(--bg);position:relative;overflow:hidden;}
.match-sidebar{width:210px;flex-shrink:0;background:var(--s1);border-left:1px solid var(--bd);display:flex;flex-direction:column;}
.ms-head{padding:10px 12px;border-bottom:1px solid var(--bd);flex-shrink:0;}
.ms-title{font-size:.62rem;font-weight:800;color:var(--muted);letter-spacing:2px;text-transform:uppercase;}
.ms-log{flex:1;overflow-y:auto;padding:6px;}
.le{font-size:.72rem;padding:5px 8px;border-radius:6px;margin-bottom:3px;line-height:1.4;border-left:2px solid transparent;}
.le-goal{background:rgba(245,196,0,.08);color:var(--ye);border-color:var(--ye);font-weight:700;}
.le-action{color:var(--txt);border-color:var(--s4);}.le-chip{color:var(--cy);border-color:rgba(0,212,232,.3);}
.le-info{color:var(--muted);}.le-if{color:var(--pu);border-color:rgba(159,111,255,.3);}
.ms-ctrl{padding:8px;border-top:1px solid var(--bd);display:flex;flex-direction:column;gap:5px;}
.match-overlay{position:absolute;inset:0;background:rgba(7,8,14,.92);z-index:10;display:flex;align-items:center;justify-content:center;}
.mo-box{background:var(--s2);border:1px solid var(--bd2);border-radius:16px;padding:28px;width:360px;}
.mo-title{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;color:var(--gr);letter-spacing:3px;margin-bottom:18px;text-align:center;}
.vs-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;}
.vs-card{padding:14px;border:1px solid var(--bd);border-radius:10px;cursor:pointer;text-align:center;transition:all .15s;background:var(--s3);}
.vs-card:hover,.vs-card.on{border-color:var(--gr);background:rgba(0,229,122,.06);}
.vs-ico{font-size:1.8rem;margin-bottom:5px;}.vs-lbl{font-size:.78rem;font-weight:700;}
.dur-row{display:flex;gap:6px;margin-bottom:14px;}
.dur-btn{flex:1;padding:7px;border:1px solid var(--bd);border-radius:7px;background:var(--s3);color:var(--muted);font-family:'Syne',sans-serif;font-size:.75rem;font-weight:700;cursor:pointer;transition:all .12s;}
.dur-btn.on{border-color:var(--gr);color:var(--gr);background:rgba(0,229,122,.08);}
.mo-err{font-size:.73rem;color:var(--re);margin-top:6px;}
/* ONLINE */
.online-wrap{flex:1;overflow-y:auto;padding:20px;max-width:820px;margin:0 auto;width:100%;}
.online-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
@media(max-width:600px){.online-grid{grid-template-columns:1fr;}}
.o-card{background:var(--s2);border:1px solid var(--bd);border-radius:12px;padding:18px;}
.o-card-title{font-size:.65rem;font-weight:800;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:12px;}
.code-big{font-family:'JetBrains Mono',monospace;font-size:2.2rem;font-weight:700;letter-spacing:10px;color:var(--gr);text-align:center;padding:12px 0;}
.rec-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;}
.rec-box{background:var(--s3);border:1px solid var(--bd);border-radius:8px;padding:10px;text-align:center;}
.rec-num{font-family:'JetBrains Mono',monospace;font-size:1.3rem;font-weight:700;}
.rec-lbl{font-size:.62rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-top:2px;}
.divider{height:1px;background:var(--bd);margin:12px 0;}
@keyframes livepulse{0%,100%{opacity:1;}50%{opacity:.3;}}
.live-dot{display:inline-block;animation:livepulse 1s ease-in-out infinite;}
</style>
</head>
<body>
<div id="authScreen">
  <div class="auth-box">
    <div class="auth-logo">BIT FOOTBALL</div>
    <div class="auth-tagline">PROGRAM ¬∑ BUILD ¬∑ DOMINATE</div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
    </div>
    <div id="authForm"></div>
    <div class="auth-err" id="authErr"></div>
    <div class="auth-existing" id="authExisting"></div>
  </div>
</div>
<div id="app">
  <div class="topbar">
    <div class="topbar-logo">BIT/FB</div>
    <nav class="nav-list">
      <button class="nav-btn active" onclick="goScreen('robots',this)">ü§ñ Robots</button>
      <button class="nav-btn" onclick="goScreen('scratch',this)">üß© Program</button>
      <button class="nav-btn" onclick="goScreen('field',this)">üèü Formation</button>
      <button class="nav-btn" onclick="goScreen('match',this)">‚öΩ Match</button>
      <button class="nav-btn" onclick="goScreen('online',this)">üåê Online</button>
    </nav>
    <div class="topbar-right">
      <div class="rec-row"><span class="rb rb-w" id="recW">W 0</span><span class="rb rb-d" id="recD">D 0</span><span class="rb rb-l" id="recL">L 0</span></div>
      <div class="user-pill" onclick="signOut()"><span id="userAva">ü§ñ</span><span id="userName">‚Äî</span><span style="color:var(--muted);font-size:.65rem">‚Ü©</span></div>
    </div>
  </div>
  <div class="main">
    <div id="screen-robots" class="screen active">
      <div class="two-col">
        <div class="col-left">
          <div class="col-header"><span class="col-title">Robots</span><button class="btn btn-gr btn-sm" onclick="openNewRobotModal()">+ New</button></div>
          <div class="col-body" id="robotsList"></div>
        </div>
        <div class="col-right" id="robotEditor">
          <div class="empty-hint"><div class="big">ü§ñ</div><div class="txt">Select or create a robot</div><button class="btn btn-gr" onclick="openNewRobotModal()">+ Create Robot</button></div>
        </div>
      </div>
    </div>
    <div id="screen-scratch" class="screen">
      <div class="scratch-wrap">
        <div class="palette">
          <div class="pal-cats" id="palCats"></div>
          <div class="pal-search"><input class="inp" id="palSearch" placeholder="Search chips‚Ä¶" oninput="renderPalette()" style="font-size:.72rem;padding:5px 8px;"></div>
          <div class="pal-list" id="palList"></div>
        </div>
        <div class="prog-wrap">
          <div class="prog-tabs-row" id="progTabs"><span style="font-size:.68rem;color:var(--muted);font-weight:700;">PICK A ROBOT ‚Üí</span></div>
          <div class="prog-canvas" id="progCanvas"><div class="empty-hint"><div class="big">üß©</div><div class="txt">Pick a robot tab, drag chips in</div></div></div>
        </div>
      </div>
    </div>
    <div id="screen-field" class="screen">
      <div class="field-wrap">
        <div class="field-side">
          <div class="field-side-title">Drag onto field</div>
          <div id="fieldSideRobots"></div>
          <div class="fmt-btns">
            <div style="font-size:.62rem;color:var(--muted);font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;width:100%;">Formation</div>
            <button class="btn btn-s3 btn-xs" onclick="applyFormation('442')">4-4-2</button>
            <button class="btn btn-s3 btn-xs" onclick="applyFormation('433')">4-3-3</button>
            <button class="btn btn-s3 btn-xs" onclick="applyFormation('352')">3-5-2</button>
            <button class="btn btn-s3 btn-xs" onclick="applyFormation('532')">5-3-2</button>
          </div>
        </div>
        <div class="field-canvas-area" id="fieldCanvasArea"><canvas id="fieldCanvas"></canvas></div>
      </div>
    </div>
    <div id="screen-match" class="screen">
      <div class="match-shell">
        <div class="match-main">
          <div class="match-hud">
            <div class="hud-team"><div class="hud-name" id="hudH" style="color:var(--gr)">‚Äî</div><div class="hud-poss" id="hudPH"></div></div>
            <div class="hud-score-c">
              <div class="hud-score-row"><div class="hud-score" id="hudSH">0</div><div style="font-family:'JetBrains Mono',monospace;font-size:1.2rem;color:var(--muted)">:</div><div class="hud-score" id="hudSA">0</div></div>
              <div class="hud-time" id="hudTime">‚Äî</div>
            </div>
            <div class="hud-team" style="align-items:flex-end"><div class="hud-name" id="hudA" style="color:var(--re)">‚Äî</div><div class="hud-poss" id="hudPA"></div></div>
          </div>
          <div class="match-canvas-wrap" id="matchCanvasWrap">
            <canvas id="matchCanvas"></canvas>
            <div class="match-overlay" id="matchOverlay">
              <div class="mo-box">
                <div class="mo-title">‚öΩ KICK OFF</div>
                <div class="vs-grid">
                  <div class="vs-card on" id="vsAI" onclick="pickVs('ai')"><div class="vs-ico">ü§ñ</div><div class="vs-lbl">vs AI</div></div>
                  <div class="vs-card" id="vsFriend" onclick="pickVs('friend')"><div class="vs-ico">üë•</div><div class="vs-lbl">vs Friend</div></div>
                </div>
                <div id="friendCodeRow" style="display:none;margin-bottom:10px;"><input class="inp" id="friendCodeInp" placeholder="Friend's 4-char code‚Ä¶" maxlength="4" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')"></div>
                <div style="font-size:.65rem;font-weight:800;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Duration</div>
                <div class="dur-row">
                  <button class="dur-btn" onclick="pickDur(60,this)">1 min</button>
                  <button class="dur-btn on" onclick="pickDur(180,this)">3 min</button>
                  <button class="dur-btn" onclick="pickDur(300,this)">5 min</button>
                </div>
                <button class="btn btn-gr" style="width:100%;justify-content:center;padding:11px;" onclick="kickOff()">‚öΩ Kick Off!</button>
                <div class="mo-err" id="moErr"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="match-sidebar">
          <div class="ms-head"><div class="ms-title">Match Log</div></div>
          <div class="ms-log" id="matchLog"></div>
          <div class="ms-ctrl">
            <button class="btn btn-s3 btn-sm" id="speedBtn" onclick="toggleSpeed()" style="justify-content:center;">‚è© 3√ó Speed</button>
            <button class="btn btn-re btn-sm" onclick="stopMatch()" style="justify-content:center;">‚èπ Stop & Reset</button>
          </div>
        </div>
      </div>
    </div>
    <div id="screen-online" class="screen">
      <div class="online-wrap">
        <div class="online-grid">
          <div class="o-card">
            <div class="o-card-title">Your Team Code</div>
            <div class="code-big" id="myCodeDisplay">----</div>
            <div style="font-size:.73rem;color:var(--muted);text-align:center;margin-bottom:10px;">Share so friends can challenge you</div>
            <div style="display:flex;gap:6px;justify-content:center;"><button class="btn btn-gr btn-sm" onclick="genCode()">Generate</button><button class="btn btn-s3 btn-sm" onclick="copyCode()">Copy</button></div>
            <div class="divider"></div>
            <div class="o-card-title">Your Record</div>
            <div class="rec-grid">
              <div class="rec-box"><div class="rec-num" style="color:var(--gr)" id="oRecW">0</div><div class="rec-lbl">Wins</div></div>
              <div class="rec-box"><div class="rec-num" style="color:var(--muted)" id="oRecD">0</div><div class="rec-lbl">Draws</div></div>
              <div class="rec-box"><div class="rec-num" style="color:var(--re)" id="oRecL">0</div><div class="rec-lbl">Losses</div></div>
            </div>
          </div>
          <div class="o-card">
            <div class="o-card-title">Challenge a Friend</div>
            <input class="inp" id="challengeInp" placeholder="Enter friend's code‚Ä¶" maxlength="4" oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')" style="margin-bottom:10px;">
            <button class="btn btn-bl" style="width:100%;justify-content:center;" onclick="loadChallenge()">‚öîÔ∏è Challenge!</button>
            <div class="divider"></div>
            <div class="o-card-title">How It Works</div>
            <div style="font-size:.76rem;color:var(--muted);line-height:1.9;">1. Build &amp; program your robots<br>2. Generate a Team Code<br>3. Share it with a friend<br>4. Enter their code to battle<br>5. Results update your record</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal-wrap" id="robotModal">
  <div class="modal">
    <div class="modal-title">Create Robot</div>
    <div style="text-align:center;margin-bottom:14px;">
      <div id="newRobotAva" onclick="openEmojiModal()" style="font-size:2.5rem;cursor:pointer;display:inline-block;padding:10px 16px;border-radius:14px;background:var(--s3);border:2px solid var(--bd2);">ü§ñ</div>
      <div style="font-size:.62rem;color:var(--muted);margin-top:4px;">Click to change</div>
    </div>
    <div style="margin-bottom:10px;"><label class="af-label">Name</label><input class="inp" id="newRobotName" placeholder="Robot name‚Ä¶"></div>
    <div style="margin-bottom:10px;"><label class="af-label">Color</label><div class="cpal" id="newRobotColors"></div></div>
    <label class="af-label" style="margin-bottom:6px;display:block;">Stats</label>
    <div id="newRobotStats"></div>
    <div class="modal-footer"><button class="btn btn-s3" onclick="closeModal('robotModal')">Cancel</button><button class="btn btn-gr" onclick="saveNewRobot()">Create</button></div>
  </div>
</div>
<div class="modal-wrap" id="emojiModal">
  <div class="modal" style="width:300px;">
    <div class="modal-title">Pick Icon</div>
    <div class="emo-grid" id="emojiGrid"></div>
    <div class="modal-footer"><button class="btn btn-s3" onclick="closeModal('emojiModal')">Close</button></div>
  </div>
</div>
<div id="toast"></div>
<script>
'use strict';
const COLORS=['#00e57a','#3d7eff','#ff7a2f','#ff3d5a','#9f6fff','#00d4e8','#f5c400','#ff4fa3','#00d4a8','#7bed9f','#ffa502','#ff6b6b'];
const EMOJIS=['ü§ñ','ü¶æ','üõ°Ô∏è','‚ö°','üî•','üå™Ô∏è','üíé','üß†','üèãÔ∏è','üí®','üéØ','üöÄ','üëæ','ü¶ø','‚öôÔ∏è','üî©','üí™','üåü','üéÆ','üïπÔ∏è','üèÜ','üëä','üõ∏','ü§Ø','ü¶Ö','üêâ','üåä','‚òÑÔ∏è','ü™Ñ','üé™'];
const CC={move:{l:'MOVE',c:'#00e57a',b:'rgba(0,229,122,.13)'},attack:{l:'ATTACK',c:'#ff7a2f',b:'rgba(255,122,47,.13)'},defend:{l:'DEFEND',c:'#3d7eff',b:'rgba(61,127,255,.13)'},special:{l:'SPECIAL',c:'#9f6fff',b:'rgba(159,111,255,.13)'},support:{l:'SUPPORT',c:'#00d4a8',b:'rgba(0,212,168,.13)'},trick:{l:'TRICK',c:'#ff4fa3',b:'rgba(255,79,163,.13)'}};
const CHIPS=[
  {id:'m01',cat:'move',icon:'üèÉ',name:'Sprint',desc:'Charge straight at goal',pow:3,spd:4,def:0},
  {id:'m02',cat:'move',icon:'‚ÜîÔ∏è',name:'Wide Run',desc:'Spread play to wings',pow:1,spd:3,def:0},
  {id:'m03',cat:'move',icon:'üéØ',name:'Through Ball',desc:'Split the defensive line',pow:2,spd:3,def:1},
  {id:'m04',cat:'move',icon:'‚§¥Ô∏è',name:'Lofted Pass',desc:'Launch ball over midfield',pow:1,spd:2,def:0},
  {id:'m05',cat:'move',icon:'üîÄ',name:'Overlap Run',desc:'Full-back charges forward',pow:2,spd:3,def:0},
  {id:'m06',cat:'move',icon:'ü§≤',name:'Short Pass',desc:'Keep possession safely',pow:0,spd:1,def:2},
  {id:'m07',cat:'move',icon:'ü™Ñ',name:'Dummy Run',desc:'Decoy to open space',pow:1,spd:2,def:0},
  {id:'m08',cat:'move',icon:'‚ö°',name:'Counter Attack',desc:'Rapid transition on turnover',pow:3,spd:5,def:0},
  {id:'m09',cat:'move',icon:'üåä',name:'Tidal Pass',desc:'Fluid side-to-side passing',pow:1,spd:2,def:2},
  {id:'m10',cat:'move',icon:'üîÉ',name:'Recycle Ball',desc:'Pass back to reset play',pow:0,spd:0,def:3},
  {id:'m11',cat:'move',icon:'üß≤',name:'Magnet Run',desc:'Draw defenders then release',pow:2,spd:2,def:1},
  {id:'m12',cat:'move',icon:'üéµ',name:'Slow Buildup',desc:'Patient passing from deep',pow:0,spd:0,def:3},
  {id:'a01',cat:'attack',icon:'üí•',name:'Power Shot',desc:'Max force strike on goal',pow:5,spd:1,def:0},
  {id:'a02',cat:'attack',icon:'üîÑ',name:'Dribble',desc:'Weave past defenders',pow:2,spd:2,def:0},
  {id:'a03',cat:'attack',icon:'ü™Å',name:'Chip Shot',desc:'Lob over the keeper',pow:3,spd:1,def:0},
  {id:'a04',cat:'attack',icon:'üß†',name:'Header',desc:'Aerial attack from cross',pow:4,spd:0,def:0},
  {id:'a05',cat:'attack',icon:'ü¶∂',name:'Volley',desc:'Strike without trapping',pow:4,spd:2,def:0},
  {id:'a06',cat:'attack',icon:'‚ÜòÔ∏è',name:'Low Cross',desc:'Cut back to penalty spot',pow:2,spd:2,def:0},
  {id:'a07',cat:'attack',icon:'üíÉ',name:'Step Over',desc:'Faked touch to beat marker',pow:2,spd:1,def:0},
  {id:'a08',cat:'attack',icon:'üèì',name:'One-Two',desc:'Quick wall pass and run',pow:3,spd:3,def:0},
  {id:'a09',cat:'attack',icon:'üåÄ',name:'Spin Dribble',desc:'360 spin past defender',pow:2,spd:2,def:0},
  {id:'a10',cat:'attack',icon:'üéØ',name:'Precision Shot',desc:'Aim for the top corner',pow:4,spd:0,def:0},
  {id:'a11',cat:'attack',icon:'üî•',name:'Rabona',desc:'Crossed-foot surprise shot',pow:3,spd:1,def:0},
  {id:'a12',cat:'attack',icon:'üåä',name:'Bicycle Kick',desc:'Overhead scissor kick',pow:5,spd:0,def:0},
  {id:'a13',cat:'attack',icon:'üé™',name:'Nutmeg',desc:'Ball through defender legs',pow:2,spd:3,def:0},
  {id:'a14',cat:'attack',icon:'‚òÑÔ∏è',name:'Knuckleball',desc:'Swerving unpredictable shot',pow:4,spd:1,def:0},
  {id:'a15',cat:'attack',icon:'üëä',name:'Shoulder Barge',desc:'Barge through the defender',pow:3,spd:1,def:0},
  {id:'d01',cat:'defend',icon:'‚¨ÜÔ∏è',name:'Tackle',desc:'Slide in to win the ball',pow:0,spd:1,def:5},
  {id:'d02',cat:'defend',icon:'üß±',name:'Block',desc:'Intercept the shot',pow:0,spd:0,def:5},
  {id:'d03',cat:'defend',icon:'‚¨áÔ∏è',name:'Drop Back',desc:'Retreat into compact shape',pow:0,spd:0,def:4},
  {id:'d04',cat:'defend',icon:'ü´∏',name:'High Press',desc:'Aggressive pressing high up',pow:0,spd:2,def:4},
  {id:'d05',cat:'defend',icon:'üîí',name:'Tight Marking',desc:'Shadow the striker closely',pow:0,spd:1,def:4},
  {id:'d06',cat:'defend',icon:'ü´¥',name:'Interception',desc:'Read and cut the pass',pow:0,spd:2,def:5},
  {id:'d07',cat:'defend',icon:'ü•Ö',name:'Keeper Rush',desc:'GK sweeps off their line',pow:0,spd:1,def:5},
  {id:'d08',cat:'defend',icon:'ü¶µ',name:'Clearance',desc:'Boot it far out of danger',pow:0,spd:0,def:4},
  {id:'d09',cat:'defend',icon:'üè∞',name:'Park the Bus',desc:'All 10 behind the ball',pow:0,spd:0,def:6},
  {id:'d10',cat:'defend',icon:'üï∏Ô∏è',name:'Spider Web',desc:'Trap the attacker',pow:0,spd:0,def:5},
  {id:'d11',cat:'defend',icon:'ü™§',name:'Offside Trap',desc:'Synced last-man run',pow:0,spd:1,def:5},
  {id:'d12',cat:'defend',icon:'üõ°Ô∏è',name:'Shield',desc:'Body-block incoming shot',pow:0,spd:0,def:6},
  {id:'s01',cat:'special',icon:'‚ú®',name:'Super Shot',desc:'Unstoppable legendary strike',pow:7,spd:0,def:0},
  {id:'s02',cat:'special',icon:'üåÄ',name:'Tornado Spin',desc:'Confuse every defender',pow:4,spd:4,def:0},
  {id:'s03',cat:'special',icon:'üöÄ',name:'Rocket Pass',desc:'50-yard pinpoint laser',pow:3,spd:5,def:0},
  {id:'s04',cat:'special',icon:'üí´',name:'Turbo Burst',desc:'Max speed sprint',pow:2,spd:7,def:0},
  {id:'s05',cat:'special',icon:'üò§',name:'Berserk Mode',desc:'All stats triple boost',pow:5,spd:5,def:3},
  {id:'s06',cat:'special',icon:'ü™É',name:'Curveball',desc:'Bending shot around wall',pow:5,spd:1,def:0},
  {id:'s07',cat:'special',icon:'üåü',name:'Golden Touch',desc:'Perfect first touch',pow:3,spd:2,def:1},
  {id:'s08',cat:'special',icon:'üèÜ',name:'Clutch Play',desc:'Elevates under pressure',pow:4,spd:3,def:2},
  {id:'s09',cat:'special',icon:'üêâ',name:'Dragon Shot',desc:'A truly legendary strike',pow:8,spd:0,def:0},
  {id:'s10',cat:'special',icon:'üåä',name:'Tidal Wave',desc:'Overwhelming surge forward',pow:5,spd:4,def:0},
  {id:'s11',cat:'special',icon:'ü¶Ö',name:'Eagle Eye',desc:'Spots any open teammate',pow:2,spd:2,def:1},
  {id:'s12',cat:'special',icon:'üéÆ',name:'Overclock',desc:'Execute two chips this tick',pow:3,spd:3,def:2},
  {id:'p01',cat:'support',icon:'üë•',name:'Team Press',desc:'Whole team presses together',pow:0,spd:2,def:3},
  {id:'p02',cat:'support',icon:'üìê',name:'Set Piece',desc:'Organized dead-ball routine',pow:3,spd:0,def:1},
  {id:'p03',cat:'support',icon:'üéµ',name:'Tempo Control',desc:'Slow it down, hold possession',pow:0,spd:0,def:2},
  {id:'p04',cat:'support',icon:'üé≠',name:'False Nine',desc:'Striker drops to confuse',pow:2,spd:2,def:1},
  {id:'p05',cat:'support',icon:'üåê',name:'Long Ball',desc:'Bypass midfield entirely',pow:2,spd:2,def:0},
  {id:'p06',cat:'support',icon:'üí°',name:'Vision Pass',desc:'Always find best option',pow:1,spd:2,def:1},
  {id:'p07',cat:'support',icon:'üîã',name:'Energy Boost',desc:'Boost a teammate next turn',pow:0,spd:3,def:1},
  {id:'p08',cat:'support',icon:'üß¨',name:'Adapt',desc:'Copy opponent best chip',pow:2,spd:2,def:2},
  {id:'p09',cat:'support',icon:'üì°',name:'Intel Scan',desc:'Reveals opponent weakness',pow:0,spd:0,def:3},
  {id:'p10',cat:'support',icon:'üéØ',name:'Precision Drill',desc:'Drilled passing sequence',pow:1,spd:1,def:2},
  {id:'t01',cat:'trick',icon:'üé©',name:'Vanishing Act',desc:'Disappear from all markers',pow:2,spd:4,def:0},
  {id:'t02',cat:'trick',icon:'üÉè',name:'Bluff Run',desc:'Fake direction then burst',pow:2,spd:4,def:0},
  {id:'t03',cat:'trick',icon:'üåà',name:'Rainbow Flick',desc:'Flick ball over a head',pow:3,spd:2,def:0},
  {id:'t04',cat:'trick',icon:'üé™',name:'Circus Kick',desc:'Impossible acrobatic strike',pow:4,spd:1,def:0},
  {id:'t05',cat:'trick',icon:'ü™©',name:'Disco Dribble',desc:'Completely unpredictable moves',pow:2,spd:3,def:0},
  {id:'t06',cat:'trick',icon:'üïµÔ∏è',name:'Shadow Step',desc:'Move without being tracked',pow:1,spd:5,def:0},
  {id:'t07',cat:'trick',icon:'üé≠',name:'Puppet Master',desc:'Control where defenders move',pow:2,spd:2,def:2},
  {id:'t08',cat:'trick',icon:'üé≤',name:'Wild Card',desc:'Completely random action',pow:3,spd:3,def:2},
];
const IF_CONDS=[
  {id:'winning',l:'score is winning'},{id:'losing',l:'score is losing'},{id:'drawing',l:'score is a draw'},
  {id:'possession',l:'team has possession'},{id:'no_poss',l:'team lost possession'},
  {id:'early',l:'first half of match'},{id:'late',l:'second half of match'},
  {id:'close',l:'score within 1 goal'},{id:'high_spd',l:'robot speed > 7'},
  {id:'high_str',l:'robot strength > 7'},{id:'high_int',l:'robot intelligence > 7'},
  {id:'random',l:'50% chance'},
];

// STATE
let ACCOUNTS={},CUR=null,DRAG=null,SEL_ROBOT=null,PROG_ROBOT=null,PAL_CAT='move';
let _emojiCb=null,_newEmoji='ü§ñ',_newColor=COLORS[0],_newStats={spd:5,str:5,int:5};
let fCanvas,fCtx,fDragId=null,mCanvas,mCtx,mRAF=null;
let MS={running:false,speed:1,vsMode:'ai',duration:180};
let MG={};

function acct(){return ACCOUNTS[CUR];}
function save(){localStorage.setItem('bf3_acc',JSON.stringify(ACCOUNTS));localStorage.setItem('bf3_cur',CUR||'');}
function loadSt(){try{ACCOUNTS=JSON.parse(localStorage.getItem('bf3_acc')||'{}');}catch(e){ACCOUNTS={};}CUR=localStorage.getItem('bf3_cur')||null;}

let _tt;
function toast(m,t='ok'){const el=document.getElementById('toast');el.textContent=m;el.className='show '+(t==='err'?'err':'ok');clearTimeout(_tt);_tt=setTimeout(()=>el.className='',2400);}
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}

// AUTH
let authMode='login';
function switchAuthTab(t){authMode=t;document.querySelectorAll('.auth-tab').forEach((b,i)=>b.classList.toggle('active',(i===0&&t==='login')||(i===1&&t==='register')));renderAuthForm();}
function renderAuthForm(){
  document.getElementById('authErr').textContent='';
  const el=document.getElementById('authForm');
  if(authMode==='login'){
    el.innerHTML=`<div class="af-field"><label class="af-label">Username</label><input class="af-input" id="liU" placeholder="username" autocomplete="username"></div><div class="af-field"><label class="af-label">Password</label><input class="af-input" type="password" id="liP" placeholder="password" onkeydown="if(event.key==='Enter')doLogin()"></div><button class="af-btn" onclick="doLogin()">Sign In</button>`;
  }else{
    el.innerHTML=`<div class="af-field"><label class="af-label">Username</label><input class="af-input" id="rU" placeholder="choose username"></div><div class="af-field"><label class="af-label">Password</label><input class="af-input" type="password" id="rP" placeholder="choose password"></div><div class="af-field"><label class="af-label">Team Name</label><input class="af-input" id="rT" placeholder="e.g. Robo Rockets"></div><button class="af-btn" onclick="doRegister()">Create Account</button>`;
  }
  renderExisting();
}
function renderExisting(){
  const names=Object.keys(ACCOUNTS);const el=document.getElementById('authExisting');
  if(!names.length){el.innerHTML='';return;}
  el.innerHTML=`<div class="ae-title">Saved Accounts</div>`+names.map(n=>{const a=ACCOUNTS[n];return`<div class="ae-pill" onclick="quickLogin('${n}')"><span style="font-size:1.1rem">${a.avatar||'ü§ñ'}</span><span>${n}</span><span style="color:var(--muted);font-size:.7rem;">${a.teamName||''}</span><button class="ae-del" onclick="delAcc(event,'${n}')">‚úï</button></div>`;}).join('');
}
function doLogin(){
  const u=document.getElementById('liU').value.trim(),p=document.getElementById('liP').value;
  if(!u||!p){document.getElementById('authErr').textContent='Fill in both fields.';return;}
  if(!ACCOUNTS[u]){document.getElementById('authErr').textContent='Account not found.';return;}
  if(ACCOUNTS[u].password!==btoa(p)){document.getElementById('authErr').textContent='Wrong password.';return;}
  loginAs(u);
}
function doRegister(){
  const u=document.getElementById('rU').value.trim(),p=document.getElementById('rP').value,t=document.getElementById('rT').value.trim()||'Team';
  if(!u||!p){document.getElementById('authErr').textContent='Fill in all fields.';return;}
  if(u.length<3){document.getElementById('authErr').textContent='Username 3+ chars.';return;}
  if(ACCOUNTS[u]){document.getElementById('authErr').textContent='Username taken.';return;}
  ACCOUNTS[u]={password:btoa(p),teamName:t,avatar:'ü§ñ',color:COLORS[Math.floor(Math.random()*COLORS.length)],robots:[],field:{},programs:{},record:{w:0,d:0,l:0},code:null};
  save();loginAs(u);
}
function quickLogin(u){CUR=u;save();enterApp();}
function loginAs(u){CUR=u;save();enterApp();}
function delAcc(e,u){e.stopPropagation();if(!confirm(`Delete "${u}"?`))return;delete ACCOUNTS[u];save();renderExisting();}
function signOut(){CUR=null;save();document.getElementById('app').className='';document.getElementById('app').style.display='none';document.getElementById('authScreen').style.display='flex';renderAuthForm();}
function enterApp(){
  document.getElementById('authScreen').style.display='none';
  const app=document.getElementById('app');app.style.display='flex';app.className='on';
  document.getElementById('userName').textContent=CUR;document.getElementById('userAva').textContent=acct().avatar||'ü§ñ';
  if(!acct().programs)acct().programs={};if(!acct().field)acct().field={};if(!acct().record)acct().record={w:0,d:0,l:0};
  updateRec();renderRobotsList();renderScratchTabs();renderFieldSide();renderOnline();
}

// NAVIGATION
function goScreen(id,btn){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('screen-'+id).classList.add('active');
  if(btn)btn.classList.add('active');
  if(id==='scratch')renderScratchFull();
  if(id==='field')renderFieldScreen();
  if(id==='online')renderOnline();
}

// ROBOTS
function renderRobotsList(){
  const el=document.getElementById('robotsList'),R=acct().robots||[];
  if(!R.length){el.innerHTML=`<div class="empty-hint"><div class="big">ü§ñ</div><div class="txt">No robots yet!</div><button class="btn btn-gr btn-sm" onclick="openNewRobotModal()">+ Create</button></div>`;return;}
  el.innerHTML=R.map(r=>`<div class="rli${SEL_ROBOT===r.id?' sel':''}" onclick="selectRobot('${r.id}')">
    <div class="rli-ava" style="background:${r.color}22;border:1px solid ${r.color}44">${r.emoji}</div>
    <div style="flex:1;min-width:0;"><div class="rli-name">${r.name}</div><div class="rli-sub">SPD${r.spd} STR${r.str} INT${r.int}</div></div>
    <span class="rli-ct">${countChips(r.id)}üß©</span>
  </div>`).join('');
}
function countChips(rid){let n=0;function w(s){s.forEach(i=>{if(i.type==='chip')n++;else if(i.type==='if'){w(i.then||[]);w(i.else||[]);}});}w(acct().programs[rid]||[]);return n;}
function selectRobot(id){SEL_ROBOT=id;renderRobotsList();renderRobotEditor();}
function renderRobotEditor(){
  const r=acct().robots.find(x=>x.id===SEL_ROBOT);if(!r)return;
  const el=document.getElementById('robotEditor');
  const sc=(s,c)=>`<div class="stat-c"><div class="lbl">${s.toUpperCase()}</div><div class="val" style="color:${c}">${r[s]}</div><div class="bar"><div class="bfill" style="width:${r[s]*10}%;background:${c}"></div></div><div class="adj"><button class="btn btn-s3 btn-xs" onclick="adjStat('${r.id}','${s}',-1)">‚àí</button><button class="btn btn-s3 btn-xs" onclick="adjStat('${r.id}','${s}',+1)">+</button></div></div>`;
  el.innerHTML=`<div class="re-sec"><div style="display:flex;align-items:center;gap:14px;"><div style="width:60px;height:60px;border-radius:14px;background:${r.color}22;border:2px solid ${r.color}55;display:flex;align-items:center;justify-content:center;font-size:2rem;cursor:pointer;flex-shrink:0;" onclick="openEmojiForRobot('${r.id}')">${r.emoji}</div><div style="flex:1;min-width:0;"><input class="inp" value="${r.name}" onchange="renameRobot('${r.id}',this.value)" style="font-weight:700;margin-bottom:7px;"><div class="cpal">${COLORS.map(c=>`<div class="csw${r.color===c?' on':''}" style="background:${c}" onclick="recolorRobot('${r.id}','${c}')"></div>`).join('')}</div></div></div></div>
  <div class="re-sec"><div class="re-stitle">Stats</div><div class="stat3">${sc('spd','#00e57a')}${sc('str','#ff7a2f')}${sc('int','#9f6fff')}</div></div>
  <div class="re-sec"><div class="re-stitle" style="display:flex;align-items:center;justify-content:space-between;">Chip Program<button class="btn btn-s3 btn-xs" onclick="goScreen('scratch',null);setTimeout(()=>openProgramTab('${r.id}'),50)">Edit ‚Üí</button></div><div style="font-size:.72rem;color:var(--muted);">${countChips(r.id)} chips programmed</div></div>
  <button class="btn btn-re btn-sm" onclick="deleteRobot('${r.id}')">Delete Robot</button>`;
}
function adjStat(id,s,d){const r=acct().robots.find(x=>x.id===id);if(!r)return;r[s]=Math.max(1,Math.min(10,r[s]+d));save();renderRobotEditor();}
function renameRobot(id,v){const r=acct().robots.find(x=>x.id===id);if(r){r.name=v;save();renderRobotsList();}}
function recolorRobot(id,c){const r=acct().robots.find(x=>x.id===id);if(r){r.color=c;save();renderRobotsList();renderRobotEditor();}}
function deleteRobot(id){if(!confirm('Delete this robot?'))return;acct().robots=acct().robots.filter(x=>x.id!==id);delete acct().programs[id];delete acct().field[id];SEL_ROBOT=null;save();renderRobotsList();document.getElementById('robotEditor').innerHTML=`<div class="empty-hint"><div class="big">ü§ñ</div><div class="txt">Select a robot to edit</div></div>`;}
function openEmojiForRobot(id){openEmojiModal(e=>{const r=acct().robots.find(x=>x.id===id);if(r){r.emoji=e;save();renderRobotsList();renderRobotEditor();}});}

// NEW ROBOT MODAL
function openNewRobotModal(){
  _newEmoji='ü§ñ';_newColor=COLORS[0];_newStats={spd:5,str:5,int:5};
  document.getElementById('newRobotName').value='';document.getElementById('newRobotAva').textContent='ü§ñ';document.getElementById('newRobotAva').style.background='';
  document.getElementById('newRobotColors').innerHTML=COLORS.map(c=>`<div class="csw${c===_newColor?' on':''}" style="background:${c}" onclick="pickNewCol('${c}')"></div>`).join('');
  renderNewStats();openModal('robotModal');
}
function renderNewStats(){
  document.getElementById('newRobotStats').innerHTML=['spd','str','int'].map((s,i)=>{
    const c=['#00e57a','#ff7a2f','#9f6fff'][i],n=['SPEED','STRENGTH','INTELLIGENCE'][i];
    return `<div style="margin-bottom:7px;"><div style="display:flex;justify-content:space-between;margin-bottom:3px;"><span style="font-size:.65rem;font-weight:800;color:${c};letter-spacing:1px;">${n}</span><span id="nrv_${s}" style="font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:700;color:${c}">5</span></div><input type="range" min="1" max="10" value="5" style="width:100%;accent-color:${c}" oninput="_newStats.${s}=+this.value;document.getElementById('nrv_${s}').textContent=this.value"></div>`;
  }).join('');
}
function pickNewCol(c){_newColor=c;document.getElementById('newRobotAva').style.background=c+'22';document.querySelectorAll('#newRobotColors .csw').forEach(s=>{s.classList.toggle('on',s.style.background===c||s.style.backgroundColor===c);});}
function openEmojiModal(cb){_emojiCb=cb||null;document.getElementById('emojiGrid').innerHTML=EMOJIS.map(e=>`<div class="emo-opt" onclick="pickEmoji('${e}')">${e}</div>`).join('');openModal('emojiModal');}
function pickEmoji(e){_newEmoji=e;const av=document.getElementById('newRobotAva');if(av)av.textContent=e;if(_emojiCb){_emojiCb(e);_emojiCb=null;}closeModal('emojiModal');}
function saveNewRobot(){
  const name=document.getElementById('newRobotName').value.trim();
  if(!name){toast('Enter a name','err');return;}
  const r={id:'r'+Date.now(),name,emoji:_newEmoji,color:_newColor,spd:_newStats.spd,str:_newStats.str,int:_newStats.int};
  acct().robots.push(r);acct().programs[r.id]=[];
  save();closeModal('robotModal');renderRobotsList();selectRobot(r.id);renderScratchTabs();toast('Robot created!');
}

// SCRATCH EDITOR
function renderScratchFull(){renderPalette();renderScratchTabs();if(PROG_ROBOT)renderProgram();}
function renderPalette(){
  const q=(document.getElementById('palSearch')?.value||'').toLowerCase();
  document.getElementById('palCats').innerHTML=Object.entries(CC).map(([id,c])=>
    `<button class="pc-btn${PAL_CAT===id?' on':''}" style="background:${c.b};color:${c.c};border:1px solid ${PAL_CAT===id?c.c:'transparent'}" onclick="setPalCat('${id}')">${c.l}</button>`
  ).join('');
  let chips=q?CHIPS.filter(c=>c.name.toLowerCase().includes(q)||c.desc.toLowerCase().includes(q)):CHIPS.filter(c=>c.cat===PAL_CAT);
  document.getElementById('palList').innerHTML=chips.map(c=>`<div class="blk" draggable="true" style="background:${CC[c.cat].b};border-left-color:${CC[c.cat].c}" ondragstart="startDrag(event,'${c.id}')"><span class="blk-icon">${c.icon}</span><div><div class="blk-name">${c.name}</div><div class="blk-sub">${c.desc}</div></div></div>`).join('');
}
function setPalCat(cat){PAL_CAT=cat;renderPalette();}
function startDrag(e,id){DRAG={type:'chip',id};e.dataTransfer.effectAllowed='copy';}

function renderScratchTabs(){
  const el=document.getElementById('progTabs'),R=acct()?.robots||[];
  if(!R.length){el.innerHTML=`<span style="font-size:.68rem;color:var(--muted);font-weight:700;">CREATE ROBOTS FIRST</span>`;return;}
  el.innerHTML=`<span style="font-size:.62rem;color:var(--muted);font-weight:700;letter-spacing:1px;white-space:nowrap;flex-shrink:0;">ROBOT:</span>`+
    R.map(r=>`<div class="rtab${PROG_ROBOT===r.id?' on':''}" onclick="openProgramTab('${r.id}')"><span>${r.emoji}</span><span>${r.name}</span></div>`).join('');
}
function openProgramTab(id){PROG_ROBOT=id;renderScratchTabs();renderProgram();}

function renderProgram(){
  const el=document.getElementById('progCanvas');
  const r=acct().robots.find(x=>x.id===PROG_ROBOT);
  if(!r){el.innerHTML=`<div class="empty-hint"><div class="big">üß©</div><div class="txt">Select a robot tab</div></div>`;return;}
  if(!acct().programs[PROG_ROBOT])acct().programs[PROG_ROBOT]=[];
  const prog=acct().programs[PROG_ROBOT];
  const seq=document.createElement('div');seq.className='prog-seq';
  const startDiv=document.createElement('div');startDiv.className='start-blk';startDiv.innerHTML=`<span>‚ñ∂</span><span>START</span><span style="opacity:.5">‚Äî</span><span>${r.emoji} ${r.name}</span>`;
  seq.appendChild(startDiv);
  renderSeqInto(seq,prog,[]);
  seq.appendChild(mkDZ([]));
  const endDiv=document.createElement('div');endDiv.className='end-blk';endDiv.textContent='‚ñ† END';seq.appendChild(endDiv);
  const acts=document.createElement('div');acts.className='prog-actions';
  acts.innerHTML=`<button class="add-if-btn" onclick="addIfBlock()">üîÄ + IF / ELSE block</button><button class="btn btn-re btn-xs" onclick="clearProgram()">üóë Clear All</button>`;
  el.innerHTML='';el.appendChild(seq);el.appendChild(acts);
}
function renderSeqInto(parent,seq,path){
  seq.forEach((item,i)=>{
    if(item.type==='chip'){parent.appendChild(mkChipBlk(item,i,path));parent.appendChild(mkDZ([...path,i+1]));}
    else if(item.type==='if'){parent.appendChild(mkIfBlk(item,i,path));}
  });
}
function mkChipBlk(item,i,path){
  const c=CHIPS.find(x=>x.id===item.id),cc=CC[c?.cat||'move'];
  const d=document.createElement('div');d.className='prog-blk';d.style.background=cc.b;d.style.borderLeftColor=cc.c;
  d.innerHTML=`<span class="pb-num">${i+1}</span><span class="pb-icon">${c?.icon||'?'}</span><span class="pb-label">${c?.name||'Unknown'}</span><span class="pb-cat" style="background:${cc.b};color:${cc.c}">${(c?.cat||'').toUpperCase()}</span><button class="pb-del" onclick="removeBlock(${JSON.stringify([...path,i])})">‚úï</button>`;
  return d;
}
function mkIfBlk(item,i,path){
  const wrap=document.createElement('div');wrap.className='if-wrap';
  const head=document.createElement('div');head.className='if-head';
  const sel=document.createElement('select');sel.className='if-cond-sel';
  IF_CONDS.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent='IF '+c.l;o.selected=c.id===item.cond;sel.appendChild(o);});
  sel.onchange=()=>{item.cond=sel.value;save();};
  const del=document.createElement('button');del.className='pb-del';del.textContent='‚úï';del.onclick=()=>removeBlock([...path,i]);
  head.innerHTML='<span style="font-size:.9rem">üîÄ</span>';head.appendChild(sel);head.appendChild(del);
  wrap.appendChild(head);
  const thenBody=document.createElement('div');thenBody.className='if-body';
  renderSeqInto(thenBody,item.then||[],...[[...path,i,'then']]);
  thenBody.appendChild(mkDZ([...path,i,'then']));
  wrap.appendChild(thenBody);
  const elHead=document.createElement('div');elHead.className='else-head';elHead.innerHTML='<span>‚Ü≥</span><span>ELSE</span>';wrap.appendChild(elHead);
  const elBody=document.createElement('div');elBody.className='else-body';
  renderSeqInto(elBody,item.else||[],...[[...path,i,'else']]);
  elBody.appendChild(mkDZ([...path,i,'else']));
  wrap.appendChild(elBody);
  const endDiv=document.createElement('div');endDiv.className='if-end';endDiv.textContent='END IF';wrap.appendChild(endDiv);
  return wrap;
}
function mkDZ(path){
  const dz=document.createElement('div');dz.className='dz';dz.textContent='+ drop chip here';
  dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('over');});
  dz.addEventListener('dragleave',()=>dz.classList.remove('over'));
  dz.addEventListener('drop',e=>{
    e.preventDefault();dz.classList.remove('over');
    if(!DRAG||DRAG.type!=='chip')return;
    insertBlock(path,{type:'chip',id:DRAG.id});DRAG=null;
  });
  return dz;
}
function getSeq(path){
  let cur=acct().programs[PROG_ROBOT];
  for(const s of path){if(typeof s==='number')cur=cur[s];else cur=cur[s];}
  return cur;
}
function insertBlock(path,item){
  if(!path.length||typeof path[path.length-1]==='string'){const s=getSeq(path);if(Array.isArray(s))s.push(item);}
  else{const idx=path[path.length-1];const s=getSeq(path.slice(0,-1));if(Array.isArray(s))s.splice(idx,0,item);}
  save();renderProgram();renderRobotsList();
}
function removeBlock(path){
  const idx=path[path.length-1];const s=getSeq(path.slice(0,-1));if(Array.isArray(s))s.splice(idx,1);
  save();renderProgram();renderRobotsList();
}
function addIfBlock(){
  if(!PROG_ROBOT){toast('Select a robot first','err');return;}
  acct().programs[PROG_ROBOT].push({type:'if',cond:'winning',then:[],else:[]});
  save();renderProgram();
}
function clearProgram(){if(!PROG_ROBOT)return;if(!confirm('Clear all chips?'))return;acct().programs[PROG_ROBOT]=[];save();renderProgram();renderRobotsList();}

// FIELD
function renderFieldSide(){
  const placed=Object.keys(acct().field||{});
  document.getElementById('fieldSideRobots').innerHTML=(acct().robots||[]).map(r=>`<div class="frd${placed.includes(r.id)?' placed':''}" draggable="true" ondragstart="fDragStart(event,'${r.id}')"><span>${r.emoji}</span><span>${r.name}</span></div>`).join('');
}
function renderFieldScreen(){
  renderFieldSide();
  fCanvas=document.getElementById('fieldCanvas');
  const area=document.getElementById('fieldCanvasArea');
  const W=area.clientWidth-24,H=Math.min(area.clientHeight-24,W*.62);
  fCanvas.width=W;fCanvas.height=H;fCtx=fCanvas.getContext('2d');
  fCanvas.ondragover=e=>e.preventDefault();
  fCanvas.ondrop=e=>{
    e.preventDefault();if(!fDragId)return;
    const rect=fCanvas.getBoundingClientRect();
    let nx=(e.clientX-rect.left)/rect.width,ny=(e.clientY-rect.top)/rect.height;
    nx=Math.max(.52,Math.min(.97,nx));ny=Math.max(.05,Math.min(.95,ny));
    acct().field[fDragId]={x:nx,y:ny};fDragId=null;save();drawField();renderFieldSide();
  };
  fCanvas.onclick=e=>{
    const rect=fCanvas.getBoundingClientRect();
    const mx=(e.clientX-rect.left)/rect.width*fCanvas.width,my=(e.clientY-rect.top)/rect.height*fCanvas.height;
    for(const[rid,pos] of Object.entries(acct().field||{})){
      if(Math.hypot(mx-pos.x*fCanvas.width,my-pos.y*fCanvas.height)<16){delete acct().field[rid];save();drawField();renderFieldSide();return;}
    }
  };
  drawField();
}
function fDragStart(e,id){fDragId=id;}
function drawField(){
  const W=fCanvas.width,H=fCanvas.height,ctx=fCtx;
  const g=ctx.createLinearGradient(0,0,W,0);g.addColorStop(0,'#173321');g.addColorStop(.5,'#1e4a2e');g.addColorStop(1,'#173321');
  ctx.fillStyle=g;ctx.fillRect(0,0,W,H);
  for(let i=0;i<8;i++){ctx.fillStyle=i%2?'rgba(255,255,255,.03)':'rgba(0,0,0,.06)';ctx.fillRect(i*W/8,0,W/8,H);}
  ctx.strokeStyle='rgba(255,255,255,.45)';ctx.lineWidth=1.4;const p=14;
  ctx.strokeRect(p,p,W-p*2,H-p*2);ctx.beginPath();ctx.moveTo(W/2,p);ctx.lineTo(W/2,H-p);ctx.stroke();
  ctx.beginPath();ctx.arc(W/2,H/2,H*.18,0,Math.PI*2);ctx.stroke();
  const gw=7,gh=H*.22;
  [[p-gw,(H-gh)/2],[W-p,(H-gh)/2]].forEach(([gx,gy])=>{ctx.fillStyle='rgba(255,255,255,.08)';ctx.fillRect(gx,gy,gw,gh);ctx.strokeRect(gx,gy,gw,gh);});
  const paw=W*.13,pah=H*.5;ctx.strokeRect(p,(H-pah)/2,paw,pah);ctx.strokeRect(W-p-paw,(H-pah)/2,paw,pah);
  ctx.fillStyle='rgba(0,229,122,.07)';ctx.fillRect(W/2,p,W/2-p,H-p*2);
  ctx.font=`700 ${W*.01}px Syne`;ctx.fillStyle='rgba(0,229,122,.3)';ctx.textAlign='center';ctx.fillText('YOUR HALF',W*.76,H*.08);
  for(const[rid,pos] of Object.entries(acct().field||{})){
    const r=(acct().robots||[]).find(x=>x.id===rid);if(!r)continue;
    const px=pos.x*W,py=pos.y*H;
    ctx.beginPath();ctx.ellipse(px,py+13,11,5,0,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,.25)';ctx.fill();
    ctx.beginPath();ctx.arc(px,py,13,0,Math.PI*2);ctx.fillStyle=r.color+'cc';ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.5)';ctx.lineWidth=1.2;ctx.stroke();
    ctx.font='13px serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(r.emoji,px,py);
    ctx.font=`700 ${W*.009}px Syne`;ctx.fillStyle='rgba(255,255,255,.85)';ctx.textBaseline='top';ctx.fillText(r.name,px,py+15);
  }
}
function applyFormation(f){
  if(!(acct().robots||[]).length){toast('Add robots first','err');return;}
  const fm={'442':[[.76,.5],[.66,.22],[.66,.45],[.66,.6],[.66,.78],[.59,.28],[.59,.5],[.59,.66],[.55,.22],[.55,.5],[.55,.78]],'433':[[.76,.5],[.66,.18],[.66,.43],[.66,.58],[.66,.82],[.59,.28],[.59,.5],[.59,.72],[.54,.22],[.54,.5],[.54,.78]],'352':[[.76,.5],[.66,.22],[.66,.5],[.66,.78],[.59,.15],[.59,.35],[.59,.5],[.59,.65],[.59,.85],[.54,.33],[.54,.67]],'532':[[.76,.5],[.65,.12],[.65,.3],[.65,.5],[.65,.7],[.65,.88],[.58,.3],[.58,.5],[.58,.7],[.54,.33],[.54,.67]]};
  acct().field={};(acct().robots||[]).slice(0,11).forEach((r,i)=>{if(fm[f][i])acct().field[r.id]={x:fm[f][i][0],y:fm[f][i][1]};});
  save();if(fCanvas)drawField();renderFieldSide();toast(`Formation ${f} applied`);
}

// MATCH ENGINE
function pickVs(v){MS.vsMode=v;document.getElementById('vsAI').classList.toggle('on',v==='ai');document.getElementById('vsFriend').classList.toggle('on',v==='friend');document.getElementById('friendCodeRow').style.display=v==='friend'?'block':'none';}
function pickDur(d,btn){MS.duration=d;document.querySelectorAll('.dur-btn').forEach(b=>b.classList.remove('on'));btn.classList.add('on');}
function toggleSpeed(){MS.speed=MS.speed===1?3:1;document.getElementById('speedBtn').textContent=MS.speed===3?'üê¢ 1√ó Speed':'‚è© 3√ó Speed';}
function stopMatch(){endMatch();if(mRAF)cancelAnimationFrame(mRAF);document.getElementById('matchOverlay').style.display='flex';}

function kickOff(){
  const err=document.getElementById('moErr');err.textContent='';
  const robots=acct().robots||[];
  if(!robots.length){err.textContent='You need robots!';return;}
  if(!robots.some(r=>countChips(r.id)>0)){err.textContent='Program your robots first!';return;}
  let awayData;
  if(MS.vsMode==='friend'){
    const code=document.getElementById('friendCodeInp').value.trim();
    if(code.length<4){err.textContent='Enter a 4-char code';return;}
    const saved=localStorage.getItem('bf3_team_'+code);
    if(!saved){err.textContent='No team found for that code';return;}
    try{awayData=JSON.parse(saved);}catch(e){err.textContent='Invalid code';return;}
  }else{awayData=buildAITeam();}
  document.getElementById('matchOverlay').style.display='none';
  initMatch(robots,acct().programs||{},acct().field||{},acct().teamName||CUR,awayData);
}

function buildAITeam(){
  const mk=ids=>ids.map(id=>({type:'chip',id}));
  const aiR=[
    {id:'ai1',name:'HAL',emoji:'ü§ñ',color:'#ff3d5a',spd:7,str:7,int:7},
    {id:'ai2',name:'SWIFT',emoji:'‚ö°',color:'#ff3d5a',spd:10,str:5,int:6},
    {id:'ai3',name:'BRUT',emoji:'ü¶æ',color:'#ff3d5a',spd:5,str:10,int:5},
    {id:'ai4',name:'SAGE',emoji:'üß†',color:'#ff3d5a',spd:6,str:6,int:10},
    {id:'ai5',name:'UNIT',emoji:'‚öôÔ∏è',color:'#ff3d5a',spd:8,str:6,int:7},
  ];
  const progs={
    ai1:[{type:'if',cond:'winning',then:mk(['d03','p03']),else:mk(['m08','a01'])},{type:'chip',id:'d01'}],
    ai2:mk(['m08','a02','s04','a13']),
    ai3:[{type:'if',cond:'possession',then:mk(['d01','d02']),else:mk(['d09','d12'])}],
    ai4:[{type:'if',cond:'losing',then:mk(['s05','a01']),else:mk(['m03','p06'])}],
    ai5:mk(['p01','m05','a08','a10']),
  };
  const field={ai1:{x:.24,y:.5},ai2:{x:.35,y:.3},ai3:{x:.35,y:.7},ai4:{x:.43,y:.2},ai5:{x:.43,y:.8}};
  return{name:'Bot FC',robots:aiR,programs:progs,field};
}

function rnd(r){return(Math.random()-.5)*r*2;}

function initMatch(homeRobots,homeProgs,homeField,homeName,away){
  mCanvas=document.getElementById('matchCanvas');
  const wrap=document.getElementById('matchCanvasWrap');
  mCanvas.width=wrap.clientWidth;mCanvas.height=wrap.clientHeight;
  mCtx=mCanvas.getContext('2d');
  document.getElementById('hudH').textContent=homeName||'Home';
  document.getElementById('hudA').textContent=away.name||'Away';
  document.getElementById('hudSH').textContent='0';document.getElementById('hudSA').textContent='0';
  document.getElementById('matchLog').innerHTML='';

  const mkP=(robots,progs,field,team,flip)=>robots.slice(0,11).map((r,i)=>{
    const pos=field[r.id]?{x:field[r.id].x,y:field[r.id].y}:{x:.7+rnd(.08),y:.2+i*.13};
    if(flip)pos.x=1-pos.x;
    return{id:r.id,team,robot:r,prog:buildFlatProg(progs[r.id]||[]),progIdx:0,
      rx:pos.x,ry:pos.y,tx:pos.x,ty:pos.y,baseX:pos.x,baseY:pos.y,
      trail:[],execTimer:Math.floor(Math.random()*80)};
  });

  MG={
    tick:0,maxTick:Math.floor(MS.duration*3.5),
    homeScore:0,awayScore:0,possession:'home',
    ball:{rx:.5,ry:.5,vx:.002,vy:.001,trail:[]},
    players:[...mkP(homeRobots,homeProgs,homeField,'home',false),...mkP(away.robots,away.programs||{},away.field||{},'away',true)],
    homeName,awayName:away.name,
    particles:[],phase:'playing',pendingLog:[],logFlush:0,
    period:1,periodScores:{home:0,away:0},
  };

  MS.running=true;
  addLog('‚öΩ Kick off!','info');
  let lastT=0;
  function loop(ts){
    if(!MS.running)return;
    const dt=Math.min(ts-lastT,50);lastT=ts;
    const steps=MS.speed===3?3:1;
    for(let s=0;s<steps;s++)tickMatch();
    drawMatch();
    mRAF=requestAnimationFrame(loop);
  }
  mRAF=requestAnimationFrame(loop);
}

function buildFlatProg(seq){
  const flat=[];
  seq.forEach(item=>{
    if(item.type==='chip')flat.push(item.id);
    else if(item.type==='if')flat.push(item);
  });
  return flat;
}

function resolveChip(player){
  if(!player.prog.length)return CHIPS[0];
  for(let tries=0;tries<player.prog.length*2+2;tries++){
    const item=player.prog[player.progIdx%Math.max(1,player.prog.length)];
    player.progIdx++;
    if(typeof item==='string')return CHIPS.find(c=>c.id===item)||CHIPS[0];
    if(item&&(item.type==='if'||item.then)){
      const branch=evalCond(item.cond||'random',player)?item.then:item.else||[];
      const flat=buildFlatProg(branch);
      if(flat.length){
        const cid=flat[0];
        if(typeof cid==='string'){
          const chip=CHIPS.find(c=>c.id===cid)||CHIPS[0];
          const condL=IF_CONDS.find(x=>x.id===(item.cond||'random'))?.l||item.cond;
          addLog(`üîÄ IF ${condL} ‚Üí ${chip.icon} ${chip.name}`,'if');
          return chip;
        }
      }
    }
  }
  return CHIPS[0];
}

function evalCond(cond,player){
  const hs=MG.homeScore,as=MG.awayScore;
  const isHome=player.team==='home';
  const myS=isHome?hs:as,oppS=isHome?as:hs;
  const pct=MG.tick/MG.maxTick,r=player.robot;
  switch(cond){
    case 'winning': return myS>oppS;
    case 'losing':  return myS<oppS;
    case 'drawing': return myS===oppS;
    case 'possession': return MG.possession===player.team;
    case 'no_poss': return MG.possession!==player.team;
    case 'early':   return pct<.5;
    case 'late':    return pct>=.5;
    case 'close':   return Math.abs(hs-as)<=1;
    case 'high_spd':return (r.spd||5)>7;
    case 'high_str':return (r.str||5)>7;
    case 'high_int':return (r.int||5)>7;
    case 'random':  return Math.random()<.5;
    default:        return true;
  }
}

function tickMatch(){
  if(MG.phase==='ended')return;
  MG.tick++;

  // Execute chips
  MG.players.forEach(p=>{
    p.execTimer--;
    if(p.execTimer<=0){
      p.execTimer=Math.max(30,100-((p.robot.spd||5)*5))+Math.floor(Math.random()*25);
      execChip(p);
    }
    // SMOOTH TWEEN ‚Äî lerp toward target each tick
    const lerpSpd=0.07+((p.robot.spd||5)/10)*0.07;
    p.rx+=(p.tx-p.rx)*lerpSpd;
    p.ry+=(p.ty-p.ry)*lerpSpd;
    // Trail
    p.trail.push({x:p.rx,y:p.ry});
    if(p.trail.length>8)p.trail.shift();
  });

  // Ball physics ‚Äî smooth continuous movement
  const B=MG.ball;
  B.rx+=B.vx;B.ry+=B.vy;
  B.vx*=.97;B.vy*=.975;
  if(B.ry<.03||B.ry>.97){B.vy*=-.8;B.ry=B.ry<.03?.03:.97;}
  B.rx=Math.max(.01,Math.min(.99,B.rx));
  B.trail.push({x:B.rx,y:B.ry});if(B.trail.length>10)B.trail.shift();

  // Goal detection
  if(B.rx<.022&&B.ry>.39&&B.ry<.61){MG.awayScore++;document.getElementById('hudSA').textContent=MG.awayScore;onGoal('away');}
  else if(B.rx>.978&&B.ry>.39&&B.ry<.61){MG.homeScore++;document.getElementById('hudSH').textContent=MG.homeScore;onGoal('home');}

  // Particles
  MG.particles=MG.particles.filter(p=>{p.life--;p.x+=p.vx;p.y+=p.vy;p.vy+=.0006;return p.life>0;});

  // HUD
  document.getElementById('hudPH').textContent=MG.possession==='home'?'‚óè possession':'';
  document.getElementById('hudPA').textContent=MG.possession==='away'?'possession ‚óè':'';
  const periodMin=Math.round((MG.tick/MG.maxTick)*90);
  document.getElementById('hudTime').innerHTML=`${periodMin}' &nbsp;P${MG.period} &nbsp;<span class="live-dot">üî¥</span> LIVE`;

  // Flush log
  MG.logFlush++;
  if(MG.logFlush%3===0&&MG.pendingLog.length){
    const el=document.getElementById('matchLog');
    MG.pendingLog.splice(0,5).forEach(({msg,type})=>{
      const d=document.createElement('div');d.className=`le le-${type}`;d.textContent=msg;
      el.insertBefore(d,el.firstChild);if(el.children.length>100)el.removeChild(el.lastChild);
    });
    MG.pendingLog=[];
  }

  if(MG.tick>=MG.maxTick)endPeriod();
}

function execChip(player){
  const chip=resolveChip(player);
  const isBall=MG.possession===player.team;
  const B=MG.ball,r=player.robot;
  const pow=(chip.pow||0)+(chip.spd||0)+(chip.def||0);
  const stat=(r.spd+r.str+r.int)/30;
  const roll=Math.random();
  const successP=.22+stat*.28+(pow/50)*.25;

  if(chip.cat==='move'){
    if(isBall){
      const dir=player.team==='home'?-1:1;
      B.vx+=dir*(.003+chip.spd*.0008)*(roll+.3);B.vy+=rnd(.004);
      player.tx=Math.max(.02,Math.min(.98,B.rx+dir*.08+rnd(.06)));player.ty=Math.max(.02,Math.min(.98,B.ry+rnd(.07)));
    }else{player.tx=player.baseX+rnd(.06);player.ty=player.baseY+rnd(.06);}
    if(roll<.12)addLog(`${chip.icon} ${r.emoji} ${chip.name}`,'chip');
  }else if(chip.cat==='attack'){
    if(isBall&&roll<successP){
      const dir=player.team==='home'?-1:1;
      B.vx+=dir*(.006+chip.pow*.0018);B.vy=(.5+rnd(.06)-B.ry)*.06;
      player.tx=Math.max(.02,Math.min(.98,B.rx+dir*.05));player.ty=Math.max(.02,Math.min(.98,B.ry+rnd(.04)));
      if(roll<.3)addLog(`${chip.icon} ${r.emoji} ${chip.name}!`,'action');
    }else if(!isBall&&roll<.09){MG.possession=player.team;B.vx*=-.4;B.vy*=-.3;addLog(`${chip.icon} ${r.emoji} wins it back!`,'action');}
  }else if(chip.cat==='defend'){
    const dist=Math.hypot(player.rx-B.rx,player.ry-B.ry);
    if(!isBall&&roll<successP*.9&&dist<.2){MG.possession=player.team;B.vx*=-.5;B.vy+=rnd(.003);addLog(`${chip.icon} ${r.emoji} ${chip.name} ‚Äî STEAL!`,'action');}
    else{player.tx=B.rx+rnd(.1);player.ty=B.ry+rnd(.08);}
  }else if(chip.cat==='special'){
    if(isBall&&roll<successP*.9){const dir=player.team==='home'?-1:1;B.vx+=dir*(.01+chip.pow*.0022);B.vy=(.5+rnd(.04)-B.ry)*.08;if(roll<.4)addLog(`${chip.icon} ${r.emoji} ${chip.name}!!`,'action');}
  }else{
    if(isBall&&roll<successP*.7){B.vx+=(player.team==='home'?-1:1)*chip.spd*.0008;B.vy+=rnd(.002);}
    player.tx=player.baseX+rnd(.08);player.ty=player.baseY+rnd(.08);
  }
  if(Math.random()<.05)MG.possession=MG.possession==='home'?'away':'home';
}

function addLog(msg,type){
  if(type==='info'||type==='goal'){
    const el=document.getElementById('matchLog');
    const d=document.createElement('div');d.className=`le le-${type}`;d.textContent=msg;
    el.insertBefore(d,el.firstChild);return;
  }
  if(!MG.pendingLog)MG.pendingLog=[];MG.pendingLog.push({msg,type});
}

function onGoal(team){
  const scorer=MG.players.filter(p=>p.team===team).sort((a,b)=>Math.hypot(a.rx-MG.ball.rx,a.ry-MG.ball.ry)-Math.hypot(b.rx-MG.ball.rx,b.ry-MG.ball.ry))[0];
  const sn=scorer?scorer.robot.emoji+' '+scorer.robot.name:'';
  addLog(`‚öΩ GOAL! ${sn} ‚Äî ${team==='home'?MG.homeName:MG.awayName} scores!`,'goal');
  if(team==='home')MG.periodScores.home++;else MG.periodScores.away++;
  spawnParticles();
  MG.ball={rx:.5,ry:.5,vx:rnd(.003),vy:rnd(.002),trail:[]};
  MG.players.forEach(p=>{p.rx=p.baseX+rnd(.04);p.ry=p.baseY+rnd(.04);p.tx=p.rx;p.ty=p.ry;p.trail=[];});
  MG.possession=team==='home'?'away':'home';
}
function spawnParticles(){
  for(let i=0;i<55;i++){const a=Math.random()*Math.PI*2,s=.003+Math.random()*.012;MG.particles.push({x:.5,y:.5,vx:Math.cos(a)*s,vy:Math.sin(a)*s-.004,life:60+Math.random()*40,maxLife:100,color:`hsl(${Math.random()*60+20},100%,60%)`});}
}
function endPeriod(){
  const h=MG.homeScore,a=MG.awayScore;
  const pLabel=['','1ST','2ND','3RD','4TH','5TH','6TH','7TH','8TH'];
  addLog(`‚è∏ END OF PERIOD ${MG.period} ‚Äî ${MG.homeName} ${h} : ${a} ${MG.awayName}`,'info');

  // Update record every 2 periods (= 1 full match)
  if(MG.period%2===0){
    const rh=MG.periodScores.home,ra=MG.periodScores.away;
    let res,type;
    if(rh>ra){res=`üèÜ ${MG.homeName} WIN period pair! ${rh}‚Äì${ra}`;type='goal';acct().record.w++;}
    else if(ra>rh){res=`${MG.awayName} WIN period pair! ${ra}‚Äì${rh}`;type='action';acct().record.l++;}
    else{res=`DRAW ${rh}‚Äì${ra}`;type='info';acct().record.d++;}
    addLog(res,type);updateRec();save();
    MG.periodScores={home:0,away:0};
  }

  // Kick off next period ‚Äî match NEVER stops
  MG.period++;
  MG.tick=0;
  // Reset ball and positions for new period kickoff
  MG.ball={rx:.5,ry:.5,vx:rnd(.003),vy:rnd(.002),trail:[]};
  MG.players.forEach(p=>{
    p.rx=p.baseX+rnd(.05);p.ry=p.baseY+rnd(.05);
    p.tx=p.rx;p.ty=p.ry;p.trail=[];
    p.execTimer=Math.floor(Math.random()*60);
  });
  MG.possession=MG.period%2===0?'away':'home';
  addLog(`‚ñ∂ PERIOD ${MG.period} KICKS OFF ‚Äî ${pLabel[Math.min(MG.period,8)] || MG.period+'TH'} PERIOD`,'info');
  document.getElementById('hudSH').textContent=MG.homeScore;
  document.getElementById('hudSA').textContent=MG.awayScore;
}

function endMatch(){
  // Only called by manual stop button
  MS.running=false;MG.phase='ended';
  const h=MG.homeScore,a=MG.awayScore;
  let res,type;
  if(h>a){res=`üèÜ ${MG.homeName} WIN! ${h}‚Äì${a}`;type='goal';acct().record.w++;}
  else if(a>h){res=`${MG.awayName} WIN ${a}‚Äì${h}`;type='action';acct().record.l++;}
  else{res=`DRAW ${h}‚Äì${h}`;type='info';acct().record.d++;}
  addLog(`STOPPED ‚Äî ${res}`,type);document.getElementById('hudTime').textContent=`STOPPED ¬∑ ${h}:${a}`;
  updateRec();save();
}

function drawMatch(){
  if(!mCanvas||!mCtx)return;
  const W=mCanvas.width,H=mCanvas.height,ctx=mCtx;
  const tx=v=>v*W,ty=v=>v*H;
  const g=ctx.createLinearGradient(0,0,W,0);g.addColorStop(0,'#152a1c');g.addColorStop(.5,'#1a3823');g.addColorStop(1,'#152a1c');
  ctx.fillStyle=g;ctx.fillRect(0,0,W,H);
  for(let i=0;i<10;i++){ctx.fillStyle=i%2?'rgba(255,255,255,.025)':'rgba(0,0,0,.04)';ctx.fillRect(i*W/10,0,W/10,H);}
  ctx.strokeStyle='rgba(255,255,255,.4)';ctx.lineWidth=1.5;const p=12;
  ctx.strokeRect(p,p,W-p*2,H-p*2);
  ctx.beginPath();ctx.moveTo(W/2,p);ctx.lineTo(W/2,H-p);ctx.stroke();
  ctx.beginPath();ctx.arc(W/2,H/2,H*.18,0,Math.PI*2);ctx.stroke();
  ctx.beginPath();ctx.arc(W/2,H/2,3,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.4)';ctx.fill();
  const gw=10,gh=H*.24;
  ctx.fillStyle='rgba(0,229,122,.1)';ctx.fillRect(p-gw,(H-gh)/2,gw,gh);ctx.strokeStyle='rgba(0,229,122,.4)';ctx.strokeRect(p-gw,(H-gh)/2,gw,gh);
  ctx.fillStyle='rgba(255,61,90,.1)';ctx.fillRect(W-p,(H-gh)/2,gw,gh);ctx.strokeStyle='rgba(255,61,90,.4)';ctx.strokeRect(W-p,(H-gh)/2,gw,gh);
  const paw=W*.13,pah=H*.5;ctx.strokeStyle='rgba(255,255,255,.3)';ctx.strokeRect(p,(H-pah)/2,paw,pah);ctx.strokeRect(W-p-paw,(H-pah)/2,paw,pah);

  // Ball trail
  MG.ball.trail.forEach((pt,i)=>{const a=i/MG.ball.trail.length;ctx.beginPath();ctx.arc(tx(pt.x),ty(pt.y),4*a,0,Math.PI*2);ctx.fillStyle=`rgba(255,255,255,${a*.22})`;ctx.fill();});

  // Player trails (motion blur effect)
  MG.players.forEach(pl=>{
    if(pl.trail.length<2)return;
    ctx.beginPath();ctx.moveTo(tx(pl.trail[0].x),ty(pl.trail[0].y));
    pl.trail.forEach(t=>ctx.lineTo(tx(t.x),ty(t.y)));
    ctx.strokeStyle=pl.robot.color+'28';ctx.lineWidth=3;ctx.stroke();
  });

  // Players
  MG.players.forEach(pl=>{
    const px=tx(pl.rx),py=ty(pl.ry);
    const hasBall=Math.hypot(pl.rx-MG.ball.rx,pl.ry-MG.ball.ry)<.07;
    // Shadow
    ctx.beginPath();ctx.ellipse(px,py+12,11,5,0,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,.3)';ctx.fill();
    // Glow if has ball
    if(hasBall){ctx.beginPath();ctx.arc(px,py,19,0,Math.PI*2);ctx.fillStyle=pl.robot.color+'18';ctx.fill();}
    // Body
    ctx.beginPath();ctx.arc(px,py,12,0,Math.PI*2);ctx.fillStyle=pl.robot.color+'ee';ctx.fill();
    ctx.strokeStyle=hasBall?'#f5c400':'rgba(255,255,255,.35)';ctx.lineWidth=hasBall?2.5:1;ctx.stroke();
    // Emoji
    ctx.font='11px serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(pl.robot.emoji,px,py);
    // Name tag
    if(hasBall){
      const nw=pl.robot.name.length*5.5+10;
      ctx.fillStyle='rgba(0,0,0,.7)';ctx.beginPath();
      if(ctx.roundRect)ctx.roundRect(px-nw/2,py-28,nw,14,4);else ctx.rect(px-nw/2,py-28,nw,14);
      ctx.fill();
      ctx.font='bold 8.5px Syne';ctx.fillStyle='#f5c400';ctx.textBaseline='top';ctx.fillText(pl.robot.name,px,py-26);
    }
  });

  // Ball
  const bx=tx(MG.ball.rx),by=ty(MG.ball.ry);
  const bg=ctx.createRadialGradient(bx-2,by-2,1,bx,by,7);bg.addColorStop(0,'#fff');bg.addColorStop(1,'#ddd');
  ctx.beginPath();ctx.arc(bx,by,7,0,Math.PI*2);ctx.fillStyle=bg;ctx.fill();ctx.strokeStyle='#333';ctx.lineWidth=1;ctx.stroke();
  [[0,-.45],[.38,.22],[-.38,.22]].forEach(([dx,dy])=>{ctx.beginPath();ctx.arc(bx+dx*6.5,by+dy*6.5,2,0,Math.PI*2);ctx.fillStyle='#444';ctx.fill();});

  // Goal particles
  MG.particles.forEach(pp=>{
    const a=pp.life/pp.maxLife;
    ctx.beginPath();ctx.arc(tx(pp.x),ty(pp.y),3.5*a,0,Math.PI*2);
    ctx.fillStyle=pp.color.replace('hsl','hsla').replace(')',`,${a})`);ctx.fill();
  });

  // Possession bar
  ctx.fillStyle='rgba(0,0,0,.5)';ctx.fillRect(W/2-55,H-18,110,7);
  const pct=MG.possession==='home'?62:48;
  ctx.fillStyle='rgba(0,229,122,.65)';ctx.fillRect(W/2-55,H-18,pct,7);
  ctx.fillStyle='rgba(255,61,90,.65)';ctx.fillRect(W/2-55+pct,H-18,110-pct,7);
}

// ONLINE
function renderOnline(){
  if(!CUR)return;
  document.getElementById('myCodeDisplay').textContent=acct().code||'----';
  document.getElementById('oRecW').textContent=acct().record.w;
  document.getElementById('oRecD').textContent=acct().record.d;
  document.getElementById('oRecL').textContent=acct().record.l;
}
function genCode(){
  const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let code='';for(let i=0;i<4;i++)code+=c[Math.floor(Math.random()*c.length)];
  acct().code=code;
  localStorage.setItem('bf3_team_'+code,JSON.stringify({name:acct().teamName||CUR,robots:acct().robots,programs:acct().programs,field:acct().field}));
  save();renderOnline();toast('Code generated!');
}
function copyCode(){const code=acct().code;if(!code){toast('Generate a code first','err');return;}navigator.clipboard.writeText(code).then(()=>toast('Copied!'));}
function loadChallenge(){
  const code=document.getElementById('challengeInp').value.trim();
  if(code.length<4){toast('Enter a 4-char code','err');return;}
  const saved=localStorage.getItem('bf3_team_'+code);
  if(!saved){toast('No team found for that code','err');return;}
  document.getElementById('friendCodeInp').value=code;pickVs('friend');
  goScreen('match');document.querySelectorAll('.nav-btn').forEach(b=>b.classList.toggle('active',b.textContent.includes('Match')));
  toast('Code loaded ‚Äî hit Kick Off!');
}

// RECORD
function updateRec(){
  if(!CUR)return;const r=acct().record||{w:0,d:0,l:0};
  document.getElementById('recW').textContent='W '+r.w;document.getElementById('recD').textContent='D '+r.d;document.getElementById('recL').textContent='L '+r.l;
  document.getElementById('oRecW').textContent=r.w;document.getElementById('oRecD').textContent=r.d;document.getElementById('oRecL').textContent=r.l;
}

// INIT
loadSt();renderAuthForm();
if(CUR&&ACCOUNTS[CUR]){document.getElementById('authScreen').style.display='none';enterApp();}
</script>
</body>
</html>
